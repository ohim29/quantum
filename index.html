<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" name="viewport"/>
<meta content="dark light" name="color-scheme"/>
<meta content="#0f172a" name="theme-color"/>
<link href="./manifest.json" rel="manifest"/>
<title>Crypto Run Tracker — Binance Futures</title>
<script src="https://cdn.tailwindcss.com"></script>
<link crossorigin="" href="https://s3.tradingview.com" rel="preconnect"/>
<link crossorigin="" href="https://fapi.binance.com" rel="preconnect"/>
<link crossorigin="" href="https://fstream.binance.com" rel="preconnect"/>
<style>
/* Compact OI timeframe buttons (same style, tighter spacing) */
.oi-periods{ display:flex; gap:4px; align-items:center; flex-wrap:nowrap; white-space:nowrap; }
.tools-btn.oi-mini{ padding:.15rem .4rem; font-size:.8rem; line-height:1; min-height:0; border-radius:.4rem; }
@media (max-width: 480px){
  .tools-btn.oi-mini{ padding:.12rem .35rem; font-size:.75rem; }
}

w2px; overflow-y:auto;}

      :root{--bg:#0f172a;--pane:#1f2937;--br:#334155;}
      body{background:radial-gradient(100% 100% at 50% 0%, #1e1b4b 0%, #0f172a 60%, #0f172a 100%);color:#e5e7eb}
      .card{background:rgba(30,41,59,.5);backdrop-filter:blur(6px);border:1px solid #334155;border-radius:1rem}
      .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.55rem 1rem;border-radius:.8rem;border:1px solid #475569;background:rgba(51,65,85,.5);min-height:44px}
      .btn:hover{background:rgba(51,65,85,.8)}
      .pill{padding:.15rem .5rem;border-radius:.5rem;border:1px solid #475569}
      .scroll-area{scrollbar-width:thin;scrollbar-color:#475569 transparent}
      .scroll-area::-webkit-scrollbar{width:8px}.scroll-area::-webkit-scrollbar-thumb{background:#475569;border-radius:8px}
      #tv-container{width:100%;height:560px}@media(max-width:1024px){#tv-container{height:440px}}@media(max-width:640px){#tv-container{height:380px}}
      .tools-btn{font-size:.95rem;padding:.45rem .8rem;border-radius:.6rem;border:1px solid #475569;background:rgba(51,65,85,.5)}
      .tools-btn.active{border-color:#7c3aed;background:rgba(124,58,237,.18)}
          .bar{height:10px;background:rgba(148,163,184,.25);border-radius:4px;overflow:hidden}
      .bar>div{height:100%;background:rgba(124,58,237,.7)}
      td .bar{max-width:100%;}
          .col-right{display:flex;flex-direction:column}
      .col-right>.card:last-child{flex:1;display:flex;flex-direction:column}
      .col-right>.card:last-child>#toolsContent{flex:1;}
    
  /* === Binance Spot sticky panel === */
  .spot-ticker-panel {
    position: fixed;
    top: 16px;
    right: 16px;
    width: clamp(280px, 30vw, 360px);
    max-height: calc(100dvh - 32px);
    display: flex;
    flex-direction: column;
    background: #0b1116;
    color: #e6edf3;
    border: 1px solid #24303a;
    border-radius: 12px;
    box-shadow: 0 15px 40px rgba(0,0,0,.4);
    overflow: hidden;
    transform: translateX(110%);
    opacity: 0;
    pointer-events: none;
    transition: transform .28s cubic-bezier(.2,.8,.2,1), opacity .2s ease;
    z-index: 9999;
  }
  .spot-ticker-panel.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
  .spot-ticker-header {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 10px 12px; background: linear-gradient(180deg, #111a21, #0b1116); border-bottom: 1px solid #24303a;
  }
  .spot-ticker-title { display: flex; flex-direction: column; line-height: 1.15; }
  .spot-ticker-title b { font-size: 14px; letter-spacing: .2px; }
  .spot-ticker-title small { opacity: .7; font-size: 12px; }
  .spot-ticker-close {
    appearance: none; border: none; background: transparent; color: #93a1ad;
    width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: grid; place-items: center;
    font-size: 18px; line-height: 1;
  }
  .spot-ticker-close:hover { background: #0f1720; color: #d7dee6; }
  .spot-ticker-list { overflow: auto; overscroll-behavior: contain; scrollbar-width: thin; scrollbar-color: #2a3945 #0b1116; max-height: calc(100dvh - 56px); }
  .spot-ticker-list ul { list-style: none; margin: 0; padding: 0; }
  .spot-ticker-row {
    display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
    padding: 10px 12px; border-bottom: 1px dashed #1e2933;
  }
  .spot-ticker-row:hover { background: rgba(255,255,255,.02); }
  .sym { font-weight: 600; letter-spacing: .3px; font-variant-numeric: tabular-nums; }
  .pct { font-variant-numeric: tabular-nums; font-weight: 700; }
  .pct.up { color: #00c853; } .pct.down { color: #ff5252; }
  .muted { opacity: .65; }
  .spot-ticker-footer { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 8px 12px;
    border-top: 1px solid #24303a; font-size: 12px; color: #93a1ad; background: #0b1116; }
  .link { color: inherit; text-decoration: underline; text-decoration-color: rgba(255,255,255,.25); }

</style>
<style id="anom-neutral-override">
#anomListWrap table tbody tr { background: transparent !important; }
#anomListWrap .text-green, #anomListWrap .text-red,
#anomListWrap .text-green-400, #anomListWrap .text-red-400,
#anomListWrap .text-green-500, #anomListWrap .text-red-500,
#anomListWrap .text-green-600, #anomListWrap .text-red-600 {
  color: #cbd5e1 !important;
}
</style>
<style>z8px;overflow-y:auto;}</style>
<style id="agent-search-white">
#agentSearchInput {
  color: #fff !important;
}
</style>
<style id="agent-auto-css">
:root{
  --violet-bg: #7c3aed;        /* violet-600 */
  --violet-border: #a78bfa;    /* violet-300 */
  --violet-glow: rgba(139,92,246,0.55); /* violet glow */
}
.agent-auto-group { display:inline-flex; gap:4px; align-items:center; margin-left:6px; }
.agent-auto-btn {
  min-width:36px; height:22px; padding:0 8px; font-size:11px; line-height:20px;
  border-radius:6px; border:1px solid var(--violet-border);
  background: rgba(0,0,0,0.25);
  color:#d1d5db;
  box-shadow: 0 0 8px var(--violet-glow), inset 0 0 3px var(--violet-glow);
  transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, color .12s ease, opacity .12s ease;
}
.agent-auto-btn:hover { transform: translateY(-0.5px); }
.agent-auto-btn.active {
  background: var(--violet-bg);
  border-color: var(--violet-border);
  color:#fff;
  box-shadow: none;
  opacity: 1;
}
.agent-auto-stop { min-width:22px; height:22px; padding:0; font-size:12px; line-height:20px; }

/* Keep the agent panel always open and stable */
#agentAdvice.agent-sticky-open, .agent-sticky-open { will-change: contents; }
.agent-sticky-open .agent-ticker, 
.agent-sticky-open #agentTicker, 
.agent-sticky-open [data-field="symbol"] { transition: none !important; }

/* Flash animations for numbers only */
@keyframes flashGreen { 0%{color:#22c55e;} 100%{color:inherit;} }
@keyframes flashRed   { 0%{color:#ef4444;} 100%{color:inherit;} }
.flash-green { animation: flashGreen .4s ease; }
.flash-red   { animation: flashRed .4s ease; }

@media (max-width: 640px){
  .agent-auto-btn { min-width:32px; height:20px; font-size:10px; line-height:18px; border-radius:5px; }
  .agent-auto-stop{ min-width:20px; height:20px; font-size:11px; line-height:18px; }
}
</style>
<style>#agentAutoBtn{display:none !important;}</style>

<style>
  /* spreads-autowide-theme */
  #spreads-panel{ background:#0b1116; color:#e6edf3; border-color:#24303a; max-width:96vw; width:auto; }
  #spreads-list{ max-height: calc(100dvh - 160px); overflow-y:auto; overflow-x:hidden; }
  #spreads-table{ table-layout:auto; width:100%; font-size:13px; background:transparent; }
  #spreads-table th, #spreads-table td{ padding:8px 10px; white-space:nowrap; border-bottom:1px solid #24303a; }
  #spreads-table thead th{ position:sticky; top:0; background:#0b1116; }
</style>

<style id="popup-blue-theme">
.spot-ticker-panel,
#natr-card {
  background: linear-gradient(90deg, #0b1022 0%, #12173a 100%) !important;
  border: 1px solid #1b2244 !important;
  color: #e7eaf1;
  box-shadow: 0 12px 30px rgba(0,0,0,0.45);
}
.spot-ticker-header,
#natr-head {
  background: rgba(255,255,255,0.02) !important;
  border-bottom: 1px solid #1b2244 !important;
}
.spot-ticker-panel table,
.spot-ticker-panel .list,
#natr-table {
  background: transparent !important;
}
.spot-ticker-panel .muted { color: #9aa4b2; }
.spot-close-btn { background:#1a203b; border:1px solid #26305a; color:#e7eaf1; }
</style>

<style id="mobile-ribbon-css">
/* ===== Mobile ribbon (≤ 767px): кнопки, Пары, WS в одной полосе под ВХОД ===== */
@media (max-width: 767px){
  #mobileRibbon{
    display:flex; align-items:center; gap:8px;
    overflow-x:auto; overscroll-behavior:contain;
    padding:8px 10px; margin-top:8px;
    border:1px solid #475569; border-radius:12px;
    background: rgba(51,65,85,.35);
  }
  #mobileRibbon .tools-btn{ flex:0 0 auto; min-height:32px; }
  #mobileRibbon .pill, #mobileRibbon .ws-pill{
    flex:0 0 auto; font-size:12px; padding:4px 10px; border-radius:999px;
    border:1px solid #334155; background:rgba(15,23,42,.35);
  }
  /* Спрячем старую подсказку WS под лентой */
  #statusBar{ display:none !important; }
}
/* ===== Спреды: на мобилке — по всей ширине, чтобы было видно все столбцы (включая %) ===== */
@media (max-width: 767px){
  #spreads-panel{
    width:100vw !important; max-width:100vw !important;
    border-radius:0 !important; left:0; right:0;
  }
  #spreads-list{ max-height:calc(100dvh - 120px); }
  #spreads-table{ table-layout:auto !important; font-size:12px; }
}
</style>

<style id="mobile-natr-spreads-tweaks">
/* ===== NATR popup: stack controls vertically on mobile for compact UX ===== */
@media (max-width: 767px){
  #natr-card .btn, #natr-card button{
    display:block; width:100%; margin:6px 0 !important; min-height:36px;
    justify-content:center;
  }
  #natr-card .pill, #natr-head .pill{
    display:block; width:100%; margin:6px 0 !important; text-align:center;
  }
  #natr-card .controls, #natr-card .toolbar, #natr-card .header, #natr-head{
    display:block !important;
  }
}

/* ===== Spreads table: pack columns tighter on mobile so 100% fits, including % ===== */
@media (max-width: 767px){
  #spreads-table{ font-size:11px !important; }
  #spreads-table th, #spreads-table td{
    padding:6px 6px !important; white-space:nowrap;
  }
  #spreads-table thead th{ position:sticky; top:0; }
}
</style>

<!-- Open Graph & Twitter preview -->
<meta property="og:title" content="CryptoRun">
<meta property="og:description" content="Трекер фьючерсов, спотов и объёмов в реальном времени">
<meta property="og:image" content="/img/cryptorun-preview.png">
<meta property="og:url" content="/">
<meta property="og:type" content="website">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="CryptoRun">
<meta name="twitter:description" content="Трекер фьючерсов, спотов и объёмов в реальном времени">
<meta name="twitter:image" content="/img/cryptorun-preview.png">

<!-- Favicon / App icons -->
<link rel="icon" href="/img/cryptorun-preview.png" type="image/png">
<link rel="apple-touch-icon" href="/img/cryptorun-preview.png">

<!-- PWA manifest -->
<link rel="manifest" href="/manifest.json">

<style id="mobile-spreads-pack-tight">
@media (max-width: 767px){
  #spreads-panel{ width:100vw !important; max-width:100vw !important; border-radius:0 !important; }
  #spreads-table{ 
    font-size:10.5px !important; 
    border-collapse:collapse !important;
    table-layout:auto !important;
  }
  #spreads-table th, #spreads-table td{
    padding:4px 6px !important;
    white-space:nowrap !important;
  }
  #spreads-table td, #spreads-table th{
    font-variant-numeric: tabular-nums;
    letter-spacing:0;
  }
}
</style>

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<style id="mobile-spreads-vertical-sep">
@media (max-width: 767px){
  #spreads-panel{ width:100vw !important; max-width:100vw !important; border-radius:0 !important; }
  #spreads-table{
    width:100% !important;
    table-layout:fixed !important;
    border-collapse:collapse !important;
    border-spacing:0 !important;
    font-size:10.5px !important;
  }
  #spreads-table th, #spreads-table td{
    padding:3px 3px !important;
    white-space:nowrap !important;
    border-left:1px solid #24303a !important; /* вертикальные разделители */
  }
  #spreads-table th:first-child, #spreads-table td:first-child{ border-left:none !important; }
  #spreads-table tr{ border-bottom:none !important; } /* без горизонтальных линий */
  #spreads-table thead th{ border-bottom:2px solid #334155 !important; }
}
</style>

<style id="topbar-mobile-wrap">
@media (max-width: 767px){
  /* the block that contains the small oi-mini buttons already has flex-wrap in markup; ensure wrapping and tidy grid spacing */
  .card .flex .flex-wrap, .card .flex.flex-wrap, .card .flex .items-center.flex-wrap{
    row-gap: 8px !important;
  }
  /* ensure each small button is uniform width so rows look tidy */
  .tools-btn.oi-mini{
    min-width: calc(50% - 6px); /* 2 per row visually on small screens */
    text-align: center;
  }
  /* keep the pairs/WS pills on the same ribbon area */
  #statusBar{ margin-top: 6px; }
}
</style>


<style id="mobile-topbar-tidy">
@media (max-width: 767px){
  /* Try common containers for the top button strip */
  .topbar, .top-buttons, .tools-top, .btn-strip, .card > .flex:first-child {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    align-items: stretch !important;
  }
  /* Make buttons wrap nicely into two rows */
  .topbar .tools-btn, .top-buttons .tools-btn, .tools-top .tools-btn, .btn-strip .tools-btn, .card > .flex:first-child .tools-btn {
    flex: 1 1 calc(50% - 8px) !important;
    text-align: center !important;
  }
  /* Avoid horizontal scroll */
  .topbar, .top-buttons, .tools-top, .btn-strip, .card > .flex:first-child { overflow: visible !important; }
}
</style>


<style id="mobile-topbar-2rows">
@media (max-width: 767px){
  .topbar, .top-buttons, .tools-top, .btn-strip, .card > .flex:first-child {
    display:flex !important;
    flex-wrap:wrap !important;
    gap:6px !important;
    justify-content:space-between !important;
  }
  .topbar .tools-btn, .top-buttons .tools-btn, .tools-top .tools-btn,
  .btn-strip .tools-btn, .card > .flex:first-child .tools-btn {
    flex:1 1 calc(50% - 6px) !important;
    text-align:center !important;
  }
  .topbar, .top-buttons, .tools-top, .btn-strip, .card > .flex:first-child {
    overflow:visible !important;
  }
}
</style>


<!-- Injected by assistant: hide unwanted UI elements -->
<style id="assistant-hidden-elements">
  /* Hide the topbar close (×) button */
  .spot-close-btn { display: none !important; }

  /* Hide the element next to the "ВХОД" button (market info pill) */
  #marketInfo { display: none !important; }

  /* Optional: collapse any leftover spacing next to the login button */
  #marketInfo + #togglePricesBtn { margin-left: 0 !important; }
</style>


<style id="volumes-active-style">
  #volumesTableWrap .active {
    background: rgba(51, 65, 85, 0.6) !important;
    border: 1px solid #7c3aed !important;
    box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.25);
  }
</style>


<style>
/* Gate visibility controlled ONLY by body.trial-show */
#trialGateBackdrop, #trialGate { display: none !important; }
body.trial-show #trialGateBackdrop, body.trial-show #trialGate { display: block !important; }

/* Lock page when gate is shown */
html.trial-locked, body.trial-locked { overflow: hidden !important; }
</style>

</head>
<body>
<div class="min-h-screen">
<div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6">
<div class="text-center mb-4 sm:mb-6">
<h1 class="text-2xl sm:text-3xl font-bold">Crypto Run Tracker</h1>
</div>
<div class="card p-3 sm:p-4 mb-4 sm:mb-6">
<div class="flex flex-col lg:flex-row gap-3 items-stretch lg:items-center justify-between">
<div class="relative flex-1 w-full flex gap-2"><div class="flex items-center justify-between gap-3 flex-wrap"><div class="flex items-center gap-2"><button class="tools-btn oi-mini border border-purple-500" id="btn-bybit-futures">Фьючерсы Bybit</button><button class="tools-btn oi-mini border border-purple-500" id="btn-binance-spot">Спот Binance</button><button class="tools-btn oi-mini border border-purple-500" id="btn-bybit-spot">Спот Bybit</button><button class="tools-btn oi-mini border border-purple-500" id="" style="display:none;"></button><button class="tools-btn oi-mini border border-purple-500">NATR</button><button class="tools-btn oi-mini border border-purple-500" style="display:none;"></button></div><div class="flex items-center gap-2 ml-auto"><button class="tools-btn oi-mini border border-purple-500" id="marketInfo">Пары: 501</button></div></div><div class="mt-2 text-xs text-green-400" id="statusBar">WS: —</div></div>
<div class="flex items-center gap-2"> <button class="btn text-white" id="togglePricesBtn" type="button">ВХОД</button>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 items-stretch" style="min-height: 720px;">
<div class="lg:col-span-1 card p-4 flex flex-col">
<div class="mb-3">
<h2 class="text-xl font-bold">Топ фьючерсов (USDT‑PERP)</h2>
<div class="text-xs text-slate-400" id="filterHint"></div>
</div>
<div class="flex gap-2 mb-3">
<button class="btn flex-1 text-white bg-green-600/80 border-green-700" id="btnGainers" type="button">📈 Рост</button>
<button class="btn flex-1 text-white" id="btnLosers" type="button">📉 Падение</button>
</div>
<div class="scroll-area overflow-y-auto" id="screenerList"></div>
<div class="mt-3 hidden rounded-xl border border-slate-700 p-3 bg-slate-900/70 backdrop-blur-md" id="oiFloat">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center gap-2">
<span class="text-slate-300 text-sm">Open Interest</span>
<span class="pill" id="oiF_sym">—</span>
</div>
<div class="oi-periods">
<button class="tools-btn oi-mini" id="oiP_1m" type="button">1м</button>
<button class="tools-btn oi-mini active" id="oiP_5m" type="button">5м</button>
<button class="tools-btn oi-mini" id="oiP_15m" type="button">15м</button>
</div>
</div>
<div class="grid grid-cols-2 gap-3 font-mono text-sm">
<div>
<div class="text-slate-400 text-xs" id="oiF_buyLbl">Taker Buy (5m)</div>
<div><span class="text-green-400" id="oiF_buy">—</span> <span class="text-green-300 text-xs" id="oiF_buyPct"> </span></div>
</div>
<div>
<div class="text-slate-400 text-xs" id="oiF_sellLbl">Taker Sell (5m)</div>
<div><span class="text-red-400" id="oiF_sell">—</span> <span class="text-red-300 text-xs" id="oiF_sellPct"> </span></div>
</div>
<div>
<div class="text-slate-400 text-xs">Open Interest (now)</div>
<div id="oiF_now">—</div>
</div>
<div>
<div class="text-slate-400 text-xs">Δ OI vs prev</div>
<div id="oiF_delta">—</div>
</div>
<div class="col-span-2">
<div class="text-slate-400 text-xs">Всего (Buy+Sell, 5m)</div>
<div id="oiF_total">—</div>
</div>
</div>
<div class="text-xs text-slate-400 mt-2" id="oiF_ts">—</div>
</div>
</div>
<div class="lg:col-span-2 space-y-4 col-right">
<div class="card p-4">
<div class="flex items-center justify-between">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-full bg-slate-700 grid place-items-center text-white font-bold" id="assetAvatar">—</div>
<div><h3 class="font-semibold text-lg" id="assetName">—</h3><p class="text-slate-400 text-sm" id="assetSymbol">—</p></div>
</div>
<div class="text-right">
<div class="font-mono text-xl" id="assetPrice">…</div>
<div class="text-sm font-semibold" id="assetChange">—</div>
</div>
</div>
</div>
<div class="card p-0 overflow-hidden"><div id="tv-container"></div></div>
<div class="card">
<div class="sticky top-0 p-2 border-b border-slate-700 bg-slate-900/60 backdrop-blur-sm rounded-t-xl flex gap-2 flex-wrap">
<button class="tools-btn" data-tool="volumes">Объёмы</button>

</div>
<div class="p-3" id="toolsContent"></div>
</div>
</div>
</div>
</div>
</div>
<script>
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');

      const fmtMoney = (v) => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:v<1?4:2,maximumFractionDigits:v<1?6:2}).format(v);
      const n2=(v)=>Number(v).toFixed(2); const pct=(v)=> isFinite(v)?((v>=0?'+':'')+Number(v).toFixed(2)+'%'):'—';

      const state = {
        map:{}, list:[], selected:null,
        showPrices:true, screenerView:'gainers', search:'',
        prevVisibleSet:new Set(), wsConnected:false,
        activeTool:'volumes',
        oiPeriod:'5m',
        params:{ signals:{ rsi:14, ma:50, ema:200, macd:{fast:12,slow:26,sig:9}, tfs:['5m','15m','1h','4h'] } }
      };

      const el={
        search:document.getElementById('searchInput'),
        clear:document.getElementById('clearSearch'),
        searchBtn:document.getElementById('searchBtn'),
        toggle:document.getElementById('togglePricesBtn'),
        gainers:document.getElementById('btnGainers'),
        losers:document.getElementById('btnLosers'),
        screener:document.getElementById('screenerList'),
        status:document.getElementById('statusBar'),
        hint:document.getElementById('filterHint'),
        marketInfo:document.getElementById('marketInfo'),
        toolsContent:document.getElementById('toolsContent'),
      };

      function enforceViewportRows(){
        const r = el.screener.querySelector('.row-crypto');
        const h = r ? r.getBoundingClientRect().height : 64;
        const isMobile = window.matchMedia('(max-width: 767px)').matches;
        const rows = isMobile ? 5 : 13;
        el.screener.style.maxHeight = (h*rows) + 'px';
      }

      function renderStatus(){
        const count = state.list.length;
        el.status.innerHTML = `<span class="${state.wsConnected ? "text-green-400" : "text-red-400"}">WS: ${state.wsConnected ? "подключено" : "нет соединения"}</span>`;
        if (el.marketInfo) el.marketInfo.textContent='Пары: '+(count||'—');
      }

      let tvWidget=null;
      function ensureTV(cb){
        if (window.TradingView && window.TradingView.widget) return cb();
        if (document.getElementById('tvjs')) return setTimeout(cb,120);
        const s=document.createElement('script'); s.id='tvjs'; s.src='https://s3.tradingview.com/tv.js'; s.onload=cb; document.body.appendChild(s);
      }
      function renderTV(symbol){
        ensureTV(()=>{
          if (!window.TradingView) return;
          if (tvWidget && tvWidget.remove) try{tvWidget.remove();}catch(e){}
          tvWidget = new window.TradingView.widget({
            autosize:true, symbol:'BINANCE:'+symbol+'.P', interval:'60', theme:'dark', style:'1', locale:'en',
            container_id:'tv-container', hide_top_toolbar:false, hide_side_toolbar:false, toolbar_bg:'#0f172a', withdateranges:true, details:true, hotlist:true, calendar:true,
            overrides:{'paneProperties.background':'#0f172a','paneProperties.vertGridProperties.color':'#374151','paneProperties.horzGridProperties.color':'#374151'}
          });
        });
      }

      async function loadMarkets(){
        const ex = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
        const usdt = ex.symbols.filter(s=>s.status==='TRADING' && s.quoteAsset==='USDT' && s.contractType==='PERPETUAL')
          .map(s=>({symbol:s.symbol, base:s.baseAsset, quote:s.quoteAsset, onboard:s.onboardDate}));
        const t = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const mapT=Object.fromEntries(t.map(x=>[x.symbol,x]));
        state.map={}; state.list=[];
        for (const s of usdt){
          const tt=mapT[s.symbol]; if(!tt) continue;
          state.map[s.symbol]={...s, price:+tt.lastPrice, change24h:+tt.priceChangePercent, volumeQuote:+tt.quoteVolume, volumeBase:+tt.volume, high:+tt.highPrice, low:+tt.lowPrice};
          state.list.push(s.symbol);
        }
        state.list.sort((a,b)=> (state.map[b].volumeQuote||0)-(state.map[a].volumeQuote||0));
        state.selected = state.list[0]||'BTCUSDT';
      }

      
// === Funding rates (Binance Futures) ===
let fundingMap = Object.create(null);
let fundingTS = 0;
async function fetchFundingAll(){
  const base = `https://fapi.binance.com/fapi/v1/premiumIndex`;
  const ways = [
    base,
    `https://cors.isomorphic-git.org/${base}`,
    `https://r.jina.ai/http://fapi.binance.com/fapi/v1/premiumIndex`,
    `https://corsproxy.io/?${encodeURIComponent(base)}`
  ];
  let lastErr=null;
  for(const u of ways){
    try{
      const r = await fetch(u,{cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();
      if(Array.isArray(j)){
        const m = Object.create(null);
        for(const it of j){
          if(!it || !it.symbol) continue;
          const sym = it.symbol;
          let fr = null;
          if (it.lastFundingRate!=null) fr = Number(it.lastFundingRate)*100;
          else if (it.fundingRate!=null) fr = Number(it.fundingRate)*100;
          if (isFinite(fr)) m[sym] = fr;
        }
        fundingMap = m; fundingTS = Date.now();
        return m;
      }
    }catch(e){ lastErr=e; }
  }
  console.warn('Funding fetch failed', lastErr);
  return fundingMap;
}
function fmtFunding(v){
  if (v==null || !isFinite(v)) return '—';
  const s = (v>=0?'+':'') + v.toFixed(3) + '%';
  return s;
}
async function ensureFundingFresh(){
  const staleMs = 5*60*1000;
  if (Date.now() - fundingTS > staleMs) await fetchFundingAll();
}
setInterval(fetchFundingAll, 5*60*1000);
fetchFundingAll();

function startWS(){
        const ws = new WebSocket('wss://fstream.binance.com/stream?streams=!ticker@arr');
        ws.onopen=()=>{state.wsConnected=true; renderStatus();};
        ws.onmessage=(e)=>{
          const msg=JSON.parse(e.data); const arr=msg && msg.data; if(!Array.isArray(arr)) return;
          for(const t of arr){ const s=t.s; const e=state.map[s]; if(!e) continue; e.price=+t.c; e.change24h=+t.P; e.volumeQuote=+t.q; e.volumeBase=+t.v; }
          renderHeader(); maybeRenderScreener(); if(state.activeTool==='volumes') renderTool('volumes');
        };
        ws.onclose=()=>{state.wsConnected=false; renderStatus(); setTimeout(startWS,1500);};
        ws.onerror=()=>{state.wsConnected=false; renderStatus();};
      }

      function renderHeader(){
        const c=state.map[state.selected]; if(!c) return;
        document.getElementById('assetAvatar').textContent=(c.base||'?').slice(0,3);
        document.getElementById('assetName').textContent=c.base+' PERP';
        document.getElementById('assetSymbol').textContent=c.symbol+' (Futures)';
        document.getElementById('assetPrice').textContent=c.price!=null ? (state.showPrices?fmtMoney(c.price):'•••••'):'…';
        const ch=Number(c.change24h), elC=document.getElementById('assetChange');
        if(isFinite(ch)){ elC.textContent=`${ch>=0?'+':''}${ch.toFixed(2)}% 24h`; elC.className=`text-sm font-semibold ${ch>=0?'text-green-400':'text-red-400'}`;}
        else { elC.textContent='—'; elC.className='text-sm font-semibold text-slate-400'; }
      }

      function filteredSymbols(){
        const q=state.search.trim().toLowerCase(); if(!q) return state.list;
        return state.list.filter(sym=>{
          const e=state.map[sym]; return e.symbol.toLowerCase().includes(q) || e.base.toLowerCase().includes(q);
        });
      }
      function screenerOrder(list){
        const entries=list.map(sym=>state.map[sym]).filter(Boolean);
        return (state.screenerView==='gainers') ? entries.sort((a,b)=> (b.change24h)-(a.change24h)) : entries.sort((a,b)=> (a.change24h)-(b.change24h));
      }
      async function renderScreener(){
      // bind gainers/losers buttons once
      if (!window._screenerBtnsBound){
        if (el.gainers) el.gainers.addEventListener('click', ()=>{ state.screenerView='gainers'; if (el.gainers) {el.gainers.classList.add('bg-green-600/80','border-green-700');} if (el.losers) {el.losers.classList.remove('bg-red-600/80','border-red-700');} renderScreener(); });
        if (el.losers) el.losers.addEventListener('click', ()=>{ state.screenerView='losers'; if (el.losers) {el.losers.classList.add('bg-red-600/80','border-red-700');} if (el.gainers) {el.gainers.classList.remove('bg-green-600/80','border-green-700');} renderScreener(); });
        window._screenerBtnsBound = true;
      }

        await ensureFundingFresh(); const q=state.search.trim(); const pool=filteredSymbols(); let entries=screenerOrder(pool); let hint='';
        if(q && pool.length===0){ entries=screenerOrder(state.list); hint=`Нет результатов по “${q}”. Показан общий топ.`; }
        el.hint.textContent=hint;
        const visible=entries.slice(0,13).map(c=>c.symbol); state.prevVisibleSet=new Set(visible);
        const rows=entries.map((c,idx)=>{
          const isSel=c.symbol===state.selected;
          const change=c.change24h, cls=isFinite(change)?(change>=0?'text-green-400':'text-red-400'):'text-slate-400';
          const priceText=c.price!=null?(state.showPrices?fmtMoney(c.price):'•••••'):'…';
          return `<div class="row-crypto p-3 rounded-lg cursor-pointer transition-all ${isSel?'bg-slate-700 border border-purple-500':'bg-slate-700/30 hover:bg-slate-700/50'}" data-sym="${c.symbol}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 grid place-items-center text-xs font-bold">${c.base.slice(0,3)}</div>
                <div><div class="font-semibold text-sm">${c.base} PERP</div><div class="text-slate-400 text-xs">${c.symbol}</div></div>
              </div>
              <div class="text-right">
                <div class="text-xs opacity-80 mt-0.5">${fmtFunding(fundingMap[c.symbol])}</div>

                <div class="font-mono text-sm">${priceText}</div>
                <div class="text-xs font-semibold ${cls}">${isFinite(change)?(change>=0?'+':'')+change.toFixed(2)+'%':'—'}</div>
              </div>
            </div></div>`;
        }).join('');
        el.screener.innerHTML = rows || '<div class="text-slate-400 text-sm">Данных пока нет…</div>';
        el.screener.querySelectorAll('[data-sym]').forEach(n=> n.onclick=()=>{ const s=n.getAttribute('data-sym'); if(state.map[s]){ state.selected=s; renderHeader(); renderTV(s); renderScreener(); renderTool(state.activeTool); OI_updateFloat(s); }});
        enforceViewportRows();
      }
      function maybeRenderScreener(){ renderScreener(); }

      function applySearch(){
        state.search=el.search.value||'';
        const m=filteredSymbols();
        if(state.search.trim() && m.length>0){ const first=m[0]; if(first && first!==state.selected){ state.selected=first; renderHeader(); renderTV(first);} }
        renderScreener(); if(state.activeTool) renderTool(state.activeTool);
      }

      function renderTool(mode){
        if(mode==='volumes') return renderToolVolumes();
        if(mode==='listings') return renderToolListings();
        if(mode==='signals') return renderToolSignals();
        if(mode==='news') return renderToolNews();
      }

      
      
      
  
  
  
  
  
  function renderToolVolumes(){
    const isMobile = window.matchMedia('(max-width: 767px)').matches;

    // ---------- контейнер инструмента (создаём один раз) ----------
    let root = document.getElementById('volumesRoot');
    if (!root) {
      el.toolsContent.innerHTML = `
        <div id="volumesRoot">
          <div class="mb-3 flex flex-wrap items-center gap-2">
            <span class="text-slate-300">Futures (Binance) — 24ч данные по тикеру</span>
            <input id="volQ" class="input w-56" style="color:#000;background:#fff" placeholder="BTC / BTCUSDT" autocomplete="off"/>
            <button id="volFind" class="btn" type="button">Найти</button>
            <span id="volErr" class="text-red-400 text-sm" style="display:none"></span>
          </div>
          <div id="volResult" class="mb-4"></div>
<!-- === Совет агента (FORCE) — автономный поиск внутри панели === -->
<div id="agentPanel" style="border:1px solid #1f2937;background:rgba(15,23,42,.6);border-radius:16px;padding:12px;margin-top:12px;max-width:1024px;margin-left:auto;margin-right:auto;">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <div style="color:#e2e8f0;font-weight:700;">Совет агента</div>
    <input id="agentSearchInput" placeholder="например: BTC или BTCUSDT" style="flex:1 1 220px;min-width:220px;border-radius:12px;background:rgba(2,6,23,.5);border:1px solid #334155;padding:8px 12px;color:white;">
    <button id="agentSearchBtn" type="button" onclick="agent_panel_run()" style="background:#0ea5e9;color:white;border-radius:12px;padding:8px 14px;font-weight:600;">Найти</button>
  </div>
  <div id="agentOut" style="color:#94a3b8;font-size:14px;margin-top:8px;">Введите тикер и нажмите «Найти» — получите ЛОНГ/ШОРТ, Entry/SL/TP, RR, ATR и причины.</div>
</div>

          <div class="mb-2 text-slate-300">Рейтинг по 24ч объёму (Futures)</div>
          <div id="volumesTableWrap" class="scroll-area" style="max-height: 396px; overflow-y:auto;"></div>
        </div>
      `;
      root = document.getElementById('volumesRoot');
    }

    const qInput = document.getElementById('volQ');
    const findBtn = document.getElementById('volFind');
    const errLbl  = document.getElementById('volErr');
    const resBox  = document.getElementById('volResult');
    const tableWrap = document.getElementById('volumesTableWrap');

    // ---------- "липкое" значение инпута ----------
    // Храним текущий запрос в state.volumesQuery; не перезатираем поле на повторных рендерах.
    if (typeof state.volumesQuery !== 'string') {
      state.volumesQuery = (state?.map?.[state?.selected]?.symbol) || (state?.map?.[state?.selected]?.base) || '';
    }
    if (qInput.value !== state.volumesQuery) {
      qInput.value = state.volumesQuery;
    }
    qInput.style.setProperty('color','#000','important');
    qInput.addEventListener('input', ()=>{
      state.volumesQuery = qInput.value;
      qInput.style.setProperty('color','#000','important');
    });
    qInput.addEventListener('focus', ()=>{
      qInput.style.setProperty('color','#000','important');
    });
    qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); doFind(); } });

    function fmtTs(ts){ try{ return new Date(Number(ts)).toLocaleString(); }catch(_){ return '—'; } }
    function safe(v, digits=2){ const n=Number(v); return Number.isFinite(n)? n.toFixed(digits):'—'; }
    function money(v){ const n=Number(v); return Number.isFinite(n)? fmtMoney(n):'—'; }
    function setErr(msg){ errLbl.textContent = msg || 'Тикер не найден (Futures)'; errLbl.style.display='inline'; }
    function clearErr(){ errLbl.style.display='none'; errLbl.textContent=''; }
    function busy(b){ findBtn.disabled = b; findBtn.setAttribute('aria-busy', b?'true':'false'); }

    async function binanceFetch(url){
      const r = await fetch(url, {cache:'no-store'});
      if(!r.ok){
        const txt = await r.text().catch(()=>'');
        const e = new Error('HTTP ' + r.status);
        e.status = r.status; e.body = txt;
        throw e;
      }
      return r.json();
    }

    async function resolveSymbolFutures(q){
      if (state?.map?.[q]) return q;
      const local = state?.list?.find(s => (state.map[s]?.base||'').toUpperCase() === q || s.includes(q));
      if (local) return local;
      try{
        const info = await binanceFetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
        const bySym = info.symbols?.find(s => s.symbol === q);
        if (bySym) return bySym.symbol;
        const byBase = info.symbols?.find(s => s.baseAsset === q && s.quoteAsset === 'USDT');
        if (byBase) return byBase.symbol;
      }catch(_){}
      return null;
    }

    async function fetch24hrFutures(sym){
      return binanceFetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=' + encodeURIComponent(sym));
    }

    async function lookupAndRender(symbolOrBase){
      clearErr();
      resBox.innerHTML = '';

      const raw = (symbolOrBase ?? state.volumesQuery ?? '').trim();
      const q = raw.toUpperCase();
      state.volumesQuery = q; // запоминаем
      qInput.value = q;
      qInput.style.setProperty('color','#000','important');
      if(!q){ setErr('Введите тикер фьючерса, например BTC или BTCUSDT'); return; }

      busy(true);
      try{
        let sym = await resolveSymbolFutures(q);
        if (!sym) throw new Error('Тикер не найден в Binance Futures');
        const data = await fetch24hrFutures(sym);

        // успех: нормализуем в состояние и в поле
        state.volumesQuery = data.symbol || sym;
        qInput.value = state.volumesQuery;
        qInput.style.setProperty('color','#000','important');

        const ch = Number(data.priceChangePercent);
        const chCls = Number.isFinite(ch) ? (ch>=0 ? 'text-green-400' : 'text-red-400') : 'text-slate-400';

        resBox.innerHTML = `
          <div class="rounded-xl border border-slate-700 p-3 bg-slate-800/40">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="pill">${data.symbol || sym}</span>
                <span class="text-slate-400 text-xs">FUTURES</span>
                <span class="text-slate-400 text-sm">24ч сводка</span>
              </div>
              <div class="text-right ${chCls} text-sm font-semibold">
                ${Number.isFinite(ch) ? (ch>=0?'+':'') + ch.toFixed(2) + '%' : '—'} <span class="ml-2 pill">${Number.isFinite(ch) ? (ch>0?'▲ UP': (ch<0?'▼ DOWN':'▬ FLAT')) : ''}</span>
              </div>
            
            <!-- Мини-шкала изменения за 24ч -->
            ${(() => {
                if (!Number.isFinite(ch)) return '';
                const cap = 20; // диапазон ±20%
                const mag = Math.min(cap, Math.abs(ch));
                const w = Math.max(2, Math.round((mag / cap) * 100));
                return `
                <div class="mb-3">
                  <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Change (24h) — magnitude</div>
                  <div class="bar" style="height:8px;"><div style="width:${w}%;"></div></div>
                  <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span>-20%</span><span>0%</span><span>+20%</span>
                  </div>
                </div>`;
            })()}
</div>

            <!-- Секция: Цены -->
            <div class="mb-3">
              <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Prices</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 font-mono text-sm">
                <div><div class="text-slate-400">Last Price</div><div>${safe(data.lastPrice, (Number(data.lastPrice)<1?6:2))}</div></div>
                <div><div class="text-slate-400">Price Change</div><div>${safe(data.priceChange)} (${safe(data.priceChangePercent)}%)</div></div>
                <div><div class="text-slate-400">Weighted Avg</div><div>${safe(data.weightedAvgPrice)}</div></div>
                <div><div class="text-slate-400">High (24h)</div><div>${safe(data.highPrice)}</div></div>
                <div><div class="text-slate-400">Low (24h)</div><div>${safe(data.lowPrice)}</div></div>
                <div><div class="text-slate-400">Open Price</div><div>${safe(data.openPrice)}</div></div>
              </div>
            </div>

            <!-- Секция: Объёмы с заполнением как в рейтинге -->
            ${(() => {
                try {
                  const list = (state?.list||[]).map(s => state.map[s]).filter(Boolean);
                  const maxBase = Math.max(...list.map(c => Number(c.volumeBase||0)), 1);
                  const maxQuote = Math.max(...list.map(c => Number(c.volumeQuote||0)), 1);
                  const vb = Number(data.volume||0);
                  const vq = Number(data.quoteVolume||0);
                  const wb = Math.max(2, Math.round((vb/maxBase)*100));
                  const wq = Math.max(2, Math.round((vq/maxQuote)*100));
                  return `
                  <div class="mb-3">
                    <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Volumes</div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                      <div>
                        <div class="text-slate-400 text-xs mb-1">Объём (base)</div>
                        <div class="bar"><div style="width:${wb}%"></div></div>
                        <div class="font-mono text-sm mt-1">${vb.toLocaleString('en-US')}</div>
                      </div>
                      <div>
                        <div class="text-slate-400 text-xs mb-1">Объём (USDT)</div>
                        <div class="bar"><div style="width:${wq}%"></div></div>
                        <div class="font-mono text-sm mt-1">${fmtMoney(vq)}</div>
                      </div>
                    </div>
                  </div>`;
                } catch(_){ return ''; }
              })()}

            <!-- Секция: Время и торговая активность -->
            <div class="mb-1">
              <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Times & Activity</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 font-mono text-sm">
                <div><div class="text-slate-400">Open Time</div><div>${fmtTs(data.openTime)}</div></div>
                <div><div class="text-slate-400">Close Time</div><div>${fmtTs(data.closeTime)}</div></div>
                <div><div class="text-slate-400">Trades (count)</div><div>${Number(data.count||0).toLocaleString('en-US')}</div></div>
                <div><div class="text-slate-400">Last Qty</div><div>${safe(data.lastQty)}</div></div>
              </div>
            </div>
          </div>
`;
      }catch(e){
        console.error(e);
        setErr(e?.message || 'Ошибка поиска во фьючерсах');
      }finally{
        busy(false);
      }
    }

    function doFind(){ lookupAndRender(qInput.value); }
    findBtn.onclick = doFind;

    // ---------- нижний блок: рейтинг по объёмам (как есть) ----------
    const data = (state?.list||[])
      .map(s => state.map[s])
      .filter(Boolean)
      .sort((a,b)=>(b.volumeQuote||0)-(a.volumeQuote||0))
      .slice(0,200);

    const maxBase = Math.max(...data.map(c=>Number(c.volumeBase||0)), 1);
    const maxQuote = Math.max(...data.map(c=>Number(c.volumeQuote||0)), 1);

    if (isMobile) {
      const cards = data.map((c,i)=>{
        const vb = Number(c.volumeBase||0);
        const vq = Number(c.volumeQuote||0);
        const wb = Math.max(2, Math.round((vb/maxBase)*100));
        const wq = Math.max(2, Math.round((vq/maxQuote)*100));
        const change = Number(c.change24h);
        const chClass = Number.isFinite(change) ? (change>=0?'text-green-400':'text-red-400') : 'text-slate-400';
        const chText = Number.isFinite(change) ? `${change>=0?'+':''}${change.toFixed(2)}%` : '—';
        return `<div class="rounded-xl border border-slate-700 p-3 mb-3 bg-slate-800/40">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="pill text-xs">${i+1}</span>
              <span class="pill" data-sym="${c.symbol}">${c.symbol}</span>
            </div>
            <div class="text-right ${chClass} text-sm font-semibold">${chText}</div>
          </div>
          <div class="grid grid-cols-1 gap-2">
            <div>
              <div class="text-xs text-slate-400 mb-1">Объём (base)</div>
              <div class="bar"><div style="width:${wb}%"></div></div>
              <div class="font-mono text-sm mt-1">${vb.toLocaleString('en-US')}</div>
            </div>
            <div>
              <div class="text-xs text-slate-400 mb-1">Объём (USDT)</div>
              <div class="bar"><div style="width:${wq}%"></div></div>
              <div class="font-mono text-sm mt-1">${fmtMoney(vq)}</div>
            </div>
          </div>
        </div>`;
      }).join('');
      tableWrap.innerHTML = cards;
      return;
    }

    // Desktop/Tablet: table view
    const rows = data.map((c,i)=>{
      const vb = Number(c.volumeBase||0);
      const vq = Number(c.volumeQuote||0);
      const wb = Math.max(2, Math.round((vb/maxBase)*100));
      const wq = Math.max(2, Math.round((vq/maxQuote)*100));
      return `<tr class="odd:bg-slate-800/40 even:bg-transparent">
        <td class="px-2 py-2 text-slate-400">${i+1}</td>
        <td class="px-2 py-2"><span class="pill" data-sym="${c.symbol}">${c.symbol}</span></td>
        <td class="px-2 py-2 text-right">
          <div class="bar"><div style="width:${wb}%"></div></div>
          <div>${(vb).toLocaleString('en-US')}</div>
        </td>
        <td class="px-2 py-2 text-right">
          <div class="bar"><div style="width:${wq}%"></div></div>
          <div>${fmtMoney(vq)}</div>
        </td>
        <td class="px-2 py-2 text-right ${c.change24h>=0?'text-green-400':'text-red-400'}">${pct(c.change24h)}</td>
      </tr>`;
    }).join('');

    tableWrap.innerHTML = `
      <table style="table-layout:fixed; width:100%;">
        <colgroup>
          <col style="width:40px;">
          <col style="width:110px;">
          <col style="width:160px;">
          <col style="width:160px;">
          <col style="width:auto;">
        </colgroup>
        <thead style="position:sticky; top:0; background:rgba(15,23,42,.9);">
          <tr>
            <th class="text-left px-2 py-2">#</th>
            <th class="text-left px-2 py-2">Пара</th>
            <th class="text-right px-2 py-2">Объём (base)</th>
            <th class="text-right px-2 py-2">Объём (USDT)</th>
            <th class="text-right px-2 py-2">Изм. 24ч</th>
          </tr>
        </thead>
        <tbody class="font-mono text-sm">
          ${rows}
        </tbody>
      </table>
    `;
  }

          function renderToolListings(){
        el.toolsContent.innerHTML = `
          <div class="mb-2 text-slate-300">Новые листинги USDT‑PERP (Binance Futures)</div>
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <input id="annQ" class="input w-44" placeholder="Ключевое слово (напр., BTC)" />
            <button id="btnAnnByBase" class="btn">Анонсы (по базе)</button>
            <button id="btnAnnAll" class="btn">Все анонсы</button>
          </div>
          <div class="scroll-area" style="max-height: 264px; overflow-y:auto;">
            <table>
              <thead><tr><th>Пара</th><th>Добавлен</th><th>База</th></tr></thead>
              <tbody id="listingsBody"><tr><td colspan="3" class="text-slate-400">Загружаю…</td></tr></tbody>
            </table>
          </div>`;
        (async()=>{
          try{
            const ex=await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r=>r.json());
            const list=(ex.symbols||[]).filter(s=>s.status==='TRADING'&&s.quoteAsset==='USDT'&&s.contractType==='PERPETUAL'&&s.onboardDate).sort((a,b)=>b.onboardDate-a.onboardDate);
            document.getElementById('annQ').value = (state.map[state.selected]?.base)||'';
            document.getElementById('btnAnnByBase').onclick=()=>{
              const q=(document.getElementById('annQ').value||'').trim()||((state.map[state.selected]?.base)||'');
              window.open(`https://www.google.com/search?q=${encodeURIComponent(q+' binance announcement futures perpetual')}`,'_blank','noopener');
            };
            document.getElementById('btnAnnAll').onclick=()=>{
              window.open(`https://www.google.com/search?q=${encodeURIComponent('binance announcement futures perpetual')}`,'_blank','noopener');
            };
            const rows=list.map(s=>`<tr><td><span class="pill">${s.symbol}</span></td><td>${new Date(s.onboardDate).toLocaleString()}</td><td>${s.baseAsset}</td></tr>`).join('');
            document.getElementById('listingsBody').innerHTML = rows || '<tr><td colspan="3" class="text-slate-400">Пока пусто</td></tr>';
          }catch(e){ document.getElementById('listingsBody').innerHTML='<tr><td colspan="3" class="text-red-400">Ошибка загрузки</td></tr>'; }
        })();
      }

      async function renderToolSignals(){
        const sym=state.selected;
        el.toolsContent.innerHTML = `
          <div class="mb-2 flex flex-wrap items-center gap-2">
            <span class="text-slate-300">Сигналы для</span>
            <input id="sigSearch" class="input w-44" style="color:#000;background:#fff" value="${sym}" placeholder="BTC / BTCUSDT"/>
            <button id="sigFind" class="btn">Найти</button>
            <span id="sigErr" class="text-red-400 text-sm" style="display:none">Не найдено</span>
          </div>
          <div id="sigTableWrap" class="text-slate-400">Загружаю…</div>`;
        (function(){
          const inp=document.getElementById('sigSearch'), btn=document.getElementById('sigFind'), err=document.getElementById('sigErr');
          const clearErr=()=>{err.style.display='none'; inp.style.borderColor='';};
          const doFind=()=>{
            clearErr(); const q=(inp.value||'').trim().toUpperCase(); if(!q) return;
            if(state.map[q]){ state.selected=q; renderHeader(); renderTV(q); renderTool('signals'); renderScreener(); return; }
            const found=state.list.find(s => (state.map[s]?.base||'').toUpperCase()===q || s.includes(q));
            if(found){ state.selected=found; renderHeader(); renderTV(found); renderTool('signals'); renderScreener(); } else { err.style.display='inline'; inp.style.borderColor='#ef4444'; }
          };
          btn.onclick=doFind; inp.onkeypress=(e)=>{ if(e.key==='Enter') doFind(); }; inp.oninput=clearErr;
        })();

        // build table
        const cfg=state.params.signals, tfs=cfg.tfs;
        function sma(a,q){const t=a.slice(-q);return t.reduce((x,y)=>x+y,0)/(t.length||1);}
        function emaSeries(v,k){let e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
        function macdFinal(a,fa,sl,sg){function ser(v,p){const k=2/(p+1);let e=v[0],o=[e];for(let i=1;i<v.length;i++){e=v[i]*k+e*(1-k);o.push(e);}return o;} const ef=ser(a,fa),es=ser(a,sl); const m=ef.map((v,i)=>v-es[i]); const s=ser(m,sg); return {hist:m.at(-1)-s.at(-1)};}
        function rsi(a,p){let g=0,l=0;for(let i=1;i<=p;i++){const c=a[i]-a[i-1]; if(c>=0) g+=c; else l-=c;} for(let i=p+1;i<a.length;i++){const c=a[i]-a[i-1]; g=(g*(p-1)+(c>0?c:0))/p; l=(l*(p-1)+(c<0?-c:0))/p;} const rs=g/(l||1e-9); return 100-100/(1+rs);}

        const results=[];
        for(const tf of tfs){
          try{
            const kl=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=300`).then(r=>r.json());
            const closes=kl.map(k=>+k[4]); const last=closes.at(-1); const ma=sma(closes,cfg.ma); const ema=emaSeries(closes,2/(cfg.ema+1)); const macd=macdFinal(closes,cfg.macd.fast,cfg.macd.slow,cfg.macd.sig); const r=rsi(closes,cfg.rsi);
            const trend = last>ma && last>ema ? 'up' : (last<ma && last<ema ? 'down' : 'range');
            results.push({tf,ma,ema,macd,r,trend});
          }catch(e){ results.push({tf,error:true}); }
        }
        const rows=results.map(r=>{
          if(r.error) return `<tr><td>${r.tf}</td><td colspan="4" class="text-red-400">Ошибка данных</td></tr>`;
          const tr=r.trend==='up'?'<span class="text-green-400">↑ Тренд</span>':(r.trend==='down'?'<span class="text-red-400">↓ Тренд</span>':'<span class="text-slate-400">Флет</span>');
          const mac = r.macd.hist>0?'<span class="text-green-400">MACD+</span>':'<span class="text-red-400">MACD-</span>';
          const rsiTxt = r.r>70?'<span class="text-red-400">RSI 70+</span>':(r.r<30?'<span class="text-green-400">RSI 30-</span>':'<span class="text-slate-400">RSI</span>');
          return `<tr><td>${r.tf}</td><td>${tr}</td><td>${mac}</td><td>${rsiTxt} <span class="text-slate-400">(${n2(r.r)})</span></td><td class="text-right text-slate-400">MA ${n2(r.ma)} / EMA ${n2(r.ema)}</td></tr>`;
        }).join('');
        document.getElementById('sigTableWrap').innerHTML = `<table><thead><tr><th>TF</th><th>Trend MA50/EMA200</th><th>MACD</th><th>RSI(14)</th><th class="text-right">MA детали</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      function renderToolNews(){
        const c=state.map[state.selected], base=c?c.base:''; const q=encodeURIComponent(base+' crypto');
        el.toolsContent.innerHTML = `<div class="text-slate-300 mb-3">Новости по: <strong>${base||state.selected||''}</strong></div>
          <div class="flex flex-wrap gap-2 mb-2">
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:coindesk.com&tbm=nws">CoinDesk</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:cointelegraph.com&tbm=nws">Cointelegraph</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:decrypt.co&tbm=nws">Decrypt</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:binance.com+announcement&tbm=nws">Binance Announcements</a>
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${q}+site:x.com">X (Twitter)</a>
          </div>`;
      }

      function bindTools(){
        const btns=document.querySelectorAll('.tools-btn');
        btns.forEach(b=>b.onclick=()=>{ btns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.activeTool=b.getAttribute('data-tool'); renderTool(state.activeTool); });
        (btns[0]||{}).classList.add('active');
      }

      (async function init(){
        bindTools(); renderStatus();
        try{ await loadMarkets(); renderHeader(); renderScreener(); renderTV(state.selected); startWS(); renderTool(state.activeTool); }
        catch(e){ el.status.innerHTML='<span class="text-red-400">Ошибка загрузки Binance Futures</span>'; }
      })();

      el.search.onkeypress=(e)=>{ if(e.key==='Enter') applySearch(); };
      el.searchBtn.onclick=applySearch;
      el.clear.onclick=()=>{ el.search.value=''; state.search=''; el.hint.textContent=''; renderScreener(); renderTool(state.activeTool); };
      el.toggle.onclick=()=>{ state.showPrices=!state.showPrices; el.toggle.textContent=state.showPrices?'🙈 Скрыть цены':'👁 Показать цены'; renderHeader(); renderScreener(); renderTool(state.activeTool); };
      el.gainers.onclick=()=>{ state.screenerView='gainers'; el.gainers.className='btn flex-1 text-white bg-green-600/80 border-green-700'; el.losers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      el.losers.onclick=()=>{ state.screenerView='losers'; el.losers.className='btn flex-1 text-white bg-red-600/80 border-red-700'; el.gainers.className='btn flex-1 text-white'; renderScreener(); renderTool(state.activeTool); };
      new ResizeObserver(()=>enforceViewportRows()).observe(el.screener);
    </script>
<script>
// ===== Autonomous FORCE Agent with its own search =====

// Network helpers (browser-friendly CORS fallbacks)
async function FA_loadKlines(symbol){
  const base = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=300`;
  const ways = [
    { url: base, tag:'FUTURES' },
    { url: `https://cors.isomorphic-git.org/${base}`, tag:'proxy:isomorphic-git' },
    { url: `https://corsproxy.io/?${encodeURIComponent(base)}`, tag:'proxy:corsproxy.io' },
  ];
  let lastErr=null;
  for(const w of ways){
    try{
      const r = await fetch(w.url,{cache:'no-store'});
      if(!r.ok) throw new Error(`${w.tag}: HTTP ${r.status}`);
      const j = await r.json();
      if(Array.isArray(j)) return { klines:j, source:w.tag };
      throw new Error(`${w.tag}: not array`);
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('no data');
}

async function FA_fetchTickSize(symbol){
  try{
    const r = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo',{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    const s = (j.symbols||[]).find(x=>x.symbol===symbol);
    if(!s) return { tick:0.01, digits:2 };
    const pf = (s.filters||[]).find(f=>f.filterType==='PRICE_FILTER');
    if (pf && pf.tickSize){
      const tick = parseFloat(pf.tickSize);
      const digs = (pf.tickSize.split('.')[1]||'').length;
      return { tick: tick>0?tick:0.01, digits: digs||2 };
    }
    const digits = Number.isFinite(s.pricePrecision)? s.pricePrecision : 2;
    return { tick: 1/Math.pow(10,digits), digits };
  }catch(_){ return { tick:0.01, digits:2 }; }
}
const FA_round=(x,t)=> (!Number.isFinite(t)||t<=0)? x : Math.round(x/t)*t;

// Indicators
const FA_sma=(a,p)=>{const t=a.slice(-p);return t.reduce((x,y)=>x+y,0)/(t.length||1)};
const FA_ema=(a,p)=>{const k=2/(p+1);let e=a[0];for(let i=1;i<a.length;i++)e=a[i]*k+e*(1-k);return e};
function FA_macdHist(a, fa=12, sl=26, sg=9){
  const ser=(v,p)=>{const k=2/(p+1);let e=v[0],o=[e];for(let i=1;i<v.length;i++){e=v[i]*k+e*(1-k);o.push(e);}return o};
  const ef=ser(a,fa), es=ser(a,sl); const m=ef.map((v,i)=>v-es[i]); const s=ser(m,sg);
  return m.at(-1)-s.at(-1);
}
function FA_rsi(a,p=14){
  if (a.length < p+2) return NaN;
  let g=0,l=0;for(let i=1;i<=p;i++){const c=a[i]-a[i-1]; if(c>=0) g+=c; else l-=c;}
  for(let i=p+1;i<a.length;i++){const c=a[i]-a[i-1]; g=(g*(p-1)+(c>0?c:0))/p; l=(l*(p-1)+(c<0?-c:0))/p;}
  const rs=g/(l||1e-9); return 100-100/(1+rs);
}
function FA_atr(kl,p=14){
  if (kl.length < p+1) return NaN;
  let trs=[];
  for(let i=1;i<kl.length;i++){
    const hi=+kl[i][2], lo=+kl[i][3], pc=+kl[i-1][4];
    trs.push(Math.max(hi-lo, Math.abs(hi-pc), Math.abs(lo-pc)));
  }
  let avg=0; for(let i=0;i<p;i++) avg+=trs[i]; avg/=p;
  for(let i=p;i<trs.length;i++) avg=(avg*(p-1)+trs[i])/p;
  return avg;
}

// Core agent: always LONG/SHORT + ATR levels + tick-size rounding
async function AGENT_run(symbolRaw){
  const symbol = (symbolRaw || 'BTCUSDT').toUpperCase();
  const { klines, source } = await FA_loadKlines(symbol);
  const closes = klines.map(k=>+k[4]);
  const last   = closes.at(-1);
  const MA50   = closes.length>=50  ? FA_sma(closes,50)  : NaN;
  const EMA200 = closes.length>=200 ? FA_ema(closes,200) : FA_ema(closes, Math.min(200, closes.length-1));
  const MACD_H = FA_macdHist(closes);
  const RSI14  = FA_rsi(closes,14);
  const ATR14  = FA_atr(klines,14);

  let scoreLong=0, scoreShort=0, notes=[];
  if (Number.isFinite(MA50) && Number.isFinite(EMA200)){
    if (last > MA50 && last > EMA200){ scoreLong+=2; notes.push('Цена выше MA50 и EMA200'); }
    if (last < MA50 && last < EMA200){ scoreShort+=2; notes.push('Цена ниже MA50 и EMA200'); }
  }
  if (Number.isFinite(MACD_H)){
    if (MACD_H > 0){ scoreLong+=1; notes.push('MACD гистограмма > 0'); }
    if (MACD_H < 0){ scoreShort+=1; notes.push('MACD гистограмма < 0'); }
  }
  if (Number.isFinite(RSI14)){
    if (RSI14 > 70){ scoreShort+=1; notes.push('RSI>70 (перекупленность)'); }
    if (RSI14 < 30){ scoreLong+=1; notes.push('RSI<30 (перепроданность)'); }
  }

  // Force decision
  let side='NEUTRAL', confidence=0.52;
  if (scoreLong - scoreShort >= 2){ side='LONG'; confidence=0.68; }
  else if (scoreShort - scoreLong >= 2){ side='SHORT'; confidence=0.68; }
  else {
    if (Number.isFinite(EMA200) && Number.isFinite(last)){
      if (last > EMA200){ side='LONG';  confidence = 0.58; }
      else if (last < EMA200){ side='SHORT'; confidence = 0.58; }
    }
    if (side==='NEUTRAL' && Number.isFinite(MACD_H)){
      if (MACD_H > 0){ side='LONG'; confidence = Math.max(confidence, 0.56); }
      else if (MACD_H < 0){ side='SHORT'; confidence = Math.max(confidence, 0.56); }
    }
    if (side==='NEUTRAL' && Number.isFinite(RSI14)){
      if (RSI14 >= 50){ side='LONG';  confidence = Math.max(confidence, 0.54); }
      else { side='SHORT'; confidence = Math.max(confidence, 0.54); }
    }
    if (side==='NEUTRAL'){ side='LONG'; confidence=0.51; }
  }

  // Entry/SL/TP via ATR (RR~2)
  let entry=last, sl=null, tp=null;
  if (Number.isFinite(ATR14) && ATR14>0){
    if (side==='LONG'){ sl=last-1*ATR14; tp=last+2*ATR14; }
    else { sl=last+1*ATR14; tp=last-2*ATR14; }
  }else{
    const pct=0.01;
    if (side==='LONG'){ sl=last*(1-pct); tp=last*(1+2*pct); }
    else { sl=last*(1+pct); tp=last*(1-2*pct); }
  }

  const { tick, digits } = await FA_fetchTickSize(symbol).catch(()=>({tick:0.01,digits:2}));
  const entryR = FA_round(entry, tick);
  const slR    = FA_round(sl, tick);
  const tpR    = FA_round(tp, tick);
  const rr     = Math.abs((tpR-entryR)/(entryR-slR));

  return { symbol, side, confidence, entry:entryR, sl:slR, tp:tpR, rr, notes, source, ATR14, tick, digits };
}

// Render into agent panel
function AGENT_render(res){
  const box = document.getElementById('agentOut');
  if (!box) return;
  const digs = Number.isFinite(res.digits)? res.digits : 6;
  const f = (x)=> Number(x).toLocaleString('ru-RU',{minimumFractionDigits:digs, maximumFractionDigits:digs});
  const color = res.side==='LONG' ? '#22c55e' : '#ef4444';
  box.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div>
        <span style="border:1px solid ${color};color:${color};padding:2px 10px;border-radius:999px;font-weight:700;">${res.side}</span>
        <span style="color:#94a3b8;margin-left:8px">Conf: ${(res.confidence*100|0)}%</span>
        <span style="color:#94a3b8;margin-left:8px">RR≈${res.rr.toFixed(2)}</span>
      </div>
      <div style="color:#94a3b8;font-size:12px;">ATR14≈${Number(res.ATR14||0).toFixed(6)} | режим: форс-решение</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:8px;font-size:14px;">
      <div><div class="label">Вход</div><div class="value">${f(res.entry)}</div></div>
      <div><div class="label">SL</div><div class="value">${f(res.sl)}</div></div>
      <div><div class="label">TP</div><div class="value">${f(res.tp)}</div></div>
    </div>
    <div style="margin-top:8px;color:#e2e8f0">Итог: <b>${res.side==='LONG'?'ЛОНГ':'ШОРТ'}</b>. Вход по рынку от <b>${f(res.entry)}</b>, SL — <b>${f(res.sl)}</b>, TP — <b>${f(res.tp)}</b>.</div>
    <div style="margin-top:4px;color:#94a3b8">Причины: ${(res.notes||[]).join('; ') || '—'}.</div>
  `;
}

// Wire up local search (robust: global function + event listeners + collapse on empty)
window.agent_panel_run = async function agent_panel_run() {
  const input = document.getElementById('agentSearchInput');
  const out   = document.getElementById('agentOut');
  const btn   = document.getElementById('agentSearchBtn');
  if (!input || !out) return;
  const raw = (input.value||'').trim();
  if (!raw) {
    // collapse to default state
    out.textContent = 'Введите тикер и нажмите «Найти» — получите ЛОНГ/ШОРТ, Entry/SL/TP, RR, ATR и причины.';
    if (btn) btn.disabled = true;
    return;
  }
  const sym = (raw.endsWith('USDT') ? raw : raw ? raw+'USDT' : 'BTCUSDT').toUpperCase();
  const pAgent = document.getElementById('agentPanel'); if(pAgent){ const w=pAgent.querySelector('.mob-agent-warn'); if(w) w.remove(); } out.textContent = 'Анализирую…';
  if (btn) btn.disabled = true;
  try {
    const res = await AGENT_run(sym);
    AGENT_render(res);
  } catch(e) {
    out.innerHTML = '<span style="color:#f87171">Ошибка: '+(e.message||e)+'</span>';
  } try{ const pAgent2=document.getElementById('agentPanel'); if(pAgent2){ const w2=pAgent2.querySelector('.mob-agent-warn'); if(w2) w2.remove(); } }catch(_){} finally {
    if (btn) btn.disabled = false;
  }
};

(function attach_agent_panel_listeners(){
  try{
    const input = document.getElementById('agentSearchInput');
    const btn   = document.getElementById('agentSearchBtn');
    const out   = document.getElementById('agentOut');
    if (btn) btn.addEventListener('click', window.agent_panel_run);
    if (input) {
      input.addEventListener('keydown', ev=>{ if (ev.key==='Enter') window.agent_panel_run(); });
      // collapse/restore on input
      input.addEventListener('input', ()=>{
        const val = (input.value||'').trim();
        if (!val) {
          out.textContent = 'Введите тикер и нажмите «Найти» — получите ЛОНГ/ШОРТ, Entry/SL/TP, RR, ATR и причины.';
          if (btn) btn.disabled = true;
        } else {
          if (btn) btn.disabled = false;
        }
      });
      // initialize disabled state
      const initVal = (input.value||'').trim();
      if (btn) btn.disabled = !initVal;
      if (!initVal) out.textContent = 'Введите тикер и нажмите «Найти» — получите ЛОНГ/ШОРТ, Entry/SL/TP, RR, ATR и причины.';
    }
  }catch(_){}
})();

document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const input = document.getElementById('agentSearchInput');
    const btn   = document.getElementById('agentSearchBtn');
    const out   = document.getElementById('agentOut');
    if (btn && !btn._bound){ btn.addEventListener('click', window.agent_panel_run); btn._bound=true; }
    if (input && !input._bound){
      input.addEventListener('keydown', ev=>{ if (ev.key==='Enter') window.agent_panel_run(); });
      input.addEventListener('input', ()=>{
        const val = (input.value||'').trim();
        if (!val) {
          out.textContent = 'Введите тикер и нажмите «Найти» — получите ЛОНГ/ШОРТ, Entry/SL/TP, RR, ATR и причины.';
          if (btn) btn.disabled = true;
        } else {
          if (btn) btn.disabled = false;
        }
      });
      input._bound=true;
      // initialize
      const initVal = (input.value||'').trim();
      if (btn) btn.disabled = !initVal;
      if (!initVal) out.textContent = 'Введите тикер и нажмите «Найти» — получите ЛОНГ/ШОРТ, Entry/SL/TP, RR, ATR и причины.';
    }
  }catch(_){
  }
});
</script>
<script>
const OI_FORCE_PROXY = (localStorage.getItem('force_proxy_oi')==='1');
function __wraps(url){
  const arr = [ (u)=>u, (u)=>'https://cors.isomorphic-git.org/'+u, (u)=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u), (u)=>'https://corsproxy.io/?'+encodeURIComponent(u) ];
  return (OI_FORCE_PROXY || location.protocol==='file:') ? arr.slice(1) : arr;
}
async function OI_fetchNow(symbol){
  const base = 'https://fapi.binance.com/fapi/v1/openInterest?symbol='+encodeURIComponent(symbol);
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (j && j.openInterest!=null) return { oi:Number(j.openInterest), time:j.time||Date.now() };
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('OI fetch failed');
}
async function OI_fetchHist(symbol, period='5m', limit=2){
  const base = `https://www.binance.com/futures/data/openInterestHist?symbol=${symbol}&period=${period}&limit=${limit}`;
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (Array.isArray(j)) return j.map(x=>({ t:Number(x.timestamp||x.time||0), oi:Number(x.sumOpenInterest||x.openInterest||x.oi||0) }));
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('OI hist failed');
}
async function OI_fetchTaker(symbol, period='5m', limit=1){
  const base = `https://www.binance.com/futures/data/takerlongshortRatio?symbol=${symbol}&period=${period}&limit=${limit}`;
  let lastErr=null;
  for(const wrap of __wraps(base)){
    try{
      const r = await fetch(wrap(base), {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (Array.isArray(j) && j.length){
        const it = j[j.length-1];
        return { buy:Number(it.buyVol||it.buy), sell:Number(it.sellVol||it.sell), t:Number(it.timestamp||it.time||0) };
      }
    }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('taker failed');
}
</script>
<script>
function OI_fmtNum(x){ return Number(x).toLocaleString('en-US',{maximumFractionDigits:0}); }

function OI_setPeriod(p){
  const allowed = new Set(['1m','5m','15m']);
  if(!allowed.has(p)) return;
  state.oiPeriod = p;
  // toggle active class
  [['1m','oiP_1m'],['5m','oiP_5m'],['15m','oiP_15m']].forEach(([val,id])=>{
    const btn = document.getElementById(id);
    if (!btn) return;
    if (val===p) btn.classList.add('active'); else btn.classList.remove('active');
  });
  if (state.selected) OI_updateFloat(state.selected);
}
async function OI_updateFloat(sym){ const period = (state.oiPeriod||'5m');
  const box = document.getElementById('oiFloat');
  const closeBtn = document.getElementById('oiF_close');
  if (closeBtn && !closeBtn._bound) { closeBtn.addEventListener('click', ()=> box.classList.add('hidden')); closeBtn._bound=true; }

  
    const buyLbl = document.getElementById('oiF_buyLbl');
    const sellLbl = document.getElementById('oiF_sellLbl');
    if (buyLbl) buyLbl.textContent = `Taker Buy (${period})`;
    if (sellLbl) sellLbl.textContent = `Taker Sell (${period})`;
    try{
    const [now, hist, taker] = await Promise.allSettled([
      OI_fetchNow(sym), OI_fetchHist(sym,period,50), OI_fetchTaker(sym,period,1)
    ]);
    let oiNow = (now.status==='fulfilled') ? now.value.oi : NaN;
    let oiPrev = NaN;
    if (hist.status==='fulfilled' && Array.isArray(hist.value) && hist.value.length>=2){
      const arr = hist.value;
      const last = arr[arr.length-1].oi;
      const prev = arr[arr.length-2].oi;
      if (!Number.isFinite(oiNow)) oiNow = last;
      oiPrev = prev;
    }
    const buy = taker.status==='fulfilled' ? taker.value.buy : NaN;
    const sell = taker.status==='fulfilled' ? taker.value.sell : NaN;
    const total = (Number.isFinite(buy)?buy:0) + (Number.isFinite(sell)?sell:0);
    const pBuy = total>0 ? (buy/total*100) : NaN;
    const pSell = total>0 ? (sell/total*100) : NaN;
    const dOI = (Number.isFinite(oiNow)&&Number.isFinite(oiPrev)) ? (oiNow-oiPrev) : NaN;
    const dPct = (Number.isFinite(oiNow)&&Number.isFinite(oiPrev) && oiPrev>0) ? (dOI/oiPrev*100) : NaN;
    const ts = (now.status==='fulfilled' && now.value.time) || (taker.status==='fulfilled' && taker.value.t) || Date.now();

    document.getElementById('oiF_sym').textContent = sym;
    document.getElementById('oiF_buy').textContent = Number.isFinite(buy)? OI_fmtNum(buy) : '—';
    document.getElementById('oiF_sell').textContent = Number.isFinite(sell)? OI_fmtNum(sell) : '—';
    document.getElementById('oiF_buyPct').textContent  = Number.isFinite(pBuy)? `(${pBuy.toFixed(1)}%)` : '';
    document.getElementById('oiF_sellPct').textContent = Number.isFinite(pSell)? `(${pSell.toFixed(1)}%)` : '';
    document.getElementById('oiF_total').textContent = total>0 ? OI_fmtNum(total) : '—';
    document.getElementById('oiF_now').textContent = Number.isFinite(oiNow)? OI_fmtNum(oiNow) : '—';
    const elD = document.getElementById('oiF_delta');
    elD.textContent = Number.isFinite(dOI) ? `${dOI>=0?'+':''}${OI_fmtNum(dOI)} ${Number.isFinite(dPct)?'('+(dPct>=0?'+':'')+dPct.toFixed(2)+'%)':''}` : '—';
    elD.className = 'font-mono text-sm ' + (Number.isFinite(dOI) ? (dOI>=0?'text-green-400':'text-red-400') : 'text-slate-300');
    document.getElementById('oiF_ts').textContent = new Date(ts).toLocaleString();

    box.classList.remove('hidden');
  }catch(e){
    document.getElementById('oiF_sym').textContent = sym;
    document.getElementById('oiF_buy').textContent = '—';
    document.getElementById('oiF_sell').textContent = '—';
    document.getElementById('oiF_buyPct').textContent  = '';
    document.getElementById('oiF_sellPct').textContent = '';
    document.getElementById('oiF_total').textContent = '—';
    document.getElementById('oiF_now').textContent = '—';
    document.getElementById('oiF_delta').textContent = '—';
    document.getElementById('oiF_delta').className = 'font-mono text-sm text-slate-300';
    document.getElementById('oiF_ts').textContent = new Date().toLocaleString();
    box.classList.remove('hidden');
  }
}
</script>
<script>
// Robust sync on click: TV + OI + Agent
document.addEventListener('DOMContentLoaded', ()=>{
  const root = document.getElementById('screenerList');
  if (!root) return;
  root.addEventListener('click', (ev)=>{
    const n = ev.target.closest('[data-sym],[data-symbol]'); if (!n) return;
    const s = n.getAttribute('data-sym') || n.getAttribute('data-symbol'); if (!s) return;
    try{ if (window.renderTV) renderTV(s); }catch(_){}
    try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
    const agIn = document.getElementById('agentSearchInput');
    if (agIn){ agIn.value = s; }
    if (window.agent_panel_run) window.agent_panel_run();
    try{ if (window.state){ window.state.selected = s; if (window.renderHeader) renderHeader(); } }catch(_){}
  }, {passive:true});
});
</script>
<script>
// ---- Runtime '' module (filters + autoscan + heatmap) ----
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.querySelector('[data-tool="signals"]');
  if (btn) btn.textContent = '';
});
const A_sma=(a,p)=>{const t=a.slice(-p);return t.reduce((x,y)=>x+y,0)/(t.length||1)};
function A_atr(kl,p=20){
  if (!kl || kl.length < p+1) return {atr:NaN, trs:[]};
  let trs=[];
  for(let i=1;i<kl.length;i++){
    const hi=+kl[i][2], lo=+kl[i][3], pc=+kl[i-1][4];
    trs.push(Math.max(hi-lo, Math.abs(hi-pc), Math.abs(lo-pc)));
  }
  let avg=0; for(let i=0;i<p;i++) avg+=trs[i]; avg/=p;
  for(let i=p;i<trs.length;i++) avg=(avg*(p-1)+trs[i])/p;
  return {atr:avg, trs};
}
async function A_fetch24hr(){
  const base = 'https://fapi.binance.com/fapi/v1/ticker/24hr';
  const ways=[base, 'https://cors.isomorphic-git.org/'+base, 'https://corsproxy.io/?'+encodeURIComponent(base)];
  for(const u of ways){
    try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) continue; const j=await r.json(); if(Array.isArray(j)) return j; }catch(_){}
  } throw new Error('24hr unavailable');
}
async function A_fetchKlines(symbol, interval, limit=288){
  const base = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
  const ways=[base, `https://isomorphic-git.org/cors/${base}`, `https://cors.isomorphic-git.org/${base}`, `https://corsproxy.io/?${encodeURIComponent(base)}`];
  for(const u of ways){
    try{ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) continue; const j=await r.json(); if(Array.isArray(j)) return j; }catch(_){}
  } throw new Error('klines unavailable '+symbol);
}
function A_scanAnoms(kl){
  const rows = kl.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4], v:+k[5]}));
  const vols=rows.map(r=>r.v);
  const {atr:ATR, trs} = A_atr(kl,20);
  const volAvg = A_sma(vols,20);
  let best=null, score=0, flagsBest=null;
  for(let i=1;i<rows.length;i++){
    const r=rows[i], p=rows[i-1];
    const chg = (r.c - p.c)/p.c * 100;
    const tr  = trs[i-1] || 0;
    const fchg = Math.abs(chg) >= 3;
    const fvol = r.v >= 3*volAvg;
    const fatr = Number.isFinite(ATR) && ATR>0 && tr >= 2*ATR;
    if (fchg || fvol || fatr){
      const s = (fvol?1.2:0) + (fatr?1.0:0) + (fchg?0.8:0);
      if (!best || r.t > best.time){
        best = { time:r.t, change:chg, range:(r.h-r.l)/p.c*100, volume:r.v };
        flagsBest = { fchg, fvol, fatr, note: [
          fchg ? `Δ ${chg.toFixed(2)}%` : null,
          fvol ? `V ×${(r.v/volAvg).toFixed(1)}` : null,
          fatr ? `ATR ×${(tr/ATR).toFixed(1)}` : null,
        ].filter(Boolean).join(' · ') };
      }
      score = Math.max(score, s);
    }
  }
  if (!best) return null;
  return { ...best, ...flagsBest, score };
}
function openAllHook(scope){
  scope.querySelectorAll('[data-open]').forEach(b=>{
    b.onclick = ()=>{
      const s = b.getAttribute('data-open');
      try{ if (window.renderTV) renderTV(s); }catch(_){}
      try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
      const agIn=document.getElementById('agentSearchInput'); if (agIn){ agIn.value=s; }
      if (window.agent_panel_run) window.agent_panel_run();
      if (window.state){ state.selected=s; if (window.renderHeader) renderHeader(); }
    };
  });
}
const badgeUpdate = (n)=>{
  const btn = document.querySelector('[data-tool="signals"]');
  if (btn) btn.textContent = ` (${n})`;
};
function heat(score){
  const x = Math.max(0, Math.min(1, score/3));
  const a = 0.12 + 0.28*x;
  const h = 210*(1-x);
  return `hsla(${h}, 90%, 40%, ${a})`;
}

window.renderToolSignals = async function renderToolSignals(){
  const elTools = document.getElementById('toolsContent') || (window.el && window.el.toolsContent);
  if (!elTools) return;
  elTools.innerHTML = `
    <div class="mb-2 flex flex-wrap items-center gap-3">
      <span class="text-slate-300"> (24ч)</span>
      <label class="text-slate-400 text-sm">TF:
        <select id="anomTF" class="input w-24" style="color:#000;background:#fff">
          <option value="5m" selected>5m</option>
          <option value="15m">15m</option>
        </select>
      </label>
      <label class="text-slate-400 text-sm">Топ:
        <select id="anomN" class="input w-24" style="color:#000;background:#fff">
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="50">50</option>
        </select>
      </label>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-400">Фильтр:</span>
        <label class="flex items-center gap-1"><input id="fChg" type="checkbox" checked> Δ%</label>
        <label class="flex items-center gap-1"><input id="fVol" type="checkbox" checked> Объём</label>
        <label class="flex items-center gap-1"><input id="fAtr" type="checkbox" checked> ATR</label>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-400">Авто:</span>
        <select id="anomAuto" class="input w-28" style="color:#000;background:#fff">
          <option value="0" selected>Выкл</option>
          <option value="5">каждые 5м</option>
          <option value="10">каждые 10м</option>
        </select>
      </div>
      <button id="anomScan" class="btn" type="button">Сканировать</button>
    </div>
    <div id="anomListWrap" class="text-slate-400" style="overflow-y:auto; overflow-y:auto; border:1px solid #1f2937; border-radius:12px;"></div>`;

  let timer=null, lastResults=[];
  let sortKey = 'score', sortDir = -1;

  function setViewportTo10Rows(){
    const wrap = document.getElementById('anomListWrap');
    const firstRow = wrap.querySelector('tbody tr');
    const thead = wrap.querySelector('thead');
    if (!firstRow) return;
    const rh = firstRow.getBoundingClientRect().height || 40;
    const hh = thead ? (thead.getBoundingClientRect().height||28) : 28;
    wrap.style.maxHeight = Math.round(rh*10 + hh + 10) + 'px';
  }

  function renderTable(list){
    const fChg = document.getElementById('fChg').checked;
    const fVol = document.getElementById('fVol').checked;
    const fAtr = document.getElementById('fAtr').checked;
    let results = list.filter(it => (fChg && it.fchg) || (fVol && it.fvol) || (fAtr && it.fatr));

    const get = (it)=>{
      if (sortKey==='symbol') return it.symbol;
      if (sortKey==='time') return it.time;
      if (sortKey==='change') return it.change;
      if (sortKey==='range') return it.range;
      if (sortKey==='volume') return it.volume;
      return it.score;
    };
    results = results.slice().sort((a,b)=>{
      const A = get(a), B = get(b);
      if (A<B) return -1*sortDir;
      if (A>B) return  1*sortDir;
      return (b.time - a.time);
    });

    const rows = results.map((it,i)=>{
      const dt = new Date(it.time).toLocaleString('ru-RU');
      const dirArrow = it.change>=0 ? '⬆️' : '⬇️';
      const bg = heat(it.score);
      return `<tr >
        <td class="text-slate-300">${i+1}</td>
        <td class="text-slate-100 font-medium">${it.symbol}</td>
        <td class="text-slate-200">${dt}</td>
        <td class="text-slate-200">${dirArrow} ${it.change.toFixed(2)}%</td>
        <td class="text-slate-200">${it.range.toFixed(2)}%</td>
        <td class="text-slate-200">${Number(it.volume).toLocaleString('ru-RU')}</td>
        <td class="text-slate-100">${it.note}</td>
        <td><button class="btn btn-xs" data-open="${it.symbol}">Открыть</button></td>
      </tr>`;
    }).join('');

    const wrap = document.getElementById('anomListWrap');
    wrap.innerHTML = `<table class="w-full text-sm">
      <thead class="sticky top-0 bg-slate-900/80 backdrop-blur">
        <tr>
          <th data-sort="rank"   class="cursor-pointer">#</th>
          <th data-sort="symbol" class="cursor-pointer">Тикер</th>
          <th data-sort="time"   class="cursor-pointer">Время</th>
          <th data-sort="change" class="cursor-pointer">Δ%</th>
          <th data-sort="range"  class="cursor-pointer">Диапазон%</th>
          <th data-sort="volume" class="cursor-pointer">Объём</th>
          <th>Факторы</th><th></th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;

    wrap.querySelectorAll('th[data-sort]').forEach(th=>{
      th.onclick = ()=>{
        const k = th.getAttribute('data-sort');
        if (k==='rank'){ sortKey='score'; sortDir=-1; }
        else { sortKey=k; sortDir = (sortKey===k) ? -sortDir : -1; }
        renderTable(results);
      };
    });

    document.querySelectorAll('[data-open]').forEach(b=>{
      b.onclick = ()=>{
        const s=b.getAttribute('data-open');
        try{ if (window.renderTV) renderTV(s); }catch(_){}
        try{ if (window.OI_updateFloat) OI_updateFloat(s); }catch(_){}
        const agIn=document.getElementById('agentSearchInput'); if (agIn){ agIn.value=s; }
        if (window.agent_panel_run) window.agent_panel_run();
        if (window.state){ state.selected=s; if (window.renderHeader) renderHeader(); }
      };
    });

    badgeUpdate(results.length);
    setViewportTo10Rows();
    window.addEventListener('resize', setViewportTo10Rows, {passive:true});
  }

  async function scanMarket(){
    const tf = document.getElementById('anomTF').value || '5m';
    const N  = parseInt(document.getElementById('anomN').value || '30',10);
    const wrap = document.getElementById('anomListWrap');
    wrap.textContent = 'Сканирую рынок…';
    try{
      const all = await A_fetch24hr();
      let symbols = all
        .filter(x => x.symbol && x.symbol.endsWith('USDT') && !/UPUSDT|DOWNUSDT|BULL|BEAR|[0-9]SUSDT|[0-9]LUSDT/.test(x.symbol))
        .sort((a,b)=> (+b.quoteVolume) - (+a.quoteVolume))
        .slice(0, N)
        .map(x=>x.symbol);
      if (window.state && Array.isArray(state.list) && state.list.length){
        const set = new Set(symbols);
        const ordered = state.list.filter(s => set.has(s)).slice(0,N);
        if (ordered.length) symbols = ordered;
      }
      const limit = tf==='5m' ? 288 : 200;
      const pool = 5;
      let i=0, results=[];
      async function worker(){
        while(i < symbols.length){
          const s = symbols[i++];
          try{
            const kl = await A_fetchKlines(s, tf, limit);
            const ev = A_scanAnoms(kl);
            if (ev) results.push({ symbol:s, ...ev });
          }catch(_){}
        }
      }
      await Promise.all(Array.from({length:pool}, worker));
      results.sort((a,b)=> (b.score - a.score) || (b.time - a.time));
      renderTable(results);
    }catch(e){
      document.getElementById('anomListWrap').innerHTML = '<span class="text-red-400">Ошибка: '+(e.message||e)+'</span>';
    }
  }

  document.getElementById('anomScan').onclick = scanMarket;
  ['fChg','fVol','fAtr'].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=> scanMarket());
  });
  function applyAuto(){
    if (window._anomTimer) { clearInterval(window._anomTimer); window._anomTimer=null; }
    const mins = parseInt(document.getElementById('anomAuto').value,10);
    if (mins>0){
      window._anomTimer = setInterval(scanMarket, mins*60*1000);
    }
  }
  document.getElementById('anomAuto').addEventListener('change', applyAuto);
  scanMarket();
  applyAuto();
};
</script>
<script>
// ==== Unified appSelectSymbol(s) — один вход для TV + OI + Агент ====
(function(){
  // отмена/дебаунс возможных конкурирующих вызовов
  let oiTimer = null;
  window.appSelectSymbol = function(symbolRaw){
    if (!symbolRaw) return;
    let s = (''+symbolRaw).trim().toUpperCase();
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';

    // обновляем глобальное состояние/хедер
    try { if (window.state){ state.selected = s; if (window.renderHeader) renderHeader(); } } catch(_){}

    // график
    try { if (window.renderTV) renderTV(s); } catch(_){}

    // OI — лёгкий дебаунс, чтобы не дергать API дважды при двойных событиях
    if (oiTimer) clearTimeout(oiTimer);
    oiTimer = setTimeout(()=>{
      try { if (window.OI_updateFloat) OI_updateFloat(s); } catch(_){}
    }, 50);

    // агент
    try {
      const agIn = document.getElementById('agentSearchInput');
      if (agIn){ agIn.value = s; }
      if (window.agent_panel_run) window.agent_panel_run();
    } catch(_){}
  };
})();
</script>
<script>
// Screener/Top → appSelectSymbol (надёжный делегат)
document.addEventListener('DOMContentLoaded', ()=>{
  const root = document.getElementById('screenerList');
  if (!root) return;
  root.addEventListener('click', (ev)=>{
    const n = ev.target.closest('[data-sym],[data-symbol]');
    if (!n) return;
    const s = n.getAttribute('data-sym') || n.getAttribute('data-symbol');
    if (s && window.appSelectSymbol) appSelectSymbol(s);
  }, {passive:true});
});
</script>
<script>
// Верхний поиск → appSelectSymbol; при очистке сворачиваем совет агента (если есть функция)
(function(){
  function findInputs(){
    const set = new Set();
    const sels = [
      '#globalSearch', '#searchInput', '#pairSearch', '#searchTop',
      'header input[type="search"]', 'input[type="search"]',
      'input[placeholder*="BTC"]', 'input[placeholder*="Найти"]', 'input[placeholder*="Поиск"]'
    ];
    sels.forEach(sel => document.querySelectorAll(sel).forEach(el => set.add(el)));
    return Array.from(set);
  }
  function findButtons(inp){
    const res=[];
    const parent = (inp && inp.closest('form,div,section,header')) || document.body;
    parent.querySelectorAll('button, input[type="submit"]').forEach(b=>{
      const t = (b.value || b.textContent || '').trim();
      if (/^(Найти|Search)$/i.test(t)) res.push(b);
    });
    return res;
  }
  function submit(val){
    const q = (val||'').trim();
    if (!q){
      try{ if (window.agent_panel_collapse) agent_panel_collapse(); }catch(_){}
      return;
    }
    if (window.appSelectSymbol) appSelectSymbol(q);
  }
  function wireOne(inp){
    if (!inp || inp.dataset.wiredTopSearch) return;
    inp.dataset.wiredTopSearch = '1';
    // читаемый инпут
    inp.style.color='#000'; if (!inp.style.background) inp.style.background='#fff';
    inp.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); submit(inp.value); }});
    inp.addEventListener('input', ()=>{
      if (!inp.value.trim()){
        try{ if (window.agent_panel_collapse) agent_panel_collapse(); }catch(_){}
      }
    });
    findButtons(inp).forEach(btn=>{
      if (!btn.dataset.wiredTopSearch){
        btn.dataset.wiredTopSearch='1';
        btn.addEventListener('click', (e)=>{ e.preventDefault(); submit(inp.value); });
      }
    });
  }
  function wireAll(){ findInputs().forEach(wireOne); }
  document.addEventListener('DOMContentLoaded', wireAll);
  let i=0, t=setInterval(()=>{ wireAll(); if (++i>20) clearInterval(t); }, 300);
})();
</script>
<script>
// : делегирование на «Открыть» → appSelectSymbol
document.addEventListener('DOMContentLoaded', ()=>{
  const wrap = document.getElementById('anomListWrap');
  if (!wrap) return;
  wrap.addEventListener('click', (ev)=>{
    const b = ev.target.closest('[data-open]');
    if (!b) return;
    const s = b.getAttribute('data-open');
    if (s && window.appSelectSymbol) appSelectSymbol(s);
  });
});
</script>
<script>
// Top search direct hook → appSelectSymbol
document.addEventListener('DOMContentLoaded', ()=>{
  const ids = ['globalSearch','searchInput','pairSearch','searchTop'];
  ids.forEach(id=>{
    const inp = document.getElementById(id);
    if (!inp || inp.dataset.topHooked) return;
    inp.dataset.topHooked='1';
    inp.style.color='#000'; if (!inp.style.background) inp.style.background='#fff';
    const submit = ()=>{ const v = (inp.value||'').trim(); if (v && window.appSelectSymbol) appSelectSymbol(v); };
    inp.addEventListener('keydown', e=>{ if (e.key==='Enter'){ e.preventDefault(); submit(); }});
  });
});
</script>
<script>
// === FORCE Volumes Clickability (works even with dynamic render) ===
(function(){
  function normalize(sym){
    if (!sym) return null;
    let s = (''+sym).trim().toUpperCase();
    s = s.replace(/\s+/g,'');
    s = s.replace('/', ''); // BTC/USDT -> BTCUSDT
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';
    s = s.replace(/[^A-Z0-9]/g,'');
    if (!/^[A-Z0-9]{3,}$/.test(s)) return null;
    return s;
  }
  function findSymFromNode(node){
    if (!node) return null;
    let cur = node;
    for (let i=0;i<5 && cur;i++){
      if (cur.getAttribute){
        const s = cur.getAttribute('data-sym') || cur.getAttribute('data-symbol') || cur.getAttribute('data-ticker');
        if (s) return normalize(s);
      }
      cur = cur.parentElement;
    }
    const row = node.closest('tr, .row, .item, li, div');
    const txt = (row ? row.innerText : node.innerText) || '';
    const pats = [/([A-Z0-9]{2,})\s*\/\s*USDT/, /([A-Z0-9]{2,})USDT/, /\b([A-Z]{2,10})\b/];
    for (const rx of pats){
      const m = txt.toUpperCase().match(rx);
      if (m && m[1]){
        const sym = normalize(m[1] + (m[0].includes('USDT') ? '' : 'USDT'));
        if (sym) return sym;
      }
    }
    return null;
  }
  function inVolumesSection(node){
    const sec = node.closest('#volumesList, #volumeList, #volumesTable, #volumeTable, [data-tool=\"volumes\"], [data-panel=\"volumes\"], .volumes');
    if (sec) return sec;
    const box = node.closest('section,div,table');
    if (!box) return null;
    const head = (box.querySelector('h2,h3,h4,.title,.header')||{}).textContent || '';
    if (/объ[eё]м/i.test(head)) return box;
    return null;
  }
  function handleClick(ev){
    const sec = inVolumesSection(ev.target);
    if (!sec) return;
    const sym = findSymFromNode(ev.target);
    if (!sym) return;
    ev.preventDefault();
    if (window.appSelectSymbol) appSelectSymbol(sym);
  }
  document.addEventListener('click', handleClick, {passive:false});
  const css = document.createElement('style');
  css.textContent = `
    #volumesList [data-sym], #volumesList [data-symbol], #volumesList [data-ticker],
    #volumeList [data-sym], #volumeList [data-symbol], #volumeList [data-ticker],
    #volumesTable [data-sym], #volumesTable [data-symbol], #volumesTable [data-ticker],
    #volumeTable [data-sym], #volumeTable [data-symbol], #volumeTable [data-ticker],
    [data-tool="volumes"] [data-sym], [data-tool="volumes"] [data-symbol], [data-tool="volumes"] [data-ticker],
    .volumes [data-sym], .volumes [data-symbol], .volumes [data-ticker] { cursor: pointer; text-decoration: none; }
  `;
  document.head.appendChild(css);
})();
</script>
<script>
// --- Volumes table: make ONLY the ticker cell clickable (robust) ---
(function(){
  function normalize(sym){
    if (!sym) return null;
    let s = (''+sym).trim().toUpperCase();
    s = s.replace(/\s+/g,'');
    s = s.replace('/', '');
    if (/PERP$/.test(s)) s = s.replace(/PERP$/,'');
    if (!/USDT$/.test(s)) s = s + 'USDT';
    s = s.replace(/[^A-Z0-9]/g,'');
    return s;
  }
  function markTickersInVolumes(root){
    if (!root) return;
    // find tables that have header "Пара"
    const tables = Array.from(root.querySelectorAll('table')).filter(tb=>{
      const ths = Array.from(tb.querySelectorAll('thead th')).map(th=>(th.textContent||'').trim());
      return ths.some(t=>/^пара$/i.test(t)) && ths.some(t=>/объ.?м/i.test(t));
    });
    tables.forEach(tb=>{
      const rows = tb.querySelectorAll('tbody tr');
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if (tds.length < 2) return;
        const cell = tds[1]; // колонка "Пара"
        const text = (cell.textContent||'').trim();
        const sym = normalize(text);
        if (!sym) return;
        cell.dataset.ticker = sym;
        cell.classList.add('volumes-ticker');
        if (!cell.dataset.clickWired){
          cell.dataset.clickWired = '1';
          cell.style.cursor = 'pointer';
          cell.addEventListener('click', (e)=>{
            e.preventDefault();
            if (window.appSelectSymbol) appSelectSymbol(sym);
          });
        }
      });
    });
  }
  function setup(){
    const containers = [
      document.getElementById('volumesList'),
      document.getElementById('volumeList'),
      document.getElementById('volumesTable'),
      document.getElementById('volumeTable'),
      document.querySelector('[data-tool="volumes"]'),
      document.querySelector('[data-panel="volumes"]'),
      document.getElementById('toolsContent')
    ].filter(Boolean);
    containers.forEach(markTickersInVolumes);

    // Observe dynamic updates
    const host = document.getElementById('toolsContent') || document.body;
    const mo = new MutationObserver(()=>{
      containers.forEach(markTickersInVolumes);
    });
    mo.observe(host, {childList:true, subtree:true});
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setup();
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const b1=document.getElementById('oiP_1m');
  const b5=document.getElementById('oiP_5m');
  const b15=document.getElementById('oiP_15m');
  if(b1 && !b1._oiBound){ b1.addEventListener('click', ()=>OI_setPeriod('1m')); b1._oiBound=true; }
  if(b5 && !b5._oiBound){ b5.addEventListener('click', ()=>OI_setPeriod('5m')); b5._oiBound=true; }
  if(b15 && !b15._oiBound){ b15.addEventListener('click', ()=>OI_setPeriod('15m')); b15._oiBound=true; }
});
</script>
<script>
// ===== Agent: auto-refresh every 5s with toggle; sticky open; live price coloring =====
(function(){
  const STATE = { enabled:false, timer:null, lastPrice:null, lastSym:null };
  function getAgentBox(){
    return document.getElementById('agentAdvice') ||
           document.querySelector('#agentPanel, .agent-panel, [data-role="agent"]') ||
           document.querySelector('.agent');
  }
  function getAgentInput(){
    return document.getElementById('agentSearchInput') ||
           document.querySelector('[data-role="agent-search"] input') ||
           document.querySelector('#toolsContent input[type="search"]');
  }
  function runAgentSoft(){
    const box = getAgentBox(); if (!box) return;
    // keep height to avoid flicker
    const h = box.getBoundingClientRect().height;
    box.style.minHeight = h ? (h + 'px') : box.style.minHeight;
    // remember symbol
    const inp = getAgentInput();
    STATE.lastSym = inp ? (inp.value||'').trim() : STATE.lastSym;
    // call agent
    try{ if (window.agent_panel_run) agent_panel_run(); }catch(e){}
    // update colors after re-render
    setTimeout(()=>{
      softColorize();
      // release minHeight a bit later
      setTimeout(()=>{ box.style.minHeight = ''; }, 120);
    }, 250);
  }
  function softColorize(){
    const box = getAgentBox(); if (!box) return;
    // Try common ids/classes for live price
    const priceEl = box.querySelector('#agentPrice, .agent-price, [data-field="price"], .price, .last-price');
    if (!priceEl) return;
    const txt = (priceEl.textContent||'').replace(/[^\d\.\-]/g,'');
    const val = parseFloat(txt);
    if (!isFinite(val)) return;
    if (STATE.lastPrice != null){
      const up = val > STATE.lastPrice;
      const down = val < STATE.lastPrice;
      priceEl.style.transition = 'color 0.2s ease';
      if (up){ priceEl.style.color = '#22c55e'; }      // green-500
      else if (down){ priceEl.style.color = '#ef4444'; } // red-500
    }
    STATE.lastPrice = val;
  }
  function toggleAuto(){
    STATE.enabled = !STATE.enabled;
    const btn = document.getElementById('agentAutoBtn');
    if (btn){ btn.textContent = STATE.enabled ? 'Авто 5с: ВЫКЛ' : 'Авто 5с: ВКЛ'; }
    if (STATE.timer){ clearInterval(STATE.timer); STATE.timer=null; }
    if (STATE.enabled){
      runAgentSoft();
      STATE.timer = setInterval(runAgentSoft, 5000);
    }
  }
  
  function injectToggle(){
    if (document.getElementById('agentAutoBtn')) return;
    const inp = getAgentInput();
    const btn = document.createElement('button');
    btn.id = 'agentAutoBtn';
    btn.type = 'button';
    btn.className = 'btn';
    btn.textContent = 'Авто 5с: ВКЛ';
    btn.addEventListener('click', toggleAuto, {passive:true});
    if (inp && inp.parentElement){
      inp.parentElement.appendChild(btn);
    } else {
      const box = getAgentBox();
      if (box && box.parentElement) box.parentElement.insertBefore(btn, box);
    }
  }

  }
  // Keep panel open: add sticky class (for apps где совет сворачивается)
  function keepOpen(){
    const box = getAgentBox();
    if (box){ box.classList.add('agent-sticky-open'); }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    injectToggle();
    keepOpen();
  });
  // re-attach if UI re-renders
  let tries=0; const t=setInterval(()=>{ injectToggle(); if (++tries>20) clearInterval(t); }, 300);
  // When user selects a ticker elsewhere, reset lastPrice so color compares correctly
  window.addEventListener('appSelectSymbol', ()=>{ STATE.lastPrice=null; }, {passive:true});
  // If your app calls appSelectSymbol(symbol) directly, we can hook it to dispatch the event
  if (window.appSelectSymbol && !window._agentHooked){
    const orig = window.appSelectSymbol;
    window.appSelectSymbol = function(s){
      try { window.dispatchEvent(new Event('appSelectSymbol')); }catch(e){}
      return orig.apply(this, arguments);
    };
    window._agentHooked = true;
  }
})();
</script>
<script>
// === Agent auto-refresh: 5s / 10с / 15с + Stop; цвета = как в OI; без мигания; статичный тикер ===
(function(){
  const STATE = { timer:null, interval:0, lastPrice:null };

  function $(sel,root=document){ return root.querySelector(sel); }
  function getAgentInput(){ return $('#agentSearchInput') || document.querySelector('[data-role="agent-search"] input'); }
  function getAgentBox(){ return $('#agentAdvice') || $('#agentPanel') || document.querySelector('.agent-panel, [data-role="agent"], .agent'); }
  function getTickerEl(b){ return b && (b.querySelector('#agentTicker, .agent-ticker, [data-field=\"symbol\"], .symbol, .ticker')); }
  function getPriceEl(b){ return b && (b.querySelector('#agentPrice, .agent-price, [data-field=\"price\"], .price, .last-price')); }

  function lockBox(box){
    if (!box) return;
    const h = box.getBoundingClientRect().height;
    box.style.minHeight = h ? (h+'px') : box.style.minHeight;
  }
  function unlockBox(box){ if (!box) return; setTimeout(()=>{ box.style.minHeight=''; }, 120); }

  function colorizePrice(box){
    const el = getPriceEl(box); if (!el) return;
    const v = parseFloat((el.textContent||'').replace(/[^\d\.\-]/g,''));
    if (!isFinite(v)) return;
    el.style.transition = 'color .2s ease';
    if (STATE.lastPrice!=null){
      if (v > STATE.lastPrice) el.style.color = '#22c55e'; // зелёный ↑
      else if (v < STATE.lastPrice) el.style.color = '#ef4444'; // красный ↓
    }
    STATE.lastPrice = v;
  }

  function runAgentSoft(){
    const box = getAgentBox(); if (!box) return;
    box.classList.add('agent-sticky-open'); // не сворачиваемся
    lockBox(box);

    const tEl = getTickerEl(box);
    const snap = tEl ? {
      text: tEl.textContent,
      fontSize: getComputedStyle(tEl).fontSize,
      fontWeight: getComputedStyle(tEl).fontWeight,
      lineHeight: getComputedStyle(tEl).lineHeight,
    } : null;

    try{ if (window.agent_panel_run) agent_panel_run(); }catch(_){}

    setTimeout(()=>{
      const box2 = getAgentBox() || box;
      if (snap){
        const el2 = getTickerEl(box2);
        if (el2){
          if (el2.textContent && el2.textContent.trim() === (snap.text||'').trim()){
            el2.style.fontSize   = snap.fontSize;
            el2.style.fontWeight = snap.fontWeight;
            el2.style.lineHeight = snap.lineHeight;
          }else if (snap.text){
            // если ререндер сменил текст, возвращаем прежний (тикер статичен визуально)
            el2.textContent = snap.text;
            el2.style.fontSize   = snap.fontSize;
            el2.style.fontWeight = snap.fontWeight;
            el2.style.lineHeight = snap.lineHeight;
          }
        }
      }
      colorizePrice(box2);
      unlockBox(box2);
    }, 250);
  }

  function stopAuto(){
    if (STATE.timer){ clearInterval(STATE.timer); STATE.timer=null; }
    STATE.interval = 0;
    highlightActive();
  }
  function startAuto(ms){
    stopAuto();
    STATE.interval = ms;
    runAgentSoft();
    STATE.timer = setInterval(runAgentSoft, ms);
    highlightActive();
  }

  function makeBtn(txt, ms){
    const b=document.createElement('button');
    b.className='agent-auto-btn btn btn-xs'; b.textContent=txt; b.dataset.ms = String(ms);
    b.addEventListener('click', ()=>{ if (STATE.interval===ms) stopAuto(); else startAuto(ms); });
    return b;
  }
  function makeStop(){
    const b=document.createElement('button');
    b.className='agent-auto-btn agent-auto-stop btn btn-xs'; b.textContent='✕';
    b.title='Остановить автообновление'; b.addEventListener('click', stopAuto); return b;
  }

  // Подгоняем стиль активной кнопки под кнопки тайминга в Open Interest
  function applyOIStyleToActive(){
    const group = document.getElementById('agentAutoGroup'); if (!group) return;
    // Находим эталонную кнопку в OI
    let oiBtn = document.querySelector('#oiPanel .btn.active, #oiPanel .btn-primary, [data-oi] .btn.active');
    if (!oiBtn) oiBtn = document.querySelector('#oiPanel .btn, [data-oi] .btn');
    if (!oiBtn) return;
    const cs = getComputedStyle(oiBtn);
    group.querySelectorAll('.agent-auto-btn.active').forEach(b=>{
      b.style.backgroundColor = cs.backgroundColor;
      b.style.borderColor = cs.borderColor || 'transparent';
      b.style.color = cs.color || '#fff';
      b.style.boxShadow = 'none';
    });
  }

  function highlightActive(){
    const group = document.getElementById('agentAutoGroup'); if (!group) return;
    group.querySelectorAll('.agent-auto-btn').forEach(btn=>{
      const ms = parseInt(btn.dataset.ms||'0',10);
      if (ms){ if (STATE.interval===ms) btn.classList.add('active'); else btn.classList.remove('active'); }
      if (!ms){ btn.classList.remove('active'); }
    });
    applyOIStyleToActive();
  }

  function injectUI(){
    if (document.getElementById('agentAutoGroup')) return;
    const inp = getAgentInput(); if (!inp) return;
    // Удалим старую кнопку, если была
    const old = document.getElementById('agentAutoBtn'); if (old) old.remove();
    const group = document.createElement('span');
    group.id='agentAutoGroup'; group.className='agent-auto-group';
    group.appendChild(makeBtn('5с', 5000));
    group.appendChild(makeBtn('10с', 10000));
    group.appendChild(makeBtn('15с', 15000));
    group.appendChild(makeStop());
    inp.parentElement ? inp.parentElement.appendChild(group) : inp.after(group);
    highlightActive();
  }

  document.addEventListener('DOMContentLoaded', ()=>{ injectUI(); highlightActive(); });
  let tries=0; const t=setInterval(()=>{ injectUI(); highlightActive(); if (++tries>20) clearInterval(t); }, 300);

  // Когда меняется тикер через appSelectSymbol — сбрасываем baseline цены
  if (window.appSelectSymbol && !window._agentAutoHookedFinal){
    const orig = window.appSelectSymbol;
    window.appSelectSymbol = function(s){ STATE.lastPrice=null; return orig.apply(this, arguments); };
    window._agentAutoHookedFinal = true;
  }
})();
</script>
<script>
// === Agent auto-refresh (5/10/15 + ✕): compact purple, panel always open, flash numbers only ===
(function(){
  const STATE = { timer:null, interval:0, lastPrice:null, guardOpen:true };

  function $(sel,root=document){ return root.querySelector(sel); }
  function getAgentInput(){ return $('#agentSearchInput') || document.querySelector('[data-role="agent-search"] input'); }
  function getAgentBox(){ return $('#agentAdvice') || $('#agentPanel') || document.querySelector('.agent-panel, [data-role="agent"], .agent'); }
  function getTickerEl(b){ return b && (b.querySelector('#agentTicker, .agent-ticker, [data-field=\"symbol\"], .symbol, .ticker')); }
  function getPriceEl(b){ return b && (b.querySelector('#agentPrice, .agent-price, [data-field=\"price\"], .price, .last-price')); }

  // Guard: keep panel open — temporarily neutralize collapse while auto is on
  function guardCollapse(enable){
    STATE.guardOpen = !!enable;
    if (!window._agentCollapsePatched){
      const original = window.agent_panel_collapse;
      window.agent_panel_collapse = function(){
        if (STATE.guardOpen) return; // ignore collapse while auto enabled
        if (typeof original === 'function') return original.apply(this, arguments);
      };
      window._agentCollapsePatched = true;
    }
  }

  function lockBox(box){
    if (!box) return;
    const h = box.getBoundingClientRect().height;
    if (h) box.style.minHeight = h + 'px';
  }
  function unlockBox(box){
    if (!box) return;
    setTimeout(()=>{ box.style.minHeight = ''; }, 120);
  }

  function flash(el, cls){
    if (!el) return;
    el.classList.remove('flash-green','flash-red');
    void el.offsetWidth;
    el.classList.add(cls);
    setTimeout(()=>{ el && el.classList.remove(cls); }, 450);
  }

  function colorizePrice(box){
    const el = getPriceEl(box); if (!el) return;
    const v = parseFloat((el.textContent||'').replace(/[^\d\.\-]/g,''));
    if (!isFinite(v)) return;
    if (STATE.lastPrice!=null){
      if (v > STATE.lastPrice) flash(el, 'flash-green');
      else if (v < STATE.lastPrice) flash(el, 'flash-red');
    }
    STATE.lastPrice = v;
  }

  function runAgentSoft(){
    const box = getAgentBox(); if (!box) return;
    box.classList.add('agent-sticky-open');
    lockBox(box);

    const tEl = getTickerEl(box);
    const snap = tEl ? {
      text: tEl.textContent,
      fontSize: getComputedStyle(tEl).fontSize,
      fontWeight: getComputedStyle(tEl).fontWeight,
      lineHeight: getComputedStyle(tEl).lineHeight,
    } : null;

    try{ if (window.agent_panel_run) agent_panel_run(); }catch(_){}

    setTimeout(()=>{
      const box2 = getAgentBox() || box;
      if (snap){
        const el2 = getTickerEl(box2);
        if (el2){
          el2.textContent = snap.text || el2.textContent;
          el2.style.fontSize   = snap.fontSize;
          el2.style.fontWeight = snap.fontWeight;
          el2.style.lineHeight = snap.lineHeight;
        }
      }
      colorizePrice(box2);
      unlockBox(box2);
    }, 220);
  }

  function stopAuto(){
    if (STATE.timer){ clearInterval(STATE.timer); STATE.timer=null; }
    STATE.interval = 0;
    guardCollapse(false);
    highlightActive();
  }
  function startAuto(ms){
    stopAuto();
    STATE.interval = ms;
    guardCollapse(true);
    runAgentSoft();
    STATE.timer = setInterval(runAgentSoft, ms);
    highlightActive();
  }

  function makeBtn(txt, ms){
    const b=document.createElement('button');
    b.className='agent-auto-btn btn btn-xs'; b.textContent=txt; b.dataset.ms = String(ms);
    b.addEventListener('click', ()=>{ if (STATE.interval===ms) stopAuto(); else startAuto(ms); });
    return b;
  }
  function makeStop(){
    const b=document.createElement('button');
    b.className='agent-auto-btn agent-auto-stop btn btn-xs'; b.textContent='✕';
    b.title='Остановить автообновление'; b.addEventListener('click', stopAuto); return b;
  }

  function highlightActive(){
    const group = document.getElementById('agentAutoGroup'); if (!group) return;
    group.querySelectorAll('.agent-auto-btn').forEach(btn=>{
      const ms = parseInt(btn.dataset.ms||'0',10);
      if (ms){ if (STATE.interval===ms) btn.classList.add('active'); else btn.classList.remove('active'); }
      if (!ms){ btn.classList.remove('active'); }
    });
  }

  function injectUI(){
    if (document.getElementById('agentAutoGroup')) return;
    const inp = getAgentInput(); if (!inp) return;
    const old = document.getElementById('agentAutoBtn'); if (old) old.remove();
    const group = document.createElement('span');
    group.id='agentAutoGroup'; group.className='agent-auto-group';
    group.appendChild(makeBtn('5с', 5000));
    group.appendChild(makeBtn('10с', 10000));
    group.appendChild(makeBtn('15с', 15000));
    group.appendChild(makeStop());
    if (inp.parentElement) inp.parentElement.appendChild(group); else inp.after(group);
    highlightActive();
  }

  document.addEventListener('DOMContentLoaded', ()=>{ injectUI(); });
  let tries=0; const t=setInterval(()=>{ injectUI(); highlightActive(); if (++tries>20) clearInterval(t); }, 300);

  if (window.appSelectSymbol && !window._agentAutoHookedCompact){
    const orig = window.appSelectSymbol;
    window.appSelectSymbol = function(s){ STATE.lastPrice=null; return orig.apply(this, arguments); };
    window._agentAutoHookedCompact = true;
  }
})();
</script>

  <!-- Sticky: Binance Spot — Top 20 Gainers -->
  <aside class="spot-ticker-panel" id="spot-ticker-panel" role="dialog" aria-modal="false" aria-labelledby="spot-ticker-title">
    <header class="spot-ticker-header">
      <div class="spot-ticker-title">
        <b id="spot-ticker-title">Top 20 по росту (%)</b>
        <small class="muted">Источник: Binance Spot (24h)</small>
      </div><button type="button" class="spot-ticker-close" id="spot-ticker-close" aria-label="Закрыть">×</button> </header>
    <div class="spot-ticker-list" id="spot-ticker-list">
      <ul id="spot-ticker-ul"></ul>
    </div>
    <div class="spot-ticker-footer">
      <span id="spot-updated" class="muted">Обновление…</span>
      <a class="link" href="https://www.binance.com/en/markets/overview" target="_blank" rel="noopener">Binance Markets</a>
    </div>
  </aside>

<script>
(function(){
  const QUOTE = "USDT";
  const LIMIT = 20;
  const REFRESH_MS = 60000;
  const EXCLUDE_REGEX = /(UP|DOWN|BULL|BEAR)/;

  const btn = document.getElementById("btn-binance-spot");
  if (btn) btn.setAttribute("aria-controls", "spot-ticker-panel");

  const panel = document.getElementById("spot-ticker-panel");
  const closeBtn = document.getElementById("spot-ticker-close");
  const list = document.getElementById("spot-ticker-ul");
  const updatedEl = document.getElementById("spot-updated");

  function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); }
  function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }

  if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
  if (closeBtn) closeBtn.addEventListener("click", closePanel);
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

  async function fetchTopGainers(){
    try {
      const resp = await fetch("https://api.binance.com/api/v3/ticker/24hr");
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();
      const filtered = data.filter(t =>
        t.symbol.endsWith(QUOTE) &&
        !EXCLUDE_REGEX.test(t.symbol) &&
        Number(t.quoteVolume) > 0
      );
      filtered.sort((a,b)=> Number(b.priceChangePercent) - Number(a.priceChangePercent));
      const top = filtered.slice(0, LIMIT);
      renderList(top);
      const ts = new Date(); updatedEl.textContent = "Обновлено: " + ts.toLocaleString();
    } catch(e){
      console.error(e);
      updatedEl.textContent = "Ошибка загрузки. Попробуйте позже.";
    }
  }

  function renderList(rows){
    list.innerHTML = "";
    for (const row of rows){
      const li = document.createElement("li");
      li.className = "spot-ticker-row";
      const sym = row.symbol.replace(QUOTE, "");
      const pct = Number(row.priceChangePercent);
      const symEl = document.createElement("div"); symEl.className = "sym"; symEl.textContent = sym;
      const pctEl = document.createElement("div"); pctEl.className = "pct " + (pct >= 0 ? "up" : "down"); pctEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
      li.appendChild(symEl); li.appendChild(pctEl); list.appendChild(li);
    }
  }

  fetchTopGainers();
  setInterval(fetchTopGainers, REFRESH_MS);
})();
</script>

    <!-- Sticky: Bybit Spot — Top 20 Gainers -->
    <aside class="spot-ticker-panel" id="bybit-ticker-panel" role="dialog" aria-modal="false" aria-labelledby="bybit-ticker-title" style="top:16px; right:16px;">
      <header class="spot-ticker-header">
        <div class="spot-ticker-title">
          <b id="bybit-ticker-title">Top 20 по росту (%)</b>
          <small class="muted">Источник: Bybit Spot (24h)</small>
        </div><button type="button" class="spot-ticker-close" id="bybit-ticker-close" aria-label="Закрыть">×</button> </header>
      <div class="spot-ticker-list">
        <ul id="bybit-ticker-ul"></ul>
      </div>
      <div class="spot-ticker-footer">
        <span id="bybit-updated" class="muted">Обновление…</span>
        <a class="link" href="https://www.bybit.com/ru-RU/trade/spot/overview" target="_blank" rel="noopener">Bybit Markets</a>
      </div>
    </aside>
    

    <script>
    (function(){
      const QUOTE = "USDT";
      const LIMIT = 20;
      const REFRESH_MS = 60000;
      const EXCLUDE_REGEX = /(UP|DOWN|BULL|BEAR|3L|3S|5L|5S)/;

      const btn = document.getElementById("btn-bybit-spot");
      if (btn) btn.setAttribute("aria-controls", "bybit-ticker-panel");

      const panel = document.getElementById("bybit-ticker-panel");
      const closeBtn = document.getElementById("bybit-ticker-close");
      const list = document.getElementById("bybit-ticker-ul");
      const updatedEl = document.getElementById("bybit-updated");

      function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); }
      function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }

      if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
      if (closeBtn) closeBtn.addEventListener("click", closePanel);
      document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

      async function fetchTopGainers(){
        try {
          const url = "https://api.bybit.com/v5/market/tickers?category=spot";
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const json = await resp.json();
          const data = (json && json.result && json.result.list) ? json.result.list : [];
          const filtered = data.filter(t =>
            t.symbol && t.symbol.endsWith(QUOTE) &&
            !EXCLUDE_REGEX.test(t.symbol)
          );

          // Bybit price24hPcnt like "0.0534" = +5.34%
          filtered.sort((a,b)=> Number(b.price24hPcnt) - Number(a.price24hPcnt));
          const top = filtered.slice(0, LIMIT);
          renderList(top);
          const ts = new Date(); updatedEl.textContent = "Обновлено: " + ts.toLocaleString();
        } catch(e){
          console.error(e);
          updatedEl.textContent = "Ошибка загрузки. Попробуйте позже.";
        }
      }

      function renderList(rows){
        list.innerHTML = "";
        for (const row of rows){
          const li = document.createElement("li");
          li.className = "spot-ticker-row";
          const sym = row.symbol.replace(QUOTE, "");
          const pct = Number(row.price24hPcnt) * 100; // convert fraction to %
          const symEl = document.createElement("div"); symEl.className = "sym"; symEl.textContent = sym;
          const pctEl = document.createElement("div"); pctEl.className = "pct " + (pct >= 0 ? "up" : "down"); pctEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
          li.appendChild(symEl); li.appendChild(pctEl); list.appendChild(li);
        }
      }

      fetchTopGainers();
      setInterval(fetchTopGainers, REFRESH_MS);
    })();
    </script>
    

<!-- Sticky: Bybit Futures — Top 20 Gainers -->
<aside class="spot-ticker-panel" id="bybit-futures-panel" role="dialog" aria-modal="false" aria-labelledby="bybit-futures-title" style="top:16px; right:16px;">
  <header class="spot-ticker-header">
    <div class="spot-ticker-title">
      <b id="bybit-futures-title">Top 20 по росту (%)</b>
      <small class="muted">Источник: Bybit Futures (24h)</small>
    </div> </header>
  <div class="spot-ticker-list">
    <ul id="bybit-futures-ul"></ul>
  </div>
  <div class="spot-ticker-footer">
    <span id="bybit-futures-updated" class="muted">Обновление…</span>
    <a class="link" href="https://www.bybit.com/ru-RU/trade/usdt/BTCUSDT" target="_blank" rel="noopener">Bybit Futures</a>
  </div>
</aside>

<script>
(function(){
  const QUOTE = "USDT";            // USDT-маржинальные
  const LIMIT = 20;
  const REFRESH_MS = 60000;
  const EXCLUDE_REGEX = /(UP|DOWN|BULL|BEAR|3L|3S|5L|5S)/;

  const btn = document.getElementById("btn-bybit-futures");
  if (btn) btn.setAttribute("aria-controls", "bybit-futures-panel");

  const panel = document.getElementById("bybit-futures-panel");
  const closeBtn = document.getElementById("bybit-futures-close");
  const list = document.getElementById("bybit-futures-ul");
  const updatedEl = document.getElementById("bybit-futures-updated");

  function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); }
  function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }

  if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
  if (closeBtn) closeBtn.addEventListener("click", closePanel);
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

  async function fetchTopGainers(){
    try {
      // Bybit v5 futures (linear USDT perps)
      const url = "https://api.bybit.com/v5/market/tickers?category=linear";
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const json = await resp.json();
      const data = (json && json.result && json.result.list) ? json.result.list : [];

      const filtered = data.filter(t => {
        const sym = t.symbol || "";
        const contract = (t.contractType || "").toLowerCase();
        return sym.endsWith(QUOTE) &&
               !EXCLUDE_REGEX.test(sym) &&
               (contract.includes("perpetual") || contract === "" ); // чаще всего "LinearPerpetual"
      });

      // price24hPcnt is fraction, e.g., 0.0534 => +5.34%
      filtered.sort((a,b)=> Number(b.price24hPcnt) - Number(a.price24hPcnt));
      const top = filtered.slice(0, LIMIT);
      renderList(top);
      const ts = new Date(); updatedEl.textContent = "Обновлено: " + ts.toLocaleString();
    } catch(e){
      console.error(e);
      if (updatedEl) updatedEl.textContent = "Ошибка загрузки. Попробуйте позже.";
    }
  }

  function renderList(rows){
    list.innerHTML = "";
    for (const row of rows){
      const li = document.createElement("li");
      li.className = "spot-ticker-row";
      const sym = (row.symbol || "").replace(QUOTE, "");
      const pct = Number(row.price24hPcnt) * 100;
      const symEl = document.createElement("div"); symEl.className = "sym"; symEl.textContent = sym;
      const pctEl = document.createElement("div"); pctEl.className = "pct " + (pct >= 0 ? "up" : "down"); pctEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
      li.appendChild(symEl); li.appendChild(pctEl); list.appendChild(li);
    }
  }

  fetchTopGainers();
  setInterval(fetchTopGainers, REFRESH_MS);
})();
</script>

<!-- Sticky: Spreads (from anywhere) -->

<!-- Sticky: Spreads (Futures Binance ↔ Bybit) -->
<aside class="spot-ticker-panel" id="spreads-panel" role="dialog" aria-modal="false" aria-labelledby="spreads-title" style="top:16px; right:16px;">
  <header class="spot-ticker-header">
    <div class="spot-ticker-title">
      <b id="spreads-title">Спреды фьючерсов (Binance ↔ Bybit)</b>
      <small class="muted">порог, % — фильтрация по Δ%</small>
    </div> <div class="flex items-center gap-2" style="padding-right:8px">
      <label class="muted" for="spreads-threshold" style="font-size:12px">Порог:</label>
      <input id="spreads-threshold" type="number" min="0" step="0.01" value="0.10" style="width:70px; background:#0b1116; color:#e6edf3; border:1px solid #24303a; border-radius:6px; padding:4px 6px;">
      <span class="muted" style="font-size:12px">%</span>
    </div>
  </header>
  <div class="spot-ticker-list" id="spreads-list" style="padding:0; max-height: calc(100dvh - 140px);">
    <table id="spreads-table" style="width:100%; border-collapse:collapse; font-variant-numeric: tabular-nums;">
      <thead style="position:sticky; top:0; background:#0b1116; z-index:1; border-bottom:1px solid #24303a;">
        <tr>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #24303a;">Тикер</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303a;">Binance mid</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303а;">Bybit mid</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303a;">Δ abs</th>
          <th style="text-align:right; padding:10px 12px; border-bottom:1px solid #24303a;">Δ %</th>
        </tr>
      </thead>
      <tbody id="spreads-tbody"></tbody>
    </table>
  </div>
  <div class="spot-ticker-footer">
    <span id="spreads-updated" class="muted">Обновление…</span>
    <span class="muted">USDT/USDC перпетуалы, best bid/ask</span>
  </div>
</aside>

<script>
(function(){
  const REFRESH_MS = 3000;   // обновление UI
  const API_REFRESH_MS = 20000; // обновление API-фолбэка
  const TOKEN_RX = /([A-Z0-9]{2,10})(?:\/?(USDT|USD|USDC|FDUSD|BTC|ETH))/i;
  const VENUE_RX = /(BINANCE|BYBIT|OKX|KUCOIN|BITGET|KRAKEN|HUOBI|GATE|MEXC|BITSTAMP|DERIBIT|COINBASE)/i;
  const PRICE_RX = /([0-9]+(?:[.,][0-9]+)?)/;
  const QUOTE_NORMALIZE = {',':'.'};

  // Хранилище котировок
  const STORE = Object.create(null);
  function putQuote(symbol, venue, price){
    symbol = symbol.toUpperCase().replace(/[^A-Z0-9]/g,'');
    venue = venue.toUpperCase();
    if (!STORE[symbol]) STORE[symbol] = {};
    STORE[symbol][venue] = {price: Number(price), ts: Date.now()};
  }

  // Публичный API для ручного пуша
  window.pushQuote = function({venue, symbol, price}){
    if (!venue || !symbol || !(price>0)) return;
    putQuote(symbol, venue, price);
  };

  // DOM‑парсинг сообщений/текстов
  function ingestFromText(){
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    const now = Date.now();
    let node;
    while (node = walker.nextNode()){
      const t = node.textContent;
      if (!t || t.length < 4) continue;
      const tokenM = t.match(TOKEN_RX);
      if (!tokenM) continue;
      const venueM = t.match(VENUE_RX);
      const after = t.slice(Math.max(0, t.indexOf(tokenM[0]) + tokenM[0].length));
      const priceM = after.match(PRICE_RX);
      if (!priceM) continue;
      const price = Number((priceM[1]+'').replace(',', '.'));
      if (!(price>0)) continue;
      const symbol = (tokenM[1] + (tokenM[2] || '')).toUpperCase();
      const venue = venueM ? venueM[1].toUpperCase() : 'UNKNOWN';
      putQuote(symbol, venue, price);
    }
    // Очистка устаревших котировок
    for (const sym in STORE){
      for (const v in STORE[sym]){
        if (now - STORE[sym][v].ts > 180000) delete STORE[sym][v];
      }
    }
  }

  // Фолбэк: тянем котировки из API бирж, чтобы «что‑то» показывалось даже без сообщений
  async function refreshApiFallback(){
    try {
      const [binBook, bybTick] = await Promise.all([
        fetch("https://api.binance.com/api/v3/ticker/bookTicker").then(r=>r.json()).catch(()=>[]),
        fetch("https://api.bybit.com/v5/market/tickers?category=spot").then(r=>r.json()).then(j=>j?.result?.list||[]).catch(()=>[])
      ]);

      // Binance
      for (const t of binBook){
        const sym = t.symbol;
        if (!sym || !/USDT$/.test(sym)) continue;
        const mid = (Number(t.askPrice)+Number(t.bidPrice))/2;
        if (mid>0) putQuote(sym, "BINANCE", mid);
      }
      // Bybit
      for (const t of bybTick){
        const sym = t.symbol;
        if (!sym || !/USDT$/.test(sym)) continue;
        const ask = Number(t.ask1Price || t.askPrice || t.ask || 0);
        const bid = Number(t.bid1Price || t.bidPrice || t.bid || 0);
        const mid = (ask+bid)/2;
        if (mid>0) putQuote(sym, "BYBIT", mid);
      }
    } catch(e){ console.warn("API fallback error", e); }
  }

  // Рендер таблицы
  function renderTable(){
    const tbody = document.getElementById('spreads-tbody');
    if (!tbody) return;
    const rows = [];
    for (const sym in STORE){
      const venues = Object.keys(STORE[sym]);
      for (let i=0;i<venues.length;i++){
        for (let j=i+1;j<venues.length;j++){
          const va = venues[i], vb = venues[j];
          const pa = STORE[sym][va]?.price;
          const pb = STORE[sym][vb]?.price;
          if (!(pa>0 && pb>0)) continue;
          const mid = (pa + pb) / 2;
          const diffPct = Math.abs(pa - pb) / mid * 100;
          rows.push({symbol:sym, va, pa, vb, pb, diffPct});
        }
      }
    }
    rows.sort((a,b)=> b.diffPct - a.diffPct);
    tbody.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:8px 12px">${r.symbol}</td>
        <td style="padding:8px 12px">${r.va}</td>
        <td style="padding:8px 12px; text-align:right">${r.pa.toFixed(6)}</td>
        <td style="padding:8px 12px">${r.vb}</td>
        <td style="padding:8px 12px; text-align:right">${r.pb.toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right; font-weight:700">${r.diffPct.toFixed(3)}%</td>
      `;
      tbody.appendChild(tr);
    }
    const tsEl = document.getElementById('spreads-updated');
    if (tsEl) tsEl.textContent = "Обновлено: " + new Date().toLocaleString() + ` • тикеров: ${Object.keys(STORE).length}`;
  }

  // Мутации DOM (новые сообщения), таймеры
  const obs = new MutationObserver(()=>{ ingestFromText(); });
  obs.observe(document.body, { childList: true, subtree: true, characterData: true });

  // Первичный запуск
  ingestFromText(); refreshApiFallback(); renderTable();
  setInterval(()=>{ ingestFromText(); renderTable(); }, REFRESH_MS);
  setInterval(()=>{ refreshApiFallback(); }, API_REFRESH_MS);
})();
</script>

<script>
// ---- OI & Taker module (Binance only) — current OI + Δ vs prev + taker buy/sell & total for 1m/5m/15m ----
(function(){
  if (window._oiModuleInit2) return; window._oiModuleInit2 = true;

  // State
  const STORE = Object.create(null); // OI live samples { SYMBOL: [{ts, oi}] }
  let currentPeriodMin = 5;
  let timer = null;
  const POLL_MS = 15000;   // 15s polling for OI (supports 1m deltas)
  const KEEP_MS = 3*60*60*1000;

  // Utils
  const now = ()=> Date.now();
  const minutes = n => n*60*1000;
  const fmtNum = x => {
    try{ return new Intl.NumberFormat('en-US', {maximumFractionDigits: 2}).format(x); }catch(_){ return String(x); }
  };
  const fmtSigned = x => (x>0?'+':'') + fmtNum(x);

  // Fetchers
  async function fetchOI(symbol){
    const url = `https://fapi.binance.com/fapi/v1/openInterest?symbol=${encodeURIComponent(symbol)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('OI HTTP '+r.status);
    const j = await r.json();
    const oi = Number(j.openInterest);
    if (!isFinite(oi)||oi<=0) throw new Error('Bad OI');
    return {ts: now(), oi};
  }
  function klineInterval(min){
    if (min===1) return '1m';
    if (min===5) return '5m';
    if (min===15) return '15m';
    return '5m';
  }
  async function fetchTakerVolumes(symbol, periodMin){
    const interval = klineInterval(periodMin);
    const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${encodeURIComponent(symbol)}&interval=${interval}&limit=1`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('Klines HTTP '+r.status);
    const a = await r.json();
    if (!Array.isArray(a) || !a.length) throw new Error('No klines');
    const k = a[a.length-1];
    const totalBase = Number(k[5]);       // base asset volume
    const takerBuyBase = Number(k[9]);    // taker buy base asset volume
    const takerSellBase = Math.max(0, totalBase - takerBuyBase);
    return { buy: takerBuyBase, sell: takerSellBase, total: totalBase };
  }
  async function fetchHistBaseline(symbol, periodMin){
    // For 5/15m we can use futures/data openInterestHist (older row as baseline)
    const period = (periodMin===15?'15m':'5m');
    const url = `https://fapi.binance.com/futures/data/openInterestHist?symbol=${encodeURIComponent(symbol)}&period=${period}&limit=2`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('Hist HTTP '+r.status);
    const arr = await r.json();
    if (!Array.isArray(arr)||!arr.length) throw new Error('No hist');
    const older = arr.length>=2 ? arr[arr.length-2] : arr[0];
    const oi = Number(older.sumOpenInterest || older.sumOpenInterestValue || older.openInterest || older.oi || 0);
    const ts = Date.parse(older.timestamp||older.time||older.date||Date.now()-minutes(periodMin));
    if (!isFinite(oi)||oi<=0) throw new Error('Bad hist OI');
    return {ts, oi};
  }

  // Store helpers
  function pushSample(symbol, sample){
    if (!STORE[symbol]) STORE[symbol] = [];
    STORE[symbol].push(sample);
    const cutoff = now() - KEEP_MS;
    while (STORE[symbol].length && STORE[symbol][0].ts < cutoff) STORE[symbol].shift();
  }
  function latest(symbol){
    const arr = STORE[symbol] || [];
    return arr.length ? arr[arr.length-1] : null;
  }
  function nearestAgo(symbol, msAgo){
    const arr = STORE[symbol] || [];
    if (!arr.length) return null;
    const target = now() - msAgo;
    let best=null, bestDt=Infinity;
    for (const s of arr){
      const dt = Math.abs(s.ts - target);
      if (dt<bestDt){ best=s; bestDt=dt; }
    }
    return best;
  }

  // UI
  function setSymbolLabel(symbol){
    const pill = document.getElementById('oiF_sym');
    if (pill){
      // Show like BTCUSDT (перпетуал)
      pill.textContent = symbol || '—';
      pill.classList.remove('opacity-0');
    }
    // Also mirror symbol near "Open Interest (now)"
    const nowEl = document.getElementById('oiF_now');
    if (nowEl && symbol){
      nowEl.setAttribute('data-symbol', symbol);
      // prepend small label if not yet present
      if (!nowEl._labeled){
        const wrap = document.createElement('div');
        wrap.className = 'text-xs text-slate-400';
        wrap.id = 'oiF_nowSymLbl';
        nowEl.parentElement.insertBefore(wrap, nowEl);
        nowEl._labeled = true;
      }
      const lbl = document.getElementById('oiF_nowSymLbl');
      if (lbl) lbl.textContent = symbol + ' • Binance';
    }
  }

  function setPeriodLabels(){
    const buyLbl = document.getElementById('oiF_buyLbl');
    const sellLbl = document.getElementById('oiF_sellLbl');
    if (buyLbl) buyLbl.textContent = `Taker Buy (${currentPeriodMin}m)`;
    if (sellLbl) sellLbl.textContent = `Taker Sell (${currentPeriodMin}m)`;
    // Update Total label (prev sibling of #oiF_total)
    const totalEl = document.getElementById('oiF_total');
    if (totalEl && totalEl.previousElementSibling){
      totalEl.previousElementSibling.textContent = `Всего (Buy+Sell, ${currentPeriodMin}m)`;
    }
    const lbl = document.getElementById('oiF_buyLbl'); // header label already set
    const hdr = document.getElementById('oiF_buyLbl'); // no extra
  }
  function setActiveButtons(){
    const ids = {1:'oiP_1m',5:'oiP_5m',15:'oiP_15m'};
    Object.entries(ids).forEach(([m,id])=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (Number(m)===currentPeriodMin) el.classList.add('active','bg-green-600/80','border-green-700');
      else el.classList.remove('active','bg-green-600/80','border-green-700');
    });
  }
  function updateTimestamp(ts){
    const tsEl = document.getElementById('oiF_ts');
    if (tsEl) tsEl.textContent = 'Обновлено: ' + new Date(ts).toLocaleTimeString();
  }
  function colorize(el, val){
    if (!el) return;
    el.classList.remove('text-green-400','text-red-400','text-slate-400');
    if (!isFinite(val)) el.classList.add('text-slate-400');
    else el.classList.add(val>=0?'text-green-400':'text-red-400');
  }

  async function render(symbol){
    setSymbolLabel(symbol);
    if (!symbol) return;
    setPeriodLabels(); setActiveButtons();

    // 1) Current OI + delta vs prev period baseline (absolute)
    const cur = latest(symbol);
    if (cur){
      const nowEl = document.getElementById('oiF_now');
      if (nowEl) nowEl.textContent = fmtNum(cur.oi);
      updateTimestamp(cur.ts);
    }
    let base = null;
    if (currentPeriodMin===1){
      base = nearestAgo(symbol, minutes(1));
    } else {
      base = nearestAgo(symbol, minutes(currentPeriodMin));
      if (!base){
        try{ base = await fetchHistBaseline(symbol, currentPeriodMin); }catch(_){ base=null; }
      }
    }
    const deltaEl = document.getElementById('oiF_delta');
    if (deltaEl){
      if (cur && base && isFinite(cur.oi) && isFinite(base.oi)){
        const delta = cur.oi - base.oi;
        deltaEl.textContent = fmtSigned(delta);
        colorize(deltaEl, delta);
      } else {
        deltaEl.textContent = '—';
        deltaEl.className = 'text-slate-400';
      }
    }

    // 2) Taker Buy/Sell/Total for selected period via klines
    try{
      const vol = await fetchTakerVolumes(symbol, currentPeriodMin);
      const buyEl = document.getElementById('oiF_buy');
      const buyPctEl = document.getElementById('oiF_buyPct');
      const sellEl = document.getElementById('oiF_sell');
      const sellPctEl = document.getElementById('oiF_sellPct');
      const totalEl = document.getElementById('oiF_total');

      if (buyEl) { buyEl.textContent = fmtNum(vol.buy); buyEl.className='text-green-400'; }
      if (sellEl){ sellEl.textContent = fmtNum(vol.sell); sellEl.className='text-red-400'; }
      if (totalEl){ totalEl.textContent = fmtNum(vol.total); }

      const total = vol.total>0 ? vol.total : NaN;
      const buyPct = isFinite(total) ? (vol.buy/total*100) : NaN;
      const sellPct = isFinite(total) ? (vol.sell/total*100) : NaN;
      if (buyPctEl) buyPctEl.textContent = isFinite(buyPct) ? ` ${buyPct.toFixed(1)}%` : '';
      if (sellPctEl) sellPctEl.textContent = isFinite(sellPct) ? ` ${sellPct.toFixed(1)}%` : '';

    }catch(_){
      // leave placeholders
    }
  }

  // Period buttons
  function bindButtons(){
    const b1 = document.getElementById('oiP_1m');
    const b5 = document.getElementById('oiP_5m');
    const b15= document.getElementById('oiP_15m');
    if (b1 && !b1._bound){ b1.addEventListener('click', ()=>{ currentPeriodMin=1; render(getSelected()); }); b1._bound=true; }
    if (b5 && !b5._bound){ b5.addEventListener('click', ()=>{ currentPeriodMin=5; render(getSelected()); }); b5._bound=true; }
    if (b15&& !b15._bound){ b15.addEventListener('click',()=>{ currentPeriodMin=15; render(getSelected()); }); b15._bound=true; }
  }

  function getSelected(){
    try{ if (window.state && window.state.selected) return window.state.selected; }catch(_){}
    try{
      const n = document.querySelector('[data-sym].active,[data-symbol].active');
      if (n) return n.getAttribute('data-sym') || n.getAttribute('data-symbol');
    }catch(_){}
    return null;
  }

  async function tick(){
    const sym = getSelected();
    if (!sym) return;
    try{ const s = await fetchOI(sym); pushSample(sym, s); }catch(_){}
    render(sym);
  }

  // Public
  window.OI_updateFloat = function(symbol){
    setSymbolLabel(symbol);
    // on selection change, force immediate fetch+render
    fetchOI(symbol).then(s=>{ pushSample(symbol, s); render(symbol); }).catch(()=> render(symbol));
  };

  // Init
  bindButtons();
  // show panel if hidden
  const root = document.getElementById('oiFloat');
  if (root && root.classList.contains('hidden')) root.classList.remove('hidden');
  // default to 5m buttons style
  setActiveButtons(); setPeriodLabels();

  // start
  tick();
  if (timer) clearInterval(timer);
  timer = setInterval(tick, POLL_MS);
})();
</script>

<script>
(function(){
  const btn = document.getElementById("btn-spreads");
  const panel = document.getElementById("spreads-panel");
  if (btn) btn.setAttribute("aria-controls", "spreads-panel");
  const tbody = document.getElementById("spreads-tbody");
  const updatedEl = document.getElementById("spreads-updated");
  const thrInput = document.getElementById("spreads-threshold");
  function adjustSpreadsPanelWidth(){
    const panel = document.getElementById("spreads-panel");
    const table = document.getElementById("spreads-table");
    if (!panel || !table) return;
    requestAnimationFrame(()=>{
      const desired = table.scrollWidth + 32; // padding
      const minW = 560;
      const maxW = Math.floor(window.innerWidth * 0.96);
      const w = Math.min(Math.max(desired, minW), maxW);
      panel.style.width = w + "px";
    });
  }

  // Open/close
  function openPanel(){ panel.classList.add("open"); if (btn) btn.setAttribute("aria-expanded","true"); refresh(); adjustSpreadsPanelWidth(); }
  function closePanel(){ panel.classList.remove("open"); if (btn) btn.setAttribute("aria-expanded","false"); }
  if (btn) btn.addEventListener("click", ()=>{ panel.classList.contains("open") ? closePanel() : openPanel(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && panel.classList.contains("open")) closePanel(); });

  // Threshold persistence
  const DEF_THR = 0.10;
  function loadThr(){
    try{ const v = localStorage.getItem("spreads_thr_pct"); return v!==null ? Number(v) : DEF_THR; }catch(_){ return DEF_THR; }
  }
  function saveThr(v){ try{ localStorage.setItem("spreads_thr_pct", String(v)); }catch(_){ } }
  if (thrInput){
    const v = loadThr();
    thrInput.value = isFinite(v) ? v.toFixed(2) : DEF_THR.toFixed(2);
    thrInput.addEventListener("change", ()=>{
      const n = Number(thrInput.value);
      if (isFinite(n) && n>=0){ saveThr(n); refresh(); }
    });
  }

  const INCLUDE_QUOTES = /(USDT|USDC)$/;
  const REFRESH_MS = 60000;

  async function fetchBinanceBook(){
    const url = "https://fapi.binance.com/fapi/v1/ticker/bookTicker";
    const r = await fetch(url);
    if (!r.ok) throw new Error("Binance HTTP "+r.status);
    const arr = await r.json();
    const map = new Map();
    for (const t of arr){
      const sym = t.symbol;
      if (!INCLUDE_QUOTES.test(sym)) continue;
      const bid = Number(t.bidPrice), ask = Number(t.askPrice);
      if (!(bid>0 && ask>0)) continue;
      map.set(sym, (bid+ask)/2);
    }
    return map;
  }

  async function fetchBybitBook(){
    const url = "https://api.bybit.com/v5/market/tickers?category=linear";
    const r = await fetch(url);
    if (!r.ok) throw new Error("Bybit HTTP "+r.status);
    const j = await r.json();
    const list = (j && j.result && j.result.list) ? j.result.list : [];
    const map = new Map();
    for (const t of list){
      const sym = t.symbol;
      if (!sym || !INCLUDE_QUOTES.test(sym)) continue;
      const bid = Number(t.bid1Price || t.bidPrice || t.bid || 0);
      const ask = Number(t.ask1Price || t.askPrice || t.ask || 0);
      if (!(bid>0 && ask>0)) continue;
      map.set(sym, (bid+ask)/2);
    }
    return map;
  }

  function renderRows(rows){
    tbody.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px 12px">${r.symbol}</td>
        <td style="padding:8px 12px; text-align:right">${r.bMid.toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right">${r.yMid.toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right">${(r.yMid - r.bMid).toFixed(6)}</td>
        <td style="padding:8px 12px; text-align:right; font-weight:700" class="${r.pct>=0?'up':'down'}">${(r.pct>=0?'+':'') + r.pct.toFixed(3)}%</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function refresh(){
    if (!panel || !panel.classList.contains("open")) return;
    updatedEl.textContent = "Обновление…";
    try{
      const [bin, byb] = await Promise.all([fetchBinanceBook(), fetchBybitBook()]);
      const thr = thrInput ? Number(thrInput.value) || 0.10 : 0.10;
      const rows = [];
      for (const [sym, bMid] of bin.entries()){
        const yMid = byb.get(sym);
        if (!isFinite(yMid)) continue;
        const pct = (yMid - bMid) / ((yMid + bMid)/2) * 100;
        if (Math.abs(pct) < thr) continue;
        rows.push({symbol: sym, bMid, yMid, pct});
      }
      rows.sort((a,b)=> Math.abs(b.pct) - Math.abs(a.pct));
      renderRows(rows);
      updatedEl.textContent = "Обновлено: " + new Date().toLocaleString() + " • пар: " + rows.length + ` • порог: ${thr.toFixed(2)}%`;
      adjustSpreadsPanelWidth();
    }catch(e){
      console.error(e);
      updatedEl.textContent = "Ошибка загрузки. Попробуйте позже.";
    }
  }

  setInterval(refresh, REFRESH_MS);
  window.addEventListener("resize", adjustSpreadsPanelWidth);
})();
</script>

<script>
document.addEventListener("click", (ev)=>{
  const btn = ev.target.closest(".spot-close-btn");
  if (!btn) return;
  const panel = btn.closest(".spot-ticker-panel");
  if (panel){ panel.classList.remove("open"); }
});
</script>

<!-- === NATR overlay injection start === -->
<style>
  #natr-panel{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:9998;display:none;}
  #natr-card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1100px,94vw);max-height:86vh;overflow:auto;
    background:rgba(30,41,59,.95);border:1px solid #334155;border-radius:16px;color:#e5e7eb;}
  #natr-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #334155;background:#1f2937;}
  #natr-table{width:100%;border-collapse:collapse}
  #natr-table thead, #natr-table tbody { display: block; }
  #natr-table tbody { max-height: 65vh; overflow-y: auto; }
  #natr-table thead tr, #natr-table tbody tr { display: table; width: 100%; table-layout: fixed; }
  #natr-table thead th{position:sticky;top:0;background:#1f2937;border-bottom:1px solid #334155;font-size:12px;color:#94a3b8;text-align:left;padding:10px 12px}
  #natr-table tbody td{padding:12px;border-bottom:1px solid #293448;font-size:14px;vertical-align:middle}
  #natr-close{background:#374151;border:1px solid #475569;color:#e5e7eb;border-radius:10px;padding:8px 12px;font-weight:700}
  .score-chip{background:#222844;border:1px solid #2f3a63;padding:4px 8px;border-radius:8px;font-weight:700}
  .pct-up{color:#26c281;font-weight:700} .pct-down{color:#ff5d5d;font-weight:700}
  .chip{margin-left:8px;background:#23293d;border:1px solid #2d3550;color:#9aa4b2;font-size:12px;padding:4px 8px;border-radius:999px}
</style>
<div id="natr-panel">
  <div id="natr-card">
    <div id="natr-head">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">NATR 1m / 5 ≥ 2% — все монеты (Bybit + Binance Futures)</h3>
        <span class="chip">Сортировка: NATR ↓</span>
        <span class="chip">Порог: 1.5%+</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="natr-refresh" class="btn">Обновить</button>
        <button id="natr-close">Закрыть</button>
      </div>
    </div>
    <div style="padding:12px 14px">
      <div id="natr-status" style="color:#9aa4b2;font-size:12px;margin-bottom:8px">Загрузка…</div>
      <div style="overflow:auto;max-height:75vh" class="scroll-area">
        <table id="natr-table">
          <thead>
            <tr>
              <th>Тикер</th>
              <th>Цена</th>
              <th>NATR 1m/5, %</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const panel = document.getElementById('natr-panel');
  const btnClose = document.getElementById('natr-close');
  const btnRefresh = document.getElementById('natr-refresh');
  const tbody = document.querySelector('#natr-table tbody');
  const statusEl = document.getElementById('natr-status');

  // Try to find the existing toolbar button that shows text "NATR" and attach handler
  function bindToolbarButton(){
    const candidates = Array.from(document.querySelectorAll('button, a, .tools-btn'));
    const target = candidates.find(el => (el.textContent||'').trim().toLowerCase() === 'natr');
    if(target){ target.id = 'btn-natr'; target.addEventListener('click', openPanel); }
  }

  function openPanel(){ panel.style.display='block'; scan(); }
  btnClose.addEventListener('click', ()=> panel.style.display='none');
  btnRefresh.addEventListener('click', scan);
  window.addEventListener('load', bindToolbarButton);

  // Helpers
  function tr(high, low, prevClose){ return Math.max(high-low, Math.abs(high - prevClose), Math.abs(low - prevClose)); }
  function natrFromKlines(kl){ // kl: array of [openTime, open, high, low, close, volume, ...]
    if(!kl || kl.length < 6) return null;
    const arr = kl.map(k => ({h:+k[2], l:+k[3], c:+k[4]}));
    const trs = [];
    for(let i=1;i<6;i++){ // last 5 periods need previous close
      const prev = arr[i-1].c;
      trs.push(tr(arr[i].h, arr[i].l, prev));
    }
    const atr5 = trs.reduce((s,v)=>s+v,0) / trs.length;
    const close = arr[5].c;
    const natr = 100 * atr5 / (close || 1);
    return { atr5, natr, close };
  }

  // REST
  async function binance24h(){ const r=await fetch("https://fapi.binance.com/fapi/v1/ticker/24hr"); return r.json(); }
  async function binanceKlines(sym){ const r=await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=1m&limit=6`); return r.json(); }
  async function bybitInstruments(){ const r=await fetch("https://api.bybit.com/v5/market/instruments-info?category=linear"); return r.json(); }
  async function bybitKlines(sym){ const r=await fetch(`https://api.bybit.com/v5/market/kline?category=linear&symbol=${sym}&interval=1&limit=6`); return r.json(); }

  function excludeNonUSDT(arr){ return arr.filter(x=> (x.symbol||'').endsWith('USDT')); }

  async function scan(){
    statusEl.textContent = 'Загрузка тикеров…';
    tbody.innerHTML = '';
    try{
      // Gather symbols
      const [bin24, bybInst] = await Promise.all([binance24h(), bybitInstruments()]);
      const binSymbols = excludeNonUSDT(bin24).map(x=>x.symbol);
      const bybSymbols = (bybInst?.result?.list||[]).filter(x=>x.quoteCoin==='USDT').map(x=>x.symbol);
      const total = binSymbols.length + bybSymbols.length;

      // Fetch klines in gentle batches
      const results = [];
      let done = 0;

      async function processBin(sym){
        try{
          const kl = await binanceKlines(sym);
          const calc = natrFromKlines(kl);
          if(calc && calc.natr >= 1.5){ results.push({ticker:sym, price:calc.close, natr:calc.natr, ex:'binance'}); }
        }catch(e){}
        done++; if(done % 10 === 0) statusEl.textContent = `Обработка: ${done}/${total}…`;
      }
      async function processBybit(sym){
        try{
          const r = await bybitKlines(sym);
          const kl = r?.result?.list || [];
          const calc = natrFromKlines(kl);
          if(calc && calc.natr >= 1.5){ results.push({ticker:sym, price:calc.close, natr:calc.natr, ex:'bybit'}); }
        }catch(e){}
        done++; if(done % 10 === 0) statusEl.textContent = `Обработка: ${done}/${total}…`;
      }

      // batching
      const concurrency = 5;
      async function runPool(symbols, worker){
        let i=0;
        const workers = new Array(concurrency).fill(0).map(async ()=>{
          while(i<symbols.length){
            const sym = symbols[i++];
            await worker(sym);
          }
        });
        await Promise.all(workers);
      }

      await runPool(binSymbols, processBin);
      await runPool(bybSymbols, processBybit);

      // Sort desc by natr
      results.sort((a,b)=> b.natr - a.natr);

      // Render
      tbody.innerHTML = "";
      for(const r of results){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${r.ticker}</b></td>
          <td>${Number(r.price).toFixed(6)}</td>
          <td><span class="score-chip">${r.natr.toFixed(3)}</span></td>
        `;
        tbody.appendChild(tr);
      }
      statusEl.textContent = `Найдено: ${results.length} контрактов (порог ≥ 1.5%)`;
    }catch(e){
      statusEl.textContent = 'Ошибка: ' + e;
    }
  }
})();
</script>
<!-- === NATR overlay injection end === -->

<!-- Bots panel start -->
<style>
  /* Bots popup (blue theme) */
  #bots-panel{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:9998;display:none;}
  #bots-card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1200px,94vw);max-height:88vh;overflow:hidden;
    background: linear-gradient(90deg, #0b1022 0%, #12173a 100%); border:1px solid #1b2244; border-radius:16px; color:#e5e7eb; box-shadow:0 12px 30px rgba(0,0,0,0.45);}
  #bots-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #1b2244;background:rgba(255,255,255,0.02);gap:10px;flex-wrap:wrap}
  #bots-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #bots-close{background:#1a203b;border:1px solid #26305a;color:#e7eaf1;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  #bots-body{display:flex;flex-direction:column;gap:10px;padding:12px 14px; max-height: calc(88vh - 56px);}
  #bots-table-wrap{flex:1;border:1px solid #1b2244;border-radius:12px;overflow:auto;background:#0b1022; }
  table.bots-table{width:100%; border-collapse:collapse; font-size:14px;}
  table.bots-table thead th{position:sticky;top:0;background:#101635;border-bottom:1px solid #1f2750;padding:10px;text-align:left}
  table.bots-table tbody tr:nth-child(odd){background:#0c132b}
  table.bots-table tbody td{padding:10px;border-bottom:1px solid #121938}
  .pct-up{color:#26c281;font-weight:700}
  .pct-down{color:#ff5d5d;font-weight:700}
  .arrow{font-weight:900;margin-left:6px}
</style>
<div id="bots-panel" aria-hidden="true">
  <div id="bots-card" role="dialog" aria-modal="true">
    <div id="bots-head">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0">Сигналы ботов (аномалии)</h3>
        <span style="font-size:12px;color:#9aa4b2">источники: SSE (Binance/Bybit) + резервный сканер | порог ≥ 1.5%</span>
      </div>
      <div id="bots-actions">
        <button id="bots-close">Закрыть</button>
      </div>
      <div id="bots-actions"><span id="bots-status" style="font-size:12px;color:#9aa4b2"></span></div>
    </div>
    <div id="bots-body">
      <div id="bots-table-wrap">
        <table class="bots-table" id="bots-table">
          <thead><tr><th>Тикер</th><th>Цена</th><th>%</th><th>Ожидание</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const panel = document.getElementById('bots-panel');
  const closeBtn = document.getElementById('bots-close');
  const tbody = document.querySelector('#bots-table tbody');

  function bindBotsButton(){
    // ищем кнопку по тексту "Боты" (в любых элементах верхнего тулбара)
    const nodes = Array.from(document.querySelectorAll('button, a, .tools-btn, .btn'));
    const btn = nodes.find(el => (el.textContent||'').trim().toLowerCase() === 'боты');
    if(btn){ btn.addEventListener('click', openPanel); }
  }
  function openPanel(){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); }
  function closePanel(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); }
  closeBtn.addEventListener('click', closePanel);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePanel(); });

  // helpers
  function fmtPrice(x){ const v = Number(x); return isFinite(v) ? (v<1? v.toFixed(6) : v.toFixed(4)) : String(x); }
  function fmtPct(x){ const v = Number(x); return isFinite(v) ? v.toFixed(2)+'%' : String(x); }

  function rowHtml(r){
    // r = {symbol, price, pct, dir} ; dir: 'up'|'down'
    const pctCls = (r.pct>=0) ? 'pct-up' : 'pct-down';
    const arrow = (r.dir==='up') ? '<span class="arrow" style="color:#26c281">▲</span>' : '<span class="arrow" style="color:#ff5d5d">▼</span>';
    return `<tr><td>${r.symbol}</td><td>${fmtPrice(r.price)}</td><td class="${pctCls}">${fmtPct(r.pct)}</td><td>${arrow}</td></tr>`;
  }

  function renderRows(rows){
    // filter >= 1.5% abs
    const filtered = (rows||[]).filter(r => Math.abs(Number(r.pct)||0) >= 1.5);
    // sort by abs pct desc
    filtered.sort((a,b)=> Math.abs(b.pct)-Math.abs(a.pct));
    tbody.innerHTML = filtered.map(rowHtml).join('') || `<tr><td colspan="4" style="color:#9aa4b2">Нет сигналов ≥ 1.5%</td></tr>`;
  }

  // Public API for your data layer
  window.updateBotsTable = function(rows){ try{ renderRows(rows); }catch(e){ console.error('updateBotsTable error', e); } };
  window.pushBotSignal = function(row){
    try{
      const r = {symbol: row.symbol, price: row.price, pct: row.pct, dir: row.dir};
      if(Math.abs(Number(r.pct)||0) < 1.5) return; // ignore small
      // insert keeping sort by abs pct
      const current = Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return {symbol: tds[0]?.textContent, price: parseFloat(tds[1]?.textContent), pct: parseFloat((tds[2]?.textContent||'').replace('%','')), dir: (tds[3]?.textContent||'').includes('▲')?'up':'down'};
      });
      current.push(r);
      renderRows(current);
    }catch(e){ console.error('pushBotSignal error', e); }
  };

  // initial bind
  window.addEventListener('load', bindBotsButton);
})();
</script>
<!-- Bots panel end -->

<!-- BOTS_SSE_PATCH_v1: Binance/Bybit anomalies SSE client -->
<script>
(function(){
  // Try to hook existing panel/table from your app:
  const panel = document.getElementById('bots-panel');
  const tbody = (function(){
    const t = document.querySelector('#bots-table tbody');
    if(t) return t;
    // fallback: create if missing
    const tbl = document.createElement('table');
    tbl.id = 'bots-table'; tbl.className='bots-table';
    tbl.innerHTML = '<thead><tr><th>Биржа</th><th>Тип</th><th>Тикер</th><th>Цена</th><th>%</th><th>Ожидание</th></tr></thead><tbody></tbody>';
    (panel||document.body).appendChild(tbl);
    return tbl.querySelector('tbody');
  })();

  // Button binding: text "Боты" or #btn-bots
  function bindBotsButton(){
    const byId = document.getElementById('btn-bots');
    if(byId){ byId.addEventListener('click', openPanel); return; }
    const nodes = Array.from(document.querySelectorAll('button, a, .tools-btn, .btn'));
    const btn = nodes.find(el => (el.textContent||'').trim().toLowerCase() === 'боты');
    if(btn){ btn.addEventListener('click', openPanel); }
  }
  function openPanel(){ if(panel){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); } }

  // Formatting and render
  function fmtPrice(x){ const v=Number(x); return isFinite(v)? (v<1? v.toFixed(6): v.toFixed(4)) : String(x); }
  function fmtPct(x){ const v=Number(x); return isFinite(v)? v.toFixed(2)+'%': String(x); }
  function rowHtml(r){
    const pct = Number(r.pct)||0;
    const pctCls = pct >= 0 ? 'pct-up':'pct-down';
    const arrow = (r.dir==='up') ? '<span class="arrow" style="color:#26c281">▲</span>' : '<span class="arrow" style="color:#ff5d5d">▼</span>';
    return `<tr>
      <td>${r.exchange||''}</td>
      <td>${r.type||''}</td>
      <td>${r.symbol||''}</td>
      <td>${fmtPrice(r.price)}</td>
      <td class="${pctCls}">${fmtPct(pct)}</td>
      <td>${arrow}</td>
    </tr>`;
  }

  const rows = [];
  function render(){
    const filtered = rows.filter(r => Math.abs(Number(r.pct)||0) >= 1.5);
    filtered.sort((a,b)=> Math.abs(b.pct)-Math.abs(a.pct));
    tbody.innerHTML = filtered.map(rowHtml).join('') || `<tr><td colspan="6" style="color:#9aa4b2">Нет свежих сигналов ≥ 1.5%</td></tr>`;
  }

  // Public API (keep compatibility with your app)
  window.updateBotsTable = function(newRows){ rows.length=0; if(Array.isArray(newRows)) rows.push(...newRows); render(); };
  window.pushBotSignal = function(r){ rows.push(r); if(rows.length>500) rows.shift(); render(); };

  // Status helper
  const statusEl = document.getElementById('bots-status');
  function setStatus(s){ if(statusEl) statusEl.textContent = s; }

  // SSE connection
  function startSSE(){
    try{
      const base = window.BOTS_API_BASE || ''; // set like: window.BOTS_API_BASE='http://localhost:9090';
      const es = new EventSource(base + '/api/bots/stream');
      es.onmessage = (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          rows.push(msg); if(rows.length>500) rows.shift();
          render();
        }catch(e){ console.warn('SSE parse error', e); }
      };
      es.onerror = ()=>{ es.close(); setTimeout(startSSE, 2000); };
    }catch(e){ console.warn('SSE init error', e); }
  }

  // Init
  window.addEventListener('load', bindBotsButton);
  startSSE();
})();
</script>

<script id="mobile-ribbon-js">
(function(){
  // 0) safety: if button still in DOM (because of caching) — remove
  Array.from(document.querySelectorAll('.tools-btn')).forEach(b=>{
    if ((b.textContent||'').trim() === 'Карта ликвидаций') b.remove();
  });

  const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

  function ensureMobileRibbon(){
    if (!isMobile()) return;
    let ribbon = document.getElementById('mobileRibbon');
    if (!ribbon){
      ribbon = document.createElement('div'); ribbon.id = 'mobileRibbon';
      const hostCard = document.querySelector('.card .flex.flex-col.lg\\:flex-row');
      if (hostCard) hostCard.appendChild(ribbon);
    }
    const ids = ['btn-bybit-futures','btn-binance-spot','btn-bybit-spot','btn-spreads'];
    const extrasByText = ['NATR','Боты'];

    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (el && !ribbon.contains(el)) ribbon.appendChild(el);
    });
    Array.from(document.querySelectorAll('.tools-btn')).forEach(btn=>{
      const t = (btn.textContent||'').trim();
      if (extrasByText.includes(t) && !ribbon.contains(btn)) ribbon.appendChild(btn);
    });

    const marketInfo = document.querySelector('#marketInfo');
    if (marketInfo && !ribbon.contains(marketInfo)){
      marketInfo.classList.add('pill');
      ribbon.appendChild(marketInfo);
    }

    let ws = ribbon.querySelector('.ws-pill');
    if (!ws){ ws = document.createElement('span'); ws.className = 'ws-pill'; ribbon.appendChild(ws); }
    function updateWs(){
      const ok = (window.state && state.wsConnected);
      ws.textContent = ok ? 'WS: подключено' : 'WS: нет';
      ws.style.color = ok ? '#22c55e' : '#ef4444';
    }
    updateWs();
    const origRenderStatus = window.renderStatus;
    if (!window._wsPatched && typeof origRenderStatus === 'function'){
      window.renderStatus = function(){
        try{ origRenderStatus(); }catch(_){}
        updateWs();
      };
      window._wsPatched = true;
    }
  }

  function mobileSyncSymbol(sym){
    if (!isMobile()) return;
    try{
      if (typeof window.renderTV === 'function') renderTV(sym);
      const oi = document.getElementById('oiFloat'); if (oi) oi.classList.remove('hidden');
      if (typeof window.OI_updateFloat === 'function') OI_updateFloat(sym);
      const input = document.getElementById('agentSearchInput'); if (input) input.value = sym;
      if (typeof window.agent_panel_run === 'function') window.agent_panel_run(sym);
    }catch(_){}
  }

  const origRenderScreener = window.renderScreener;
  if (typeof origRenderScreener === 'function' && !window._mobileScreenerPatched){
    window.renderScreener = async function(){
      await origRenderScreener();
      if (!isMobile()) return;
      document.querySelectorAll('#screenerList [data-sym]').forEach(n=>{
        if (!n._mobSyncBound){
          n.addEventListener('click', ()=>{
            const s = n.getAttribute('data-sym');
            if (s) mobileSyncSymbol(s);
          });
          n._mobSyncBound = true;
        }
      });
    };
    window._mobileScreenerPatched = true;
  }

  function initMobile(){
    ensureMobileRibbon();
    const sel = (window.state && state.selected) || 'BTCUSDT';
    mobileSyncSymbol(sel);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(initMobile, 0);
  } else {
    window.addEventListener('DOMContentLoaded', initMobile);
  }
  window.addEventListener('resize', ensureMobileRibbon);
})();
</script>

<script id="mobile-natr-volumes-sync">
(function(){
  const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

  // Compact NATR controls (stack) on mobile
  function compactNatr(){
    if (!isMobile()) return;
    const card = document.getElementById('natr-card');
    if (!card) return;
    // mark already processed
    if (card.dataset.mobCompact === '1') return;
    card.dataset.mobCompact = '1';
    // nothing else needed; CSS targets buttons/pills inside #natr-card
  }

  // Hook to run when NATR is opened (panel in DOM)
  const obs = new MutationObserver(()=> compactNatr());
  obs.observe(document.documentElement, {subtree:true, childList:true});

  // Volumes table: clicking a ticker syncs agent/graph/OI on mobile
  function bindVolumesClicks(){
    if (!isMobile()) return;
    const root = document.getElementById('volumesTableWrap');
    if (!root) return;
    root.querySelectorAll('tr, .rounded-xl').forEach(row=>{
      if (row.dataset.mobBound === '1') return;
      row.dataset.mobBound = '1';
      row.addEventListener('click', ()=>{
        // try to extract symbol from a ".pill" in the row, or textContent fallback
        let sym = null;
        const pill = row.querySelector('.pill');
        if (pill) sym = (pill.textContent||'').trim();
        if (!sym){
          const txt = (row.textContent||'').strip().split('\n')[0];
          const m = re = null;
        }
        if (!sym) return;
        // delegate to existing mobileSyncSymbol if present
        if (typeof window.mobileSyncSymbol === 'function'){
          window.mobileSyncSymbol(sym);
        }else{
          // minimal fallback: update agent
          const input = document.getElementById('agentSearchInput');
          if (input) input.value = sym;
          if (typeof window.agent_panel_run === 'function') window.agent_panel_run(sym);
        }
      });
    });
  }

  // Patch renderToolVolumes to rebind after render
  if (!window._volumesClickPatched && typeof window.renderToolVolumes === 'function'){
    const orig = window.renderToolVolumes;
    window.renderToolVolumes = function(){
      const r = orig.apply(this, arguments);
      try { setTimeout(bindVolumesClicks, 0); } catch(_){}
      return r;
    };
    window._volumesClickPatched = true;
  }

  // Run on load and on resize
  function init(){
    compactNatr();
    bindVolumesClicks();
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(init, 0);
  } else {
    window.addEventListener('DOMContentLoaded', init);
  }
  window.addEventListener('resize', ()=>{
    compactNatr();
    bindVolumesClicks();
  });
})();
</script>

<script id="mobile-volumes-agent-fix">
(function(){
  const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

  function extractSymbolFromNode(node){
    // Prefer text like XXXXUSDT / with -PERP hidden in UI as base symbol's pair code
    const pills = Array.from(node.querySelectorAll('.pill')).map(n=>(n.textContent||'').trim());
    let sym = pills.find(t=>/^[A-Z0-9\-]{2,}USDT$/.test(t));
    if(!sym){
      // try any candidate that contains USDT and isn't purely digits
      sym = pills.find(t=>/USDT/.test(t) && !/^\d+$/.test(t));
    }
    if(!sym){
      // fallback: scan known symbols from state.list present in text
      const txt = (node.textContent||'').toUpperCase();
      if (window.state && Array.isArray(state.list)){
        for (const s of state.list){
          if (txt.includes(s)) { sym = s; break; }
        }
      }
    }
    return sym || null;
  }

  function bindVolumesClicks(){
    const root = document.getElementById('volumesTableWrap');
    if (!root) return;
    // Rows in desktop table + cards in mobile list
    root.querySelectorAll('tr, .rounded-xl').forEach(row=>{
      if (row.dataset.mobBound2 === '1') return;
      row.dataset.mobBound2 = '1';
      row.addEventListener('click', ()=>{
        const sym = extractSymbolFromNode(row);
        if (!sym) return;
        // Always update selected
        if (window.state){ state.selected = sym; try{ renderScreener(); }catch(_){} try{ syncVolumesSelection(sym); }catch(_){} }
        // Graph
        if (typeof window.renderTV === 'function') try{ renderTV(sym); }catch(_){}
        // OI
        const oi = document.getElementById('oiFloat'); if (oi) oi.classList.remove('hidden');
        if (typeof window.OI_updateFloat === 'function') try{ OI_updateFloat(sym); }catch(_){}
        // Agent (required)
        const input = document.getElementById('agentSearchInput'); if (input) input.value = sym;
        if (typeof window.agent_panel_run === 'function') try{ window.agent_panel_run(sym); }catch(_){}
      });
    });
  }

  // Patch renderToolVolumes once
  if (!window._volumesClickPatched_v2 && typeof window.renderToolVolumes === 'function'){
    const orig = window.renderToolVolumes;
    window.renderToolVolumes = function(){
      const r = orig.apply(this, arguments);
      try { setTimeout(bindVolumesClicks, 0); } catch(_){}
      return r;
    };
    window._volumesClickPatched_v2 = true;
  }

  // Initial bind
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(bindVolumesClicks, 0);
  } else {
    window.addEventListener('DOMContentLoaded', ()=> setTimeout(bindVolumesClicks, 0));
  }
})();
</script>

<script id="mobile-agent-robust">
(function(){
  // Add one more fallback proxy for agent klines: r.jina.ai
  if (typeof window.FA_loadKlines === 'function' && !window._agentKlinesPatched){
    const orig = window.FA_loadKlines;
    window.FA_loadKlines = async function(symbol){
      try{ return await orig(symbol); }
      catch(e){
        // try r.jina.ai as last resort
        try{
          const url = `https://r.jina.ai/http://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=300`;
          const r = await fetch(url,{cache:'no-store'});
          if(!r.ok) throw new Error('jina proxy HTTP '+r.status);
          const j = await r.json();
          if(Array.isArray(j)) return { klines:j, source:'proxy:jina.ai' };
        }catch(_){}
        throw e;
      }
    };
    window._agentKlinesPatched = true;
  }

  // Graceful error: show soft message instead of red stack, keep panel visible
  if (!window._agentSoftWarn && typeof window.AGENT_run === 'function'){
    const orig = window.AGENT_run;
    window.AGENT_run = async function(sym){
      try{
        return await orig(sym);
      }catch(e){
        try{
          const p = document.getElementById('agentPanel');
          if (p){
            let warn = p.querySelector('.mob-agent-warn');
            if (!warn){
              warn = document.createElement('div');
              warn.className='mob-agent-warn';
              warn.style.cssText='color:#94a3b8;font-size:12px;margin-top:6px;';
              p.appendChild(warn);
            }
            warn.textContent = 'Нет данных по тикеру, попробуйте ещё раз или другой тикер.'; setTimeout(()=>{ if(warn && warn.parentNode) warn.remove(); }, 4000);
          }
        }catch(_){}
        throw e;
      }
    };
    window._agentSoftWarn = true;
  }
})();
</script>

<!-- Placeholder: Listings and Anomalies buttons removed for now.
     Future logic for these features will be added here. -->


<script id="selected-symbol-updater">
(function(){
  window.updateSelectedSymbol = function(sym){
    try{
      if(!sym) return;
      const candidates = Array.from(document.querySelectorAll('#agentTicker, .agent-ticker, [data-field="symbol"], .symbol, .ticker'));
      candidates.forEach(node=>{
        // Avoid clobbering complex tickers like price fields; change only when it looks like a symbol cell
        const isSymbolish = node.id==='agentTicker' || /agent-ticker/.test(node.className||'') || node.getAttribute('data-field')==='symbol' || (/\bsymbol\b/.test(node.className||''));
        if (isSymbolish){
          node.textContent = sym.toUpperCase();
          // light visual feedback
          node.classList.remove('flash-green','flash-red');
          node.classList.add('flash-green');
          setTimeout(()=> node.classList.remove('flash-green'), 400);
        }
      });
      // Also mirror into agent search input to keep it in sync
      const input = document.getElementById('agentSearchInput'); if (input) input.value = sym.toUpperCase();
    }catch(_){}
  };
})();
</script>


<script id="volumes-universal-bind">
(function(){
  function extractSymbolFromNode(node){
    if(!node) return null;
    try{
      // Look for pill-like elements first
      const pills = Array.from(node.querySelectorAll('.pill')).map(n=>(n.textContent||'').trim());
      let sym = pills.find(t=>/^[A-Z0-9\-]{2,}USDT$/.test(t));
      if(!sym){
        sym = pills.find(t=>/USDT/.test(t) && !/^\d+$/.test(t));
      }
      if(!sym){
        const txt = (node.textContent||'').toUpperCase();
        if (window.state && Array.isArray(state.list)){
          sym = state.list.find(s=> txt.includes(s));
        }
      }
      return sym || null;
    }catch(_){ return null; }
  }

  function handleVolumesClick(ev){
    const wrap = document.getElementById('volumesTableWrap');
    if(!wrap) return;
    // Find suitable row/card
    const target = ev.target;
    const row = target.closest('tr, .rounded-xl');
    if(!row || !wrap.contains(row)) return;
    const sym = extractSymbolFromNode(row);
    if(!sym) return;

    // Update app state and UI
    if (window.state){ state.selected = sym; try{ renderScreener(); }catch(_){} try{ syncVolumesSelection(sym); }catch(_){} }
    if (typeof window.updateSelectedSymbol==='function') try{ updateSelectedSymbol(sym); }catch(_){}
    if (typeof window.renderTV === 'function') try{ renderTV(sym); }catch(_){}
    const oi = document.getElementById('oiFloat'); if (oi) oi.classList.remove('hidden');
    if (typeof window.OI_updateFloat === 'function') try{ OI_updateFloat(sym); }catch(_){}
    const input = document.getElementById('agentSearchInput'); if (input) input.value = sym;
    if (typeof window.agent_panel_run === 'function') try{ window.agent_panel_run(sym); }catch(_){}
  }

  function bind(){
    const wrap = document.getElementById('volumesTableWrap');
    if(!wrap || wrap._universalBound) return;
    wrap.addEventListener('click', handleVolumesClick);
    wrap._universalBound = true;
  }

  // Patch renderToolVolumes to (re)bind after rerender
  if (!window._volumesUniversalPatched && typeof window.renderToolVolumes === 'function'){
    const orig = window.renderToolVolumes;
    window.renderToolVolumes = function(){
      const r = orig.apply(this, arguments);
      try { setTimeout(bind, 0); } catch(_){}
      return r;
    };
    window._volumesUniversalPatched = true;
  }
  // Initial bind
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(bind, 0);
  } else {
    window.addEventListener('DOMContentLoaded', ()=> setTimeout(bind, 0));
  }
})();
</script>


<script id="volumes-selection-sync">
(function(){
  function extractSymFromRow(row){
    if(!row) return null;
    const a = row.getAttribute('data-sym') || row.getAttribute('data-symbol') || row.getAttribute('data-ticker');
    if (a) return a.trim().toUpperCase();
    const pill = row.querySelector('.pill');
    if (pill) return (pill.textContent||'').trim().toUpperCase();
    const txt = (row.textContent||'').toUpperCase();
    const m = txt.match(/([A-Z0-9]{2,})USDT/);
    return m ? m[1]+'USDT' : null;
  }

  window.syncVolumesSelection = function(sym){
    try{
      const wrap = document.getElementById('volumesTableWrap');
      if(!wrap) return;
      const S = (sym || (window.state && state.selected) || '').toUpperCase();
      if(!S) return;
      wrap.querySelectorAll('tr, .rounded-xl').forEach(row=>{
        const rSym = extractSymFromRow(row);
        if (rSym === S) row.classList.add('active');
        else row.classList.remove('active');
      });
    }catch(_){}
  };

  const wrap = document.getElementById('volumesTableWrap');
  if (wrap && !wrap._selObs){
    const mo = new MutationObserver(()=>{
      try{ window.syncVolumesSelection(); }catch(_){}
    });
    mo.observe(wrap, {childList:true, subtree:true});
    wrap._selObs = mo;
  }
})();
</script>


<script id="volumes-click-delegate">
(function(){
  function onClick(ev){
    const t = ev.target;
    const n = t.closest('#volumesTableWrap [data-sym], #volumesTableWrap [data-symbol], #volumesTableWrap [data-ticker]');
    if (!n) return;
    const s = (n.getAttribute('data-sym') || n.getAttribute('data-symbol') || n.getAttribute('data-ticker') || '').trim();
    if (!s) return;
    if (window.appSelectSymbol) appSelectSymbol(s);
    try{ syncVolumesSelection(s); }catch(_){}
  }
  function bind(){
    const wrap = document.getElementById('volumesTableWrap');
    if (!wrap || wrap._clickBound) return;
    wrap.addEventListener('click', onClick, {passive:true});
    wrap._clickBound = true;
  }
  // patch renderToolVolumes to re-bind and resync after rerender
  if (!window._volumesClickDelegatePatched && typeof window.renderToolVolumes === 'function'){
    const orig = window.renderToolVolumes;
    window.renderToolVolumes = function(){
      const r = orig.apply(this, arguments);
      try{ setTimeout(()=>{ bind(); try{ syncVolumesSelection(); }catch(_){} }, 0);}catch(_){}
      return r;
    };
    window._volumesClickDelegatePatched = true;
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(()=>{ bind(); try{ syncVolumesSelection(); }catch(_){} }, 0);
  } else {
    window.addEventListener('DOMContentLoaded', ()=> setTimeout(()=>{ bind(); try{ syncVolumesSelection(); }catch(_){} }, 0));
  }
})();
</script>


  <!-- Login Modal -->
  
  <!-- Login/Register Modal with tabs -->
  <div id="loginModal" class="fixed inset-0 z-[1000] hidden">
    <div class="absolute inset-0 bg-black/70" id="loginBackdrop"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[92vw] max-w-[460px]">
      <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-xl overflow-hidden" data-mode="login">
        <div class="px-4 pt-3 pb-0 border-b border-slate-700">
          <div class="flex items-center justify-between">
            <div class="flex gap-1 bg-slate-800 p-1 rounded-lg">
              <button id="tabLogin" class="px-3 py-1.5 rounded-md text-sm font-semibold bg-purple-600 text-white">Войти</button>
              <button id="tabRegister" class="px-3 py-1.5 rounded-md text-sm font-semibold text-slate-300 hover:text-white">Зарегистрироваться</button>
            </div>
            <button id="loginCloseBtn" class="text-slate-300 hover:text-white text-xl leading-none px-2">&times;</button>
          </div>
          <div class="pt-2 pb-3">
            <h3 class="text-base font-bold" id="loginTitle">Войти</h3>
          </div>
        </div>
        <div class="p-4 space-y-3">
          <button id="loginGoogle" class="w-full btn bg-white text-black flex items-center justify-center gap-2 py-2 rounded-md">
            <span class="inline-block w-4 h-4 bg-white rounded-sm border border-slate-300"></span>
            Войти через Google
          </button>
          <button id="loginApple" class="w-full btn bg-black text-white flex items-center justify-center gap-2 py-2 rounded-md border border-slate-600">
            <span class="inline-block w-4 h-4 bg-white rounded-sm"></span>
            Войти через Apple
          </button>
          <div class="relative">
            <div class="absolute inset-0 flex items-center" aria-hidden="true">
              <div class="w-full border-t border-slate-700"></div>
            </div>
            <div class="relative flex justify-center">
              <span class="bg-slate-900 px-2 text-xs text-slate-400">или по e‑mail</span>
            </div>
          </div>
          
  <!-- Consent step for subscription -->
  <div id="registerConsent" class="card" style="margin-top:8px; display:none; background:#0b1730; border-color:#263043">
    <div style="display:flex;align-items:flex-start;gap:8px">
      <input id="consentTick" type="checkbox" style="margin-top:3px">
      <div>
        <div><b>Подписка 1 USDT/мес</b></div>
        <div style="opacity:.8;font-size:12px">Доступ ко всем функциям после оплаты. Можно отписаться в любой момент.</div>
      </div>
    </div>
    <div style="margin-top:8px;display:flex;align-items:center;gap:10px">
      <button id="consentContinue" class="btn" style="opacity:.6;pointer-events:none">Продолжить</button>
      <span style="opacity:.6;font-size:12px">я соглашаюсь с условиями</span>
    </div>
  </div>

<form id="emailLoginForm" class="space-y-2">
            <input type="email" id="emailInput" required placeholder="Ваш e‑mail" class="w-full bg-slate-800 border border-slate-700 rounded-md px-3 py-2 outline-none focus:border-purple-500" />
            <input type="password" id="passwordInput" required placeholder="Пароль" class="w-full bg-slate-800 border border-slate-700 rounded-md px-3 py-2 outline-none focus:border-purple-500" />
            <button type="submit" class="w-full btn bg-purple-600 hover:bg-purple-700 text-white rounded-md py-2" id="submitBtn">Продолжить</button>
          </form>
          <p class="text-xs text-slate-400">Нажимая «Продолжить», вы соглашаетесь с условиями сервиса и политикой конфиденциальности.</p>
        </div>
      </div>
    </div>
  </div>

  </div>


<script>
(function(){
  const container = document.querySelector('#loginModal [data-mode]') || document.querySelector('[data-mode]');
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const consent = document.getElementById('registerConsent');
  const consentTick = document.getElementById('consentTick');
  const consentContinue = document.getElementById('consentContinue');
  const emailForm = document.getElementById('emailLoginForm');
  const googleBtn = document.getElementById('loginGoogle');
  const appleBtn = document.getElementById('loginApple');

  function setDisabled(el, flag){
    if(!el) return;
    if(flag){ el.style.opacity = '.6'; el.style.pointerEvents = 'none'; }
    else { el.style.opacity = '1'; el.style.pointerEvents = 'auto'; }
  }

  function onModeChange(){
    if(!container) return;
    const mode = container.getAttribute('data-mode');
    // When switching to "register" -> show consent and disable providers/form until ticked
    if(mode === 'register'){
      if(consent) consent.style.display = 'block';
      setDisabled(emailForm, true);
      setDisabled(googleBtn, true);
      setDisabled(appleBtn, true);
    } else {
      if(consent) consent.style.display = 'none';
      setDisabled(emailForm, false);
      setDisabled(googleBtn, false);
      setDisabled(appleBtn, false);
    }
  }

  if(tabLogin) tabLogin.addEventListener('click', onModeChange);
  if(tabRegister) tabRegister.addEventListener('click', onModeChange);

  if(consentTick && consentContinue){
    consentTick.addEventListener('change', () => {
      const checked = consentTick.checked;
      setDisabled(consentContinue, !checked);
    });
    consentContinue.addEventListener('click', () => {
      // enable form and providers after user agreed
      setDisabled(emailForm, false);
      setDisabled(googleBtn, false);
      setDisabled(appleBtn, false);
      if(consent) consent.style.display = 'none';
    });
  }

  // Run once on load in case default mode is register
  onModeChange();
})();
</script>


  <!-- Subscription First-Step Popup -->
  <div id="subPopup" class="fixed inset-0" style="display:none; z-index:1100">
    <div id="subPopupBackdrop" class="fixed inset-0" style="background:rgba(0,0,0,.7)"></div>
    <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:92vw;max-width:460px">
      <div class="card" style="background:#0b1220;border-color:#263043">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #263043;padding:10px 12px">
          <h3 style="margin:0">Подписка 1 USDT / месяц</h3>
          <button id="subPopupClose" class="btn" style="background:transparent;border:1px solid #263043;color:#e0e0ff">×</button>
        </div>
        <div style="padding:12px">
          <p style="opacity:.85;margin:0 0 8px">Для регистрации требуется активная подписка. Оплата — 1 USDT в месяц. Отписаться можно в любой момент в настройках.</p>
          <div style="display:flex;align-items:flex-start;gap:8px;margin:10px 0">
            <input id="subPopupTick" type="checkbox" style="margin-top:3px">
            <div>
              <div><b>Я подтверждаю подписку 1 USDT/мес</b></div>
              <div style="opacity:.75;font-size:12px">и соглашаюсь с <a href="#" id="termsLink" style="color:#60a5fa">условиями сервиса</a> и <a href="#" id="privacyLink" style="color:#60a5fa">политикой конфиденциальности</a>.</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="subPopupContinue" class="btn" style="opacity:.6;pointer-events:none">Продолжить</button>
            <span style="opacity:.6;font-size:12px">я соглашаюсь с условиями</span>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
(function(){
  const modal = document.getElementById('loginModal');
  const container = modal ? modal.querySelector('[data-mode]') : document.querySelector('[data-mode]');
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const emailForm = document.getElementById('emailLoginForm');
  const googleBtn = document.getElementById('loginGoogle');
  const appleBtn = document.getElementById('loginApple');

  const pop = document.getElementById('subPopup');
  const popBackdrop = document.getElementById('subPopupBackdrop');
  const popClose = document.getElementById('subPopupClose');
  const popTick = document.getElementById('subPopupTick');
  const popContinue = document.getElementById('subPopupContinue');

  function setDisabled(el, flag){
    if(!el) return;
    if(flag){ el.style.opacity = '.6'; el.style.pointerEvents = 'none'; }
    else { el.style.opacity = '1'; el.style.pointerEvents = 'auto'; }
  }

  function openPopup(){
    if(pop) pop.style.display = 'block';
    // Switch to register mode if not already
    if(container){ container.setAttribute('data-mode','register'); }
    // Disable all actions until confirmed
    setDisabled(emailForm, true);
    setDisabled(googleBtn, true);
    setDisabled(appleBtn, true);
  }
  function closePopup(){
    if(pop) pop.style.display = 'none';
  }

  // Show popup when user clicks "Зарегистрироваться"
  if(tabRegister){
    tabRegister.addEventListener('click', () => {
      openPopup();
    });
  }

  // Enable Continue when ticked
  if(popTick && popContinue){
    popTick.addEventListener('change', () => {
      const ok = popTick.checked;
      setDisabled(popContinue, !ok);
    });
    popContinue.addEventListener('click', () => {
      // Consent given -> close popup and allow register actions
      closePopup();
      setDisabled(emailForm, false);
      setDisabled(googleBtn, false);
      setDisabled(appleBtn, false);
      // Optionally reveal paywall preview
      const paywall = document.getElementById('paywall');
      if(paywall) paywall.classList.remove('hidden');
    });
  }

  if(popBackdrop) popBackdrop.addEventListener('click', closePopup);
  if(popClose) popClose.addEventListener('click', closePopup);
})();
</script>


<!-- AUTH FLOW with OUTLINE TABS -->
<style>
  #crtAuthBack{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:none;z-index:99998}
  #crtAuth{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(560px,92vw);
    background:linear-gradient(180deg,#0f172a,#0b1327);border:1px solid #23314d;border-radius:16px;display:none;z-index:99999;
    box-shadow:0 30px 80px rgba(0,0,0,.6);overflow:hidden;color:#e8ecf6;font-family:Inter,system-ui}
  #crtAuth header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #23314d}
  #crtAuth .x{background:#111a34;border:1px solid #23314d;color:#e8ecf6;border-radius:10px;padding:0 10px;height:32px;cursor:pointer}
  #crtAuth .tabs{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid #23314d;background:rgba(0,0,0,.12)}
  #crtAuth .tab{padding:8px 12px;border-radius:10px;border:1.5px solid #7c3aed;background:transparent;cursor:pointer;font-weight:700;color:#cfe0ff}
  #crtAuth .tab.active{background:rgba(124,58,237,0.12);box-shadow:0 0 6px rgba(124,58,237,0.35);border-color:#7c3aed}
  #crtAuth .content{padding:14px}
  #crtAuth .row{display:flex;gap:10px;align-items:center}
  #crtAuth .btn{appearance:none;background:linear-gradient(180deg,#7c3aed,#6d28d9);border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  #crtAuth .btn.secondary{background:#122144;color:#cfe0ff;border:1px solid #23314d}
  #crtAuth .btn.tiny{padding:8px 10px;border-radius:10px}
  #crtAuth .btn[disabled]{opacity:.55;cursor:not-allowed}
  #crtAuth .input{width:100%;padding:12px;border-radius:12px;border:1px solid #23314d;background:#0a142e;color:#e6ebff}
  #crtAuth .section{background:linear-gradient(180deg,#0f1830,#0b1327);border:1px solid #23314d;border-radius:14px;padding:14px}
  #crtAuth .chip{padding:5px 10px;border-radius:999px;background:#17213d;border:1px solid #23314d;display:inline-flex;gap:6px;align-items:center}
  #crtAuth code{background:#0a1228;border:1px solid #23314d;padding:6px 8px;border-radius:10px}
  #crtAuth canvas{display:block;border:1px solid #23314d;border-radius:12px}
  #crtAuth .note{margin-top:8px;padding:8px 10px;border:1px dashed #7c3aed;border-radius:10px;background:#0c1430;color:#d7cafc;font-size:12px}
  #crtAuth .label{font-size:13px;color:#cbd6ee;margin-bottom:6px}
  #crtAuth a{color:#b3c7ff;text-decoration:underline;text-underline-offset:2px}
  #crtAuth label.check{display:flex;gap:10px;align-items:flex-start}
  #crtAuth label.check input{position:relative;top:3px}
</style>

<div id="crtAuthBack"></div>
<div id="crtAuth" role="dialog" aria-modal="true">
  <header><div style="font-weight:800">Авторизация</div><button id="crtClose" class="x">×</button></header>
  <div class="tabs">
    <div id="crtTabLogin" class="tab">Войти</div>
    <div id="crtTabRegister" class="tab active">Зарегистрироваться</div>
  </div>

  <div class="content" data-mode="register">
    <div id="crtLogin" class="section" style="display:none">
      <h3 style="margin:0 0 10px 0">Войти</h3>
      <div class="row" style="flex-wrap:wrap;margin-bottom:10px">
        <button class="btn secondary">Войти через Google</button>
        <button class="btn secondary">Войти через Apple</button>
      </div>
      <div class="label">или по e‑mail</div>
      <input class="input" placeholder="Ваш e‑mail">
      <div style="height:8px"></div>
      <input class="input" placeholder="Пароль" type="password">
      <div style="height:10px"></div>
      <button class="btn" style="width:100%">Продолжить</button>
      <div id="crtLoginNote" class="note" style="display:none">Вход только для зарегистрированных. Перейдите на «Зарегистрироваться».</div>
    </div>

    <!-- Шаг 1 — подписка + 3 чекбокса с ссылками -->
    <div id="crtReg1" class="section">
      <h3 style="margin:0 0 10px 0">Подписка 1 USDT / месяц</h3>
      <div class="label">Для регистрации нужна активная подписка. Оплата — 1 USDT/мес. Отписка в любой момент.</div>
      <label class="check" style="margin-top:8px">
        <input id="crtC1" type="checkbox">
        <div><b>Я подтверждаю подписку 1 USDT/мес</b><br><span class="label">и соглашаюсь с <a href="#" target="_blank">условиями сервиса</a> и <a href="#" target="_blank">политикой конфиденциальности</a>.</span></div>
      </label>
      <label class="check" style="margin-top:8px"><input id="crtC2" type="checkbox"> <div>Мне 18+ лет</div></label>
      <label class="check" style="margin-top:8px"><input id="crtC3" type="checkbox"> <div>Моя юрисдикция допускает использование сервиса</div></label>
      <div style="height:10px"></div>
      <button id="crtToPay" class="btn" disabled style="background:transparent;border:1.5px solid #7c3aed;color:#cfe0ff">Продолжить</button>
    </div>

    <!-- Шаг 2 — оплата -->
    <div id="crtReg2" class="section" style="display:none">
      <h3 style="margin:0 0 10px 0">Оплата подписки 1 USDT / месяц</h3>
      <div class="row" style="gap:10px;flex-wrap:wrap;margin-bottom:8px">
        <button id="crtNetBSC" class="btn tiny secondary">BSC (BEP20)</button>
      </div>
      <div class="section" style="background:#0c162e">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <span class="btn tiny secondary" style="pointer-events:none">Сеть: <b id="crtNetLabel">BSC</b></span>
          <span class="btn tiny secondary" style="pointer-events:none">Сумма: <b>1 USDT</b></span>
        </div>
        <div style="height:10px"></div>
        <div class="label">Адрес кошелька</div>
        <div class="row" style="flex-wrap:wrap">
          <code id="crtAddrText">TVDEMOUSDTBSCADDR9jH8aA1ZPpQkQX7</code>
          <button id="crtCopy" class="btn tiny" style="background:#2563eb">Скопировать</button>
        </div>
        <canvas id="crtQR" width="210" height="210" style="margin-top:12px;background:#0a0f22"></canvas>
        <div style="height:10px"></div>
        <input id="crtTx" class="input" placeholder="TxID / Hash">
        <div style="height:10px"></div>
        <button id="crtPaid" class="btn" style="background:transparent;border:1.5px solid #7c3aed;color:#cfe0ff">Я оплатил(а)</button>
      </div>
    </div>

    <!-- Шаг 3 — регистрация -->
    <div id="crtReg3" class="section" style="display:none">
      <h3 style="margin:0 0 10px 0">Регистрация</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn secondary">Зарегистрироваться через Google</button>
        <button class="btn secondary">Зарегистрироваться через Apple</button>
      </div>
      <div class="label">или по e‑mail</div>
      <input id="crtEmail" class="input" placeholder="Ваш e‑mail">
      <div style="height:8px"></div>
      <input id="crtPass" class="input" placeholder="Пароль" type="password">
      <div style="height:10px"></div>
      <button id="crtFinish" class="btn" style="width:100%">Завершить регистрацию</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const back=$('#crtAuthBack'), modal=$('#crtAuth');
  const tabL=$('#crtTabLogin'), tabR=$('#crtTabRegister');
  const login=$('#crtLogin'), reg1=$('#crtReg1'), reg2=$('#crtReg2'), reg3=$('#crtReg3');
  const paidKey='crt_sub_active', regKey='crt_user_registered';
  const isPaid=()=>localStorage.getItem(paidKey)==='1'; const isReg=()=>localStorage.getItem(regKey)==='1';
  const setPaid=v=>localStorage.setItem(paidKey, v?'1':'0'); const setReg=v=>localStorage.setItem(regKey, v?'1':'0');

  function setMode(m){
    modal.querySelector('.content').dataset.mode=m;
    tabL.classList.toggle('active', m==='login'); tabR.classList.toggle('active', m==='register');
    if(m==='login'){ login.style.display=''; reg1.style.display=reg2.style.display=reg3.style.display='none'; $('#crtLoginNote').style.display=isReg()?'none':''; }
    else { login.style.display='none'; if(!isPaid()){ reg1.style.display=''; reg2.style.display='none'; reg3.style.display='none'; } else if(!isReg()){ reg1.style.display='none'; reg2.style.display='none'; reg3.style.display=''; } else setMode('login'); }
    tabL.classList.toggle('disabled', !isReg());
  }
  function open(){ back.style.display='block'; modal.style.display='block'; setMode(isReg()?'login':'register'); }
  function close(){ back.style.display='none'; modal.style.display='none'; }
  document.getElementById('crtClose')?.addEventListener('click', close); back?.addEventListener('click', close);

  // bind top "ВХОД"
  let headerBtn = document.querySelector('#togglePricesBtn, .header .btn-login, .topbar .btn-login, #headerLogin');
  if(!headerBtn){ headerBtn = Array.from(document.querySelectorAll('button,a,div')).find(el => (el.textContent||'').trim()==='ВХОД'); }
  headerBtn?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); open(); }, {capture:true});

  tabL?.addEventListener('click', ()=> setMode(isReg()?'login':'register'));
  tabR?.addEventListener('click', ()=> setMode('register'));

  // consent
  const c1=$('#crtC1'), c2=$('#crtC2'), c3=$('#crtC3'), toPay=$('#crtToPay');
  function refresh(){ const ok=c1.checked && c2.checked && c3.checked; toPay.disabled=!ok; toPay.style.opacity = ok ? '1' : '.6'; }
  [c1,c2,c3].forEach(el=>el?.addEventListener('change', refresh)); refresh();
  toPay?.addEventListener('click', ()=>{ if(toPay.disabled) return; reg1.style.display='none'; reg2.style.display=''; });

  // payment
  const netTRC = null;const ADDR = { BSC: '0xBSCUSDTADDRESS9F5a25a1' };
  function drawQR(text){ const c=qr.getContext('2d'); c.clearRect(0,0,qr.width,qr.height); c.fillStyle='#0b1327'; c.fillRect(0,0,qr.width,qr.height);
    c.fillStyle='#e5e7eb'; let h=0; for(let i=0;i<text.length;i++){ h=((h<<5)-h)+text.charCodeAt(i); h|=0; } const cell=12,pad=16,nx=Math.floor((qr.width-2*pad)/cell),ny=Math.floor((qr.height-2*pad)/cell);
    for(let y=0;y<ny;y++)for(let x=0;x<nx;x++){ const b=(h^(x*31+y*17+(x*y)))&1; if(b) c.fillRect(pad+x*cell+2,pad+y*cell+2,cell-4,cell-4); }
    c.fillStyle='#7c3aed'; c.fillRect(12,12,36,36); c.fillRect(qr.width-48,12,36,36); c.fillRect(12,qr.height-48,36,36); }
  function setNet(n){ netLabel.textContent=n; addr.textContent=ADDR[n]; drawQR(ADDR[n]);  netBSC.classList.toggle('secondary', n!=='BSC'); }
  setNet('BSC');  netBSC?.addEventListener('click',()=>setNet('BSC'));
  copy?.addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(addr.textContent); copy.textContent='Скопировано'; setTimeout(()=>copy.textContent='Скопировать',1200);}catch{ alert('Скопируйте адрес вручную'); } });
  paid?.addEventListener('click', ()=>{ if(!tx.value.trim()){ alert('Укажите TxID'); return; } setPaid(true); setMode('register'); });

  // finish
  document.getElementById('crtFinish')?.addEventListener('click', ()=>{
    if(!document.getElementById('crtEmail').value.trim() || !document.getElementById('crtPass').value.trim()){ alert('Введите e‑mail и пароль'); return; }
    setReg(true); setMode('login'); alert('Регистрация завершена.'); });
})();
</script>


<style>
#crtAuth .btn,
#crtAuth .tab,
#crtAuth .pill {
  color: #ffffff !important;
  background: transparent !important;
  border: 1px solid #6d28d9 !important;
  font-weight: 600 !important;
  text-shadow: none !important;
  -webkit-font-smoothing: none !important;
  -moz-osx-font-smoothing: auto !important;
  text-rendering: geometricPrecision !important;
}

#crtAuth .btn.active,
#crtAuth .tab.active,
#crtAuth .pill.active {
  background: #6d28d9 !important;
  color: #fff !important;
}

#crtAuth .btn:hover,
#crtAuth .tab:hover,
#crtAuth .pill:hover {
  border-color: #9a64ff !important;
  background: rgba(155,100,255,0.1) !important;
  color: #fff !important;
  cursor: pointer;
}
</style>


<!-- Strict 5-minute registration gate (non-dismissible) -->
<style>
#trialGateBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:99998}
#trialGate{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(780px,94vw);
  background:linear-gradient(180deg,#0f172a,#0b1327);border:1px solid #23314d;border-radius:16px;
  z-index:99999;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.6);color:#e8ecf6;font-family:Inter,system-ui}
#trialGate header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #23314d}
#trialGate .content{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:16px}
#trialGate .col{background:linear-gradient(180deg,#101a33,#0c142b);border:1px solid #23314d;border-radius:14px;padding:14px}
#trialGate h3{margin:0 0 10px 0}
#trialGate .muted{color:#9fb0c9;font-size:13px}
#trialGate .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
#trialGate .btn{appearance:none;cursor:pointer;font-weight:700;border-radius:12px;padding:10px 14px;transition:.15s;color:#fff;
  background:transparent;border:1.5px solid #7c3aed}
#trialGate .btn:hover{box-shadow:0 0 0 2px rgba(124,58,237,.25)}
#trialGate input{width:100%;padding:12px;border-radius:12px;border:1px solid #23314d;background:#0a142e;color:#e6ebff}
#trialGate .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:10px;background:#111a34;border:1px solid #23314d;color:#cfe0ff}
#trialGate code{background:#0a1228;border:1px solid #23314d;padding:6px 8px;border-radius:10px;color:#e6ebff}
#trialGate canvas{display:block;border:1px solid #23314d;border-radius:12px}
#trialGate .title{font-weight:800;font-size:18px;margin:0 0 6px 0}
/* Hide any close/later affordances if present */
#trialGate .x, #trialLater { display:none !important; }
</style>
<div id="trialGateBackdrop"></div>
<div id="trialGate" role="dialog" aria-modal="true">
  <header><div class="title">ПРОЙТИ РЕГИСТРАЦИЮ</div><button class="x">×</button></header>
  <div class="content">
    <!-- COL A: Payment (BSC, 5 USDT) -->
    <div class="col" id="gatePay">
      <h3>Оплата подписки 5 USDT / месяц</h3>
      <div class="row">
        <span class="pill">Сеть: <b style="margin-left:6px">BSC (BEP20)</b></span>
        <span class="pill">Сумма: <b>5 USDT</b></span>
      </div>
      <div class="muted" style="margin-top:8px">Адрес кошелька для оплаты</div>
      <div class="row" style="margin-top:6px">
        <code id="gateAddr">0xBSCUSDTADDRESS9F5a25a1</code>
        <button id="gateCopy" class="btn">Скопировать</button>
      </div>
      <canvas id="gateQR" width="200" height="200" style="margin-top:10px;background:#0a0f22"></canvas>
      <input id="gateTx" placeholder="TxID / Hash" style="margin-top:10px">
      <button id="gatePaid" class="btn" style="margin-top:10px">Я оплатил(а)</button>
      <div class="muted" style="margin-top:8px">После подтверждения платежа форма регистрации справа станет активной.</div>
    </div>

    <!-- COL B: Registration -->
    <div class="col" id="gateReg">
      <h3>Регистрация аккаунта</h3>
      <div class="row" style="margin-bottom:8px">
        <button class="btn" id="gateGoogle">Зарегистрироваться через Google</button>
        <button class="btn" id="gateApple">Зарегистрироваться через Apple</button>
      </div>
      <input id="gateEmail" placeholder="Ваш e‑mail" disabled>
      <div style="height:8px"></div>
      <input id="gatePass" placeholder="Пароль" type="password" disabled>
      <div style="height:10px"></div>
      <button id="gateFinish" class="btn" style="width:100%" disabled>Завершить регистрацию</button>
      <div class="muted" style="margin-top:8px">Нажимая «Завершить регистрацию», вы соглашаетесь с <a href="#" style="color:#b3c7ff">условиями сервиса</a> и <a href="#" style="color:#b3c7ff">политикой конфиденциальности</a>.</div>
    </div>
  </div>
</div>
<script>
(function(){
  // Strict 5-minute timer from tab open
  const MINUTES = 5;
  const START_KEY = 'crt_trial_session_start'; // per-tab
  const PAID = 'crt_sub_active';
  const REG  = 'crt_user_registered';

  // Start timestamp (per tab session)
  let start = Number(sessionStorage.getItem(START_KEY));
  if (!Number.isFinite(start) || start <= 0) {
    start = Date.now();
    sessionStorage.setItem(START_KEY, String(start));
  }
  const fireAt = start + MINUTES * 60 * 1000;

  const back = document.getElementById('trialGateBackdrop');
  const gate = document.getElementById('trialGate');

  function isPaid(){ return localStorage.getItem(PAID) === '1'; }
  function isReg(){ return localStorage.getItem(REG) === '1'; }

  // Show/hide helpers
  function showGate(){
    if (isPaid() && isReg()) return;
    document.documentElement.classList.add('trial-locked');
    document.body.classList.add('trial-locked', 'trial-show'); // CSS controls visibility
    ensureQR();
  }
  function maybeClose(){
    if (isPaid() && isReg()){
      document.body.classList.remove('trial-show');
      document.documentElement.classList.remove('trial-locked');
      document.body.classList.remove('trial-locked');
    }
  }

  // Exact timer + watchdog
  const ms = Math.max(0, fireAt - Date.now());
  if (ms === 0) showGate(); else setTimeout(showGate, ms);
  const watchdog = setInterval(()=>{
    if (isPaid() && isReg()){ maybeClose(); clearInterval(watchdog); return; }
    if (Date.now() >= fireAt) showGate();
  }, 4000);

  // Prevent closing by Esc / backdrop
  document.addEventListener('keydown',(e)=>{
    if ((e.key==='Escape'||e.key==='Esc') && !(isPaid()&&isReg())){ e.preventDefault(); e.stopPropagation(); }
  }, true);
  if (back){
    back.onclick=(e)=>{ if (!(isPaid()&&isReg())){ e.preventDefault(); e.stopPropagation(); } };
  }

  // Payment + Registration (demo logic, replace with real backend verification)
  const addr = document.getElementById('gateAddr');
  const copy = document.getElementById('gateCopy');
  const tx   = document.getElementById('gateTx');
  const paid = document.getElementById('gatePaid');
  const email= document.getElementById('gateEmail');
  const pass = document.getElementById('gatePass');
  const finish=document.getElementById('gateFinish');

  copy && copy.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText((addr||{}).textContent||''); copy.textContent='Скопировано'; setTimeout(()=>copy.textContent='Скопировать',1200);}catch{}
  });

  function enableReg(){ if(email) email.disabled=false; if(pass) pass.disabled=false; if(finish) finish.disabled=false; }
  paid && paid.addEventListener('click', ()=>{
    if (!tx.value.trim()){ alert('Укажите TxID'); return; }
    localStorage.setItem(PAID,'1'); // In production: verify server-side
    enableReg();
  });
  finish && finish.addEventListener('click', ()=>{
    if (!email.value.trim() || !pass.value.trim()){ alert('Введите e‑mail и пароль'); return; }
    localStorage.setItem(REG,'1');
    maybeClose();
    alert('Регистрация завершена. Вход разблокирован.');
  });

  // Pseudo-QR
  function ensureQR(){
    const qrEl = document.getElementById('gateQR');
    if (qrEl && !qrEl.__inited) {
      drawQR(qrEl, (addr||{}).textContent || '');
      qrEl.__inited = true;
    }
  }
  function drawQR(canvas, text){
    const c=canvas.getContext('2d'); const W=canvas.width, H=canvas.height;
    c.clearRect(0,0,W,H); c.fillStyle='#0b1327'; c.fillRect(0,0,W,H);
    c.fillStyle='#e5e7eb'; let h=0; for(let i=0;i<text.length;i++){ h=((h<<5)-h)+text.charCodeAt(i); h|=0; }
    const cell=12,pad=16,nx=Math.floor((W-2*pad)/cell),ny=Math.floor((H-2*pad)/cell);
    for(let y=0;y<ny;y++) for(let x=0;x<nx;x++){ const b=(h^(x*31+y*17+(x*y)))&1; if(b) c.fillRect(pad+x*cell+2,pad+y*cell+2,cell-4,cell-4); }
    c.fillStyle='#7c3aed'; c.fillRect(12,12,36,36); c.fillRect(W-48,12,36,36); c.fillRect(12,H-48,36,36);
  }
})();
</script>

</body>
</html>

<script>
(function(){
  const modal = document.getElementById('loginModal');
  const container = modal ? modal.querySelector('[data-mode]') : null;
  const openBtn = document.getElementById('togglePricesBtn');
  const closeBtn = document.getElementById('loginCloseBtn');
  const backdrop = document.getElementById('loginBackdrop');
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const title = document.getElementById('loginTitle');
  const submitBtn = document.getElementById('submitBtn');
  const g = document.getElementById('loginGoogle');
  const a = document.getElementById('loginApple');
  const form = document.getElementById('emailLoginForm');

  function openModal(mode='login'){
    if(!modal || !container) return;
    container.setAttribute('data-mode', mode);
    modal.classList.remove('hidden');
    setMode(mode);
  }
  function closeModal(){ if(modal) modal.classList.add('hidden'); }
  function setMode(mode){
    if(!container) return;
    container.setAttribute('data-mode', mode);
    if(mode === 'login'){
      tabLogin.classList.add('bg-purple-600','text-white');
      tabRegister.classList.remove('bg-purple-600','text-white');
      tabRegister.classList.add('text-slate-300');
      title.textContent = 'Войти';
      // Keep identical menu content as requested
      g.textContent = 'Войти через Google';
      a.textContent = 'Войти через Apple';
      submitBtn.textContent = 'Продолжить';
    } else {
      tabRegister.classList.add('bg-purple-600','text-white');
      tabLogin.classList.remove('bg-purple-600','text-white');
      tabLogin.classList.add('text-slate-300');
      title.textContent = 'Зарегистрироваться';
      // Keep identical menu (не меняем поля), только тексты кнопок провайдеров — "Зарегистрироваться через ..."
      g.textContent = 'Зарегистрироваться через Google';
      a.textContent = 'Зарегистрироваться через Apple';
      submitBtn.textContent = 'Продолжить';
    }
  }

  if(openBtn) openBtn.addEventListener('click', () => openModal('login'));
  if(closeBtn) closeBtn.addEventListener('click', closeModal);
  if(backdrop) backdrop.addEventListener('click', closeModal);
  if(tabLogin) tabLogin.addEventListener('click', () => setMode('login'));
  if(tabRegister) tabRegister.addEventListener('click', () => setMode('register'));

  if(form){
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const mode = container ? container.getAttribute('data-mode') : 'login';
      const email = (document.getElementById('emailInput')||{}).value || '';
      if(window.toast){
        toast.success((mode==='login' ? 'Вход (демо): ' : 'Регистрация (демо): ') + email);
      } else {
        alert((mode==='login' ? 'Вход (демо): ' : 'Регистрация (демо): ') + email);
      }
      closeModal();
    });
  }

  if(g) g.addEventListener('click', () => {
    const mode = container ? container.getAttribute('data-mode') : 'login';
    alert((mode==='login' ? 'Google OAuth — вход (демо)' : 'Google OAuth — регистрация (демо)'));
    closeModal();
  });
  if(a) a.addEventListener('click', () => {
    const mode = container ? container.getAttribute('data-mode') : 'login';
    alert((mode==='login' ? 'Apple Sign‑in — вход (демо)' : 'Apple Sign‑in — регистрация (демо)'));
    closeModal();
  });
})();
</script>

